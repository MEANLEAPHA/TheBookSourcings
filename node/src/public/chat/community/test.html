<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheBookSourcing</title>
    <script src="https://kit.fontawesome.com/ec7a51a641.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/ec7a51a641.js" crossorigin="anonymous"></script>
    <link rel="icon" href="assets/img/ThebooksorucingsIcon-removebg-preview.png">
    <link rel="stylesheet" href="../../assets/css/community.css">
</head>
<body >
  <header id="header">
    <div id="headerLeft"> 
        <i class="fa-solid fa-bars"></i>
        <a href="#top"><img src="../../assets/img/TheBookSourcingLogo-removebg-preview.png" alt="RentWell-Logo" id="logo"></a>
    </div>
    <div id="headerMiddle">
        <input type="text" placeholder="Search TheBookSourcing" id="searchTBS">
        <i class="fa-solid fa-magnifying-glass" id="searchIcon"></i>
    </div>
    <div id="headerRight">
        <i class="fa-solid fa-magnifying-glass" id="searchIcons"></i>
        <div id="create">
          <a style="display: flex;align-items: center; gap: 10px;" id="searchButton">
            <i class="fa-solid fa-plus"></i>
            <div> <p>Post</p></div>
          </a>
        </div>
        <i class="fa-regular fa-bell"></i>
        <img src="../../assets/img/pf.jpg" class="userPf" alt="user" class="dropdown-item" style='color: rgb(60, 60, 60);font-family: "Reenie Beanie", cursive;font-weight: 599;font-size: large;' id="liveToastBtn">
    </div>
  </header>   
  <div id="phoneSearch">
    <div id="phoneSearchLeft"><i class="fa-solid fa-arrow-left"></i></div>
    <div id="headerMiddle2">
            <input type="text" placeholder="Search" id="searchTBS">
            <i class="fa-solid fa-magnifying-glass" id="searchIcon"></i>
    </div>
  </div>
  <main>   
    <div class="smallCollape">
      <ul>
          <li><i class="fa-solid fa-house"></i>Home</li>
          <li><i class="fa-solid fa-users"></i>Community</li>
          <li><i class="fa-solid fa-newspaper"></i>Blog&News</li>
          <li><i class="fa-solid fa-circle-user"></i>You</li>
      </ul>
    </div>
    <div class="collapse">
      <ul id="u1">    
        <li><i class="fa-solid fa-house"></i>Home</li>
        <li><i class="fa-solid fa-users"></i>Community</li>
        <li><i class="fa-solid fa-newspaper"></i>Blog&News</li>
      </ul>
      <ul id="u2">    
        <li class="liTop"><Big>You > </Big></li>
        <li><i class="fa-solid fa-clock-rotate-left"></i>History</li>
        <li><i class="fa-solid fa-lines-leaning"></i>Your Library</li>
        <li><i class="fa-solid fa-book"></i> Your Books</li>
        <li><i class="fa-solid fa-bookmark"></i>Read Later</li>
        <li><i class="fa-solid fa-thumbs-up"></i>Liked Books</li>
      </ul>
      <ul id="u3">    
        <li class="liTop"><Big>Following</Big></li>
      </ul>
      <div class="following">
        <div class="followingChild"><img src="https://bootdey.com/img/Content/avatar/avatar4.png" class="followingPf"><p class="followingName">Golden Ramsy</p></div>
        <div class="followingChild"><img src="https://bootdey.com/img/Content/avatar/avatar2.png" class="followingPf"><p class="followingName">Morgen Housel</p></div>
        <div class="followingChild"><img src="https://bootdey.com/img/Content/avatar/avatar5.png" class="followingPf"><p class="followingName">Yuval Noah Harari</p></div>
        <div class="followingChild"><img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="followingPf"><p class="followingName">Meanleap Ha</p></div>
        <div class="followingChild"><img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="followingPf"><p class="followingName">Yuval Noah Harari</p></div>
        <li id="allFollowing"><i class="fa-solid fa-list"></i>All Following</li>
        <li id="showMoreFollow"> <i class="fa-solid fa-chevron-down"></i>Show More</li>
        <li id="showLessFollow"> <i class="fa-solid fa-chevron-up"></i>Show Less</li>
      </div>
      <ul id="u4">    
        <li class="liTop"><Big>Explore</Big></li>
        <li><i class="fa-solid fa-masks-theater"></i>Novel</li>
        <li><i class="fa-solid fa-mask"></i>Comic Book</li>
        <li><i class="fa-solid fa-user-ninja"></i>Manga</li>
        <li><i class="fa-solid fa-lightbulb"></i>Literature</li>
        <li><i class="fa-solid fa-feather-pointed"></i>Poetry</li>
      </ul>
      <ul id="u5">    
        <li><i class="fa-solid fa-gear"></i>Settings</li>
        <li><i class="fa-solid fa-flag"></i>Report</li>
        <li><i class="fa-solid fa-circle-question"></i>Help</li>
        <li  class="feedBackBtn2"><i class="fa-solid fa-comment-dots"></i>Send Feedback</li>
      </ul>
      <ul id="uLast">
        <li>About</li>
        <li>Contact</li>
        <li>Advertise</li>
        <li>Terms</li>
        <li>Privacy</li>
        <li>Policy</li>
      </ul>
      <ul id="uLast2">
        <li>
            Â© 2025 TheBookSourcing. All rights reserved
        </li>
      </ul>
    </div>
    <div class="content">
        <div id="comLeft">
            <!-- <div style="display: flex; width: 90%;justify-content: center;gap: 1px;margin:auto">
  <img src="../../assets/img/pf.jpg" style="width: 50px;height: 50px;border-radius: 50%;object-fit: cover;">
<button id="searchButton">Share your thought, Meanleap Ha? </button>
</div> -->
<div id="PostToastWrapper">
  <div id="PostToast" class="toast align-items-center text-bg-light border-0 toastOfPost" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <img src="../../assets/img/pf.jpg" class="userPfFrom">
      <p class="usernameFrom"></p> <span id="displayFeeling"></span>
    </div>
    <form id="form">
      <div class="toast-body">
        <textarea id="message-input" class="form-control mb-2" placeholder="Share your thought"></textarea>
        <div id="media-preview" class="mt-2"></div>
        <div>
          <label for="mediaInput" style="cursor: pointer">
                <i class="fa-solid fa-photo-film fa-lg" style="color: green;"></i> Photo/Video
          </label>
          <label for="feelingGrid" id="feelingLabel" style="cursor:pointer;">
                <i class="fa-solid fa-face-smile" style="color:gold; font-size: 1.5rem;"></i> Feeling
          </label>
        </div>
           <select id="feelingValue" hidden>
            <option value="" disabled selected>Select a feeling</option>
            <option value="happy">ğŸ˜Š happy</option>
            <option value="sad">ğŸ˜¢ sad</option>
            <option value="angry">ğŸ˜¡ angry</option>
            <option value="blissful">ğŸ˜‡ blissful</option>
            <option value="in love">ğŸ˜ in love</option>
            <option value="silly">ğŸ˜œ silly</option>
            <option value="cool">ğŸ˜ cool</option>
            <option value="relaxed">ğŸ˜Œ relaxed</option>
            <option value="sleepy">ğŸ˜´ sleepy</option>
            <option value="sick">ğŸ¤’ sick</option>
            <option value="loved">ğŸ¤— loved</option>
            <option value="shocked">ğŸ˜± shocked</option>
            <option value="disappointed">ğŸ˜ disappointed</option>
            <option value="frustrated">ğŸ˜¤ frustrated</option>
            <option value="excited">ğŸ¤© excited</option>
            <option value="festive">ğŸ¥³ festive</option>
            <option value="down">ğŸ˜” down</option>
            <option value="confused">ğŸ˜• confused</option>
            <option value="nervous">ğŸ˜¬ nervous</option>
            <option value="blessed">ğŸ˜‡ blessed</option>
            <option value="thankful">ğŸ™ thankful</option>
            <option value="amused">ğŸ˜… amused</option>
            <option value="curious">ğŸ¤“ curious</option>
            <option value="overwhelmed">ğŸ˜© overwhelmed</option>
            <option value="fantastic">ğŸ˜† fantastic</option>
            <option value="meh">ğŸ˜¶ meh</option>
            <option value="heartbroken">ğŸ˜¢ heartbroken</option>
            <option value="determined">ğŸ˜¤ determined</option>
            <option value="inspired">ğŸ˜‡ inspired</option>
            <option value="crazy">ğŸ˜µâ€ğŸ’« crazy</option>
            <option value="ok">ğŸ˜ OK</option>
            <option value="proud">ğŸ˜ƒ proud</option>
            <option value="satisfied">ğŸ˜‹ satisfied</option>
            <option value="embarrassed">ğŸ˜³ embarrassed</option>
            <option value="thoughtful">ğŸ¤” thoughtful</option>
            <option value="lovely">ğŸ˜ lovely</option>
            <option value="miserable">ğŸ˜– miserable</option>
            <option value="grateful">ğŸ˜‡ grateful</option>
          </select>
          <input type="file" id="mediaInput" accept="image/*,video/*" multiple hidden>
        <div class="d-flex justify-content-end">
          <button id="cancelPostBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
          <button id="submitPostBtn" type="submit" class="btn btn-sm btn-success">Post</button>
        </div>
      </div>
    </form>
  </div>
</div>
<br>
            <div id="message-container"></div>
        </div>
        <div id="comRight"> 
          <div id="sticky">
            <p>Suggested for you</p>
            <div id="followView">
                <div class="Suggested-people">
                    <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="Suggested-people-img">
                    <div class="Suggested-people-name-div">
                        <p class="Suggested-people-name">Jonh Pork</p>
                        <span class="Suggested-people-foolowing">Follwing by 1.7k people</span>
                    </div>
                    <button class="Suggested-people-button">Follow</button>
                </div>
                <div class="Suggested-people">
                    <img src="https://bootdey.com/img/Content/avatar/avatar2.png" class="Suggested-people-img">
                    <div class="Suggested-people-name-div">
                        <p class="Suggested-people-name">Jon Snow</p>
                        <span class="Suggested-people-foolowing">Follwing by 687 people</span>
                    </div>
                    <button class="Suggested-people-button">Follow</button>
                </div>
                <div class="Suggested-people">
                    <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="Suggested-people-img">
                    <div class="Suggested-people-name-div">
                        <p class="Suggested-people-name">Henrey Morgen</p>
                        <span class="Suggested-people-foolowing">Follwing by 586 people</span>
                    </div>
                    <button class="Suggested-people-button">Follow</button>
                </div>
                <div class="Suggested-people">
                    <img src="https://bootdey.com/img/Content/avatar/avatar4.png" class="Suggested-people-img">
                    <div class="Suggested-people-name-div">
                        <p class="Suggested-people-name">Tonny Robin</p>
                        <span class="Suggested-people-foolowing">Follwing by 98 people</span>
                    </div>
                    <button class="Suggested-people-button">Follow</button>
                </div>
                <div class="Suggested-people">
                    <img src="https://bootdey.com/img/Content/avatar/avatar5.png" class="Suggested-people-img">
                    <div class="Suggested-people-name-div">
                        <p class="Suggested-people-name">Arya Stark</p>
                        <span class="Suggested-people-foolowing">Follwing by 1.13k people</span>
                    </div>
                    <button class="Suggested-people-button">Follow</button>
                </div>

            </div>
            <div class="comRight-footer">
                <a href="">TheBookSourcing Rule</a>
                <a href="">Private policy</a>
                <a href="">Cookie</a>
                <a href="">User Agreement</a>
                <a href="">Accessibility</a>
                <a href="">Advertise with us</a>
                  <a href="">TheBookSourcing, Inc. Â© 2025. All rights reserved.</a>
                
            </div>
           
            
        </div>
      </div>
    </div>
    <!-- account tool collapse -->
    <div class="toast-container position-fixed  end-0 p-3">
      <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" >
        <div class="toast-header">
            <img src="dog.png"  class="userPf">
            <div class="userDetails">
              <p>Name</p>
              <p>@Nickname</p>
              <a href="#" style="color: #275791;">View channel</a>
          </div>
        </div>
        <div class="toast-header">
          <a href="#"><i class="fa-solid fa-gear"></i> Settings</a>
        </div>
        <div class="toast-header" id="themeSwitchSection">
            <button class="theme-switch">
              <i class="fa-solid fa-sun"></i>
              <i class="fa-solid fa-moon"></i>
            </button>
            <p id="theme-switch-word" class="theme-switch">
              <span class="fa-sun-word" >Light mode</span>
              <span class="fa-moon-word" >Dark mode</span>
            </p>
        </div>
        <div class="toast-header">
          <a href="#"><i class="fa-solid fa-circle-question"></i> Help</a>
        </div>
        <div class="toast-header"  >
          <a class="feedBackBtn2"><i class="fa-solid fa-comment-dots"></i> Feedback</a>
        </div>
        <div class="toast-body " >
          <a href="userSign/login.html"><i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Login</span></a>
        </div>
      </div>
    </div>
    <!-- feedback collapse -->
    <div class="toast-containers w-500">
      <div id="liveToast2" class="toast" role="alert" aria-live="assertive" aria-atomic="true" >
        <div class="toast-header">
            <div>Send Feedback to TheBookSourcing</div>
            <button type="button" data-bs-target="#liveToast2" data-bs-dismiss="toast" aria-label="Close" id="btnCloseFBToast"><i class="fa-solid fa-arrow-right"></i></button>
        </div>
        <div class="toast-body">
          <form action="">
            <label> Please give us your feedback (required)</label>
            <input type="text" name="feedbackInput" required id="feedbackInput">
            <br>
            <br>
            <label >A screenshot will help us to understand more about your feedback (optional)</label>
            <br>
            <label class="custom-file">
              <input type="file" id="fileUpload">
              <span>  <i class="fa-solid fa-camera"></i> Capture screenshot</span>
            </label>
            <div>
              <img src="camera.png" id="screenshot" >
            </div>
            <br>
            <div id="allowEmailUpdate">
              <input type="checkbox" name="" id=""><label>We may email you for more updates</label>
            </div>
            <p id="smallWarning" ><i class="fa-solid fa-circle-exclamation text-warning" ></i> Please do not include any sensitive information! Sensitive information is any data that should be protected. Please do not include passwords, credit card numbers, or personal detail.</p>
            <button type="submit" id="feedbackSubmit" name="feedbackSubmit">Submit</button>
          </form>
        </div>
      </div>
    </div>
      
    <!-- Bootstrap Toast for editing -->
<div id="editToastWrapper">
  <div id="editToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body">
      <input type="text" id="editMessageInput" class="form-control mb-2">
      <div class="d-flex justify-content-end">
        <button id="cancelEditBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
        <button id="saveEditBtn" type="button" class="btn btn-sm btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Toast for deleting -->
<div id="deleteToastWrapper">
  <div id="deleteToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body">
      <p>Are you sure you want to delete this message?</p>
      <div class="d-flex justify-content-end">
        <button id="cancelDeleteBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
        <button id="confirmDeleteBtn" type="button" class="btn btn-sm btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Report Toast -->
<div id="reportToastWrapper">
  <div id="reportToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body">
      <h6>Report Post</h6>
      <textarea id="reportReasonInput" class="form-control mb-2" placeholder="Reason..."></textarea>
      <div class="d-flex justify-content-end">
        <button id="cancelReportBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
        <button id="submitReportBtn" type="button" class="btn btn-sm btn-danger">Submit</button>
      </div>
    </div>
  </div>
</div>

<!-- report Toast -->
<!-- <div id="PostToastWrapper">
  <div id="PostToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <form id="form">
      <div class="toast-body">
        <h6>Report Post</h6>
        <textarea id="postReasonInput" class="form-control mb-2" placeholder="Reason..."></textarea>
        <div class="d-flex justify-content-end">
          <button id="cancelPostBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
          <button id="submitPostBtn" type="button" class="btn btn-sm btn-danger">Submit</button>
        </div>
      </div>
    </form>
  </div>
</div> -->

<!--Feeling Toast-->
<div id="FeelingToastWrapper">
    <div id="FeelingToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body">
         <div id="feelingGrid" class="grid-container">
          
          <div class="feeling-option">ğŸ˜Š happy</div>
          <div class="feeling-option">ğŸ˜¢ sad</div>
          <div class="feeling-option">ğŸ˜¡ angry</div>
          <div class="feeling-option">ğŸ˜‡ blissful</div>
          <div class="feeling-option">ğŸ˜ in love</div>
          <div class="feeling-option">ğŸ˜œ silly</div>
          <div class="feeling-option">ğŸ˜ cool</div>
          <div class="feeling-option">ğŸ˜Œ relaxed</div>
          <div class="feeling-option">ğŸ˜´ sleepy</div>
          <div class="feeling-option">ğŸ¤’ sick</div>
          <div class="feeling-option">ğŸ¤— loved</div>
          <div class="feeling-option">ğŸ˜± shocked</div>
          <div class="feeling-option">ğŸ˜ disappointed</div>
          <div class="feeling-option">ğŸ˜¤ frustrated</div>
          <div class="feeling-option">ğŸ¤© excited</div>
          <div class="feeling-option">ğŸ¥³ festive</div>
          <div class="feeling-option">ğŸ˜” down</div>
          <div class="feeling-option">ğŸ˜• confused</div>
          <div class="feeling-option">ğŸ˜¬ nervous</div>
          <div class="feeling-option">ğŸ˜‡ blessed</div>
          <div class="feeling-option">ğŸ™ thankful</div>
          <div class="feeling-option">ğŸ˜… amused</div>
          <div class="feeling-option">ğŸ¤“ curious</div>
          <div class="feeling-option">ğŸ˜© overwhelmed</div>
          <div class="feeling-option">ğŸ˜† fantastic</div>
          <div class="feeling-option">ğŸ˜¶ meh</div>
          <div class="feeling-option">ğŸ˜¢ heartbroken</div>
          <div class="feeling-option">ğŸ˜¤ determined</div>
          <div class="feeling-option">ğŸ˜‡ inspired</div>
          <div class="feeling-option">ğŸ˜µâ€ğŸ’« crazy</div>
          <div class="feeling-option">ğŸ˜ OK</div>
          <div class="feeling-option">ğŸ˜ƒ proud</div>
          <div class="feeling-option">ğŸ˜‹ satisfied</div>
          <div class="feeling-option">ğŸ˜³ embarrassed</div>
          <div class="feeling-option">ğŸ¤” thoughtful</div>
          <div class="feeling-option">ğŸ˜ lovely</div>
          <div class="feeling-option">ğŸ˜– miserable</div>
          <div class="feeling-option">ğŸ˜‡ grateful</div>
        </div>
          <div class="d-flex justify-content-end mt-2">
            <button id="cancelFeelingBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
          </div>
        </div>
    </div>
  </div>
  </main>
  <footer>
  </footer>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
// --- Feeling Dictionary (global) ---
const feelingMap = {
  happy: "ğŸ˜Š happy",
  sad: "ğŸ˜¢ sad",
  angry: "ğŸ˜¡ angry",
  blissful: "ğŸ˜‡ blissful",
  "in love": "ğŸ˜ in love",
  silly: "ğŸ˜œ silly",
  cool: "ğŸ˜ cool",
  relaxed: "ğŸ˜Œ relaxed",
  sleepy: "ğŸ˜´ sleepy",
  sick: "ğŸ¤’ sick",
  loved: "ğŸ¤— loved",
  shocked: "ğŸ˜± shocked",
  disappointed: "ğŸ˜ disappointed",
  frustrated: "ğŸ˜¤ frustrated",
  excited: "ğŸ¤© excited",
  festive: "ğŸ¥³ festive",
  down: "ğŸ˜” down",
  confused: "ğŸ˜• confused",
  nervous: "ğŸ˜¬ nervous",
  blessed: "ğŸ˜‡ blessed",
  thankful: "ğŸ™ thankful",
  amused: "ğŸ˜… amused",
  curious: "ğŸ¤“ curious",
  overwhelmed: "ğŸ˜© overwhelmed",
  fantastic: "ğŸ˜† fantastic",
  meh: "ğŸ˜¶ meh",
  heartbroken: "ğŸ˜¢ heartbroken",
  determined: "ğŸ˜¤ determined",
  inspired: "ğŸ˜‡ inspired",
  crazy: "ğŸ˜µâ€ğŸ’« crazy",
  ok: "ğŸ˜ OK",
  proud: "ğŸ˜ƒ proud",
  satisfied: "ğŸ˜‹ satisfied",
  embarrassed: "ğŸ˜³ embarrassed",
  thoughtful: "ğŸ¤” thoughtful",
  lovely: "ğŸ˜ lovely",
  miserable: "ğŸ˜– miserable",
  grateful: "ğŸ˜‡ grateful"
};




const API_URL = "https://thebooksourcings.onrender.com";

 function parseJwt (token) {
  try {
    return JSON.parse(atob(token.split('.')[1]));
  } catch (e) {
    return null;
  }
}

const token = localStorage.getItem("token");
let userMemberQid = null;
let username = null;

if (token) {
  const decoded = parseJwt(token);
  userMemberQid = decoded?.memberQid || null;
  username = decoded?.username || null;
}

const usernameFrom = document.querySelector(".usernameFrom");

if (username) {
  usernameFrom.textContent = username;
}

const socket = io(API_URL, { auth: { token } });

// ====== DECLARATIONS ======
// Edit
let editingMessageId = null;
const editToast = new bootstrap.Toast(document.getElementById("editToast"), { autohide: false });
const editInput = document.getElementById("editMessageInput");

// Delete
let deletingMessageId = null;
const deleteToast = new bootstrap.Toast(document.getElementById("deleteToast"), { autohide: false });

// Report
let reportingTargetId = null;
const reportToast = new bootstrap.Toast(document.getElementById("reportToast"), { autohide: false });
const reportReasonInput = document.getElementById("reportReasonInput");

// ====== SOCKET LISTENERS ======
socket.on("connect", () => console.log("Connected:", socket.id));

socket.on("receive-message", (msg) => {
  if (!msg.createFormNow) msg.createFormNow = "just now";
  msg.feeling = feelingMap[msg.feeling] || msg.feeling;
  displayMessage(msg);
});

socket.on("message-updated", ({ message_id, newText }) => {
  const div = document.querySelector(`div[data-id='${message_id}']`);
  if (div) div.querySelector(".post-text").textContent = newText;

});

// socket.on("message-updated", ({ message_id, newText }) => {
//   const div = document.querySelector(`div[data-id='${message_id}']`);
//   if (!div) return;

//   let postText = div.querySelector(".post-text");
//   if (!postText) {
//     // create it if missing
//     postText = document.createElement("p");
//     postText.className = "post-text";
//     div.appendChild(postText);
//   }

//   postText.textContent = newText;
// });


socket.on("message-deleted", ({ message_id }) => {
  const div = document.querySelector(`div[data-id='${message_id}']`);
  if (div) div.remove();
});

// ====== LOAD ALL MESSAGES ======
async function loadMessages() {
  try {
    const res = await fetch(`${API_URL}/api/community/display`);
    if (!res.ok) throw new Error("Failed to fetch messages");
    const msgs = await res.json();
    msgs.forEach(displayMessage);
  } catch (err) {
    console.error("Error loading messages:", err);
  }
}
loadMessages();

// ====== SEND MESSAGE ======
const form = document.getElementById("form");
const messageInput = document.getElementById("message-input");
const mediaInput = document.getElementById("mediaInput");
const mediaPreview = document.getElementById("media-preview");

let selectedFile = null;

// limit of 5 multi file upload 


mediaInput.addEventListener("change", (e) => {
  const files = Array.from(e.target.files);

  if (files.length > 5) {
    alert("You can only upload up to 5 files.");
    mediaInput.value = ""; // clear selection
    return;
  }

  // âœ… safe to proceed
  console.log("Selected files:", files);
});

    // feeling toast logic
    const feelingLabel = document.getElementById('feelingLabel');
    const displayFeeling = document.getElementById("displayFeeling");
    const feelingInput = document.getElementById("feelingValue");
 
    const FeelingToast = new bootstrap.Toast(document.getElementById("FeelingToast"), { autohide: false });
    const feelingOptions = document.querySelectorAll('.feeling-option');

    // Show toast on label click
    feelingLabel.addEventListener('click', () => {
      FeelingToast.show();
    });

    // Handle click on each feeling option
    feelingOptions.forEach(option => {
      option.addEventListener("click", () => {
        const text = option.textContent;
        displayFeeling.textContent = text;

        // Save selected feeling (strip emoji if needed)
        feelingInput.value = text.replace(/^[^\w]+/, "").trim().toLowerCase();

        FeelingToast.hide();
      });
    });
    


// Show preview when user selects files
mediaInput.addEventListener("change", () => {
  const files = mediaInput.files; // can be multiple
  mediaPreview.innerHTML = ""; // clear previous preview

  if (!files || files.length === 0) return;

  // Loop through all selected files
  Array.from(files).forEach(file => {
    if (file.type.startsWith("image/")) {
      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      img.style.maxWidth = "150px";
      img.style.margin = "5px";
      img.style.borderRadius = "5px";
      mediaPreview.appendChild(img);
    } else if (file.type.startsWith("video/")) {
      const video = document.createElement("video");
      video.src = URL.createObjectURL(file);
      video.controls = true;
      video.style.maxWidth = "150px";
      video.style.margin = "5px";
      video.style.borderRadius = "5px";
      mediaPreview.appendChild(video);
    }
  });
});

// Send message (text + optional multiple media)
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const text = messageInput.value.trim();
  const feeling = feelingInput.value; // hidden input
  const files = mediaInput.files; // multiple files

  if (!text && files.length === 0 && !feeling) return; // must have text, media, or feeling

  try {
    const formData = new FormData();
    formData.append("message", text);
    formData.append("feeling", feeling);

    // Append all selected files
    Array.from(files).forEach(file => {
      formData.append("media", file); // "media" field matches backend
    });

    const res = await fetch(`${API_URL}/api/community/send`, {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}` },
      body: formData
    });

    if (!res.ok) throw new Error("Failed to send message");

    const savedMsg = await res.json();
    savedMsg.createFormNow = "just now"; // instant display
    displayMessage(savedMsg);
    socket.emit("send-message", savedMsg);

    // Reset form
    messageInput.value = "";
    mediaInput.value = "";
    mediaPreview.innerHTML = "";
    feelingInput.value = "";
    selectedFile = null;
    displayFeeling.textContent = "";
    postToast.hide();
  } catch (err) {
    console.error(err);
  }
});


// ====== DISPLAY MESSAGE ======
function displayMessage(msg) {
  const div = document.createElement("div");
  div.className = "post";
  div.dataset.id = msg.message_id;

  // --- POST HEADER ---
  const header = document.createElement("div");
  header.className = "post-header";

  const profileImg = document.createElement("img");
  profileImg.src = msg.profile_url || "../../assets/img/pf.jpg"; // placeholder
  profileImg.alt = "user-profile";
  profileImg.className = "userProfile";

  // Wrap profile image in link
  const profileLink = document.createElement("a");
  profileLink.href = `aboutUser?memberId=${msg.memberQid}`;
  profileLink.appendChild(profileImg);

  // Username link
  

  const headerRight = document.createElement("div");
  headerRight.className = "post-header-child-right";

  const headerRightTop = document.createElement("div");
  headerRightTop.className = "post-header-child-right-top";

  const headerRightBottom = document.createElement("div");
  headerRightBottom.className = "post-header-child-right-bottom";

  headerRight.appendChild(headerRightTop);
  headerRight.appendChild(headerRightBottom);

  const usernameLink = document.createElement("a");
  usernameLink.href = `aboutUser?memberId=${msg.memberQid}`;
  usernameLink.textContent = msg.username || "Unknown";
  usernameLink.className = "username";
  usernameLink.style.cursor = "pointer";
  usernameLink.style.margin = "0";
  headerRightTop.appendChild(usernameLink);

  if (msg.feeling) {
    const feeling = document.createElement("a");
    feeling.className = "feelingDisplay";
    feeling.textContent = "is feeling " + feelingMap[msg.feeling] || msg.feeling || "";
    headerRightTop.appendChild(feeling);
  }
  const postAt = document.createElement("p");
  postAt.className = "postAt";
  postAt.textContent = msg.createFormNow || "just now";
  headerRightBottom.appendChild(postAt);

  

  // Dropdown menu
  const dropdownWrapper = document.createElement("div");
  dropdownWrapper.className = "dropdown absolute-top-right";

  const ellipsisBtn = document.createElement("i");
  ellipsisBtn.className = "fa-solid fa-ellipsis";
  ellipsisBtn.setAttribute("data-bs-toggle", "dropdown");
  ellipsisBtn.style.cursor = "pointer";

  const dropdownMenu = document.createElement("ul");
  dropdownMenu.className = "dropdown-menu";
  if (msg.memberQid === userMemberQid) {
    dropdownMenu.innerHTML = `
      <li><a class="dropdown-item edit-option" href="#">Edit</a></li>
      <li><a class="dropdown-item delete-option" href="#">Delete</a></li>
      <li><a class="dropdown-item report-option" href="#">Report</a></li>
    `;
  } else {
    dropdownMenu.innerHTML = `
      <li><a class="dropdown-item report-option" href="#">Report</a></li>
    `;
  }
  dropdownWrapper.appendChild(ellipsisBtn);
  dropdownWrapper.appendChild(dropdownMenu);

  header.appendChild(profileLink);
  header.appendChild(headerRight);
  header.appendChild(dropdownWrapper);

  // --- POST BODY ---
  const body = document.createElement("div");
  body.className = "post-body";

  // Post text with truncation
 if (msg.message) {
  const textP = document.createElement("p");
  textP.className = "post-text";

  if (msg.message.length > 250) {
    const shortText = msg.message.slice(0, 250);
    textP.textContent = shortText + "... ";

    const seeMore = document.createElement("a");
    seeMore.href = "#";
    seeMore.style.cursor = "pointer";
    seeMore.style.textDecoration = "none";
    seeMore.textContent = "see more";

    seeMore.addEventListener("click", (e) => {
      e.preventDefault();
      textP.textContent = msg.message + " ";

      const seeLess = document.createElement("a");
      seeLess.href = "#";
      seeLess.style.cursor = "pointer";
      seeLess.style.textDecoration = "none";
      seeLess.textContent = "see less";

      seeLess.addEventListener("click", (e) => {
        e.preventDefault();
        textP.textContent = shortText + "... ";
        textP.appendChild(seeMore);
      });

      textP.appendChild(seeLess);
    });

    textP.appendChild(seeMore);
  } else {
    textP.textContent = msg.message; // just show short text, no links
  }

  body.appendChild(textP);
}
else{
  const textP = document.createElement("p");
  textP.className = "post-text";
  textP.textContent = "";
  body.appendChild(textP);
}
// if (msg.message) {
//   const div = document.querySelector(`div[data-id='${msg.id}']`);
//   if (!div) return; // safety check

//   let textP = div.querySelector(".post-text");
//   if (!textP) {
//     textP = document.createElement("p");
//     textP.className = "post-text";
//     div.appendChild(textP); // append inside the post container, not body
//   }

//   if (msg.message.length > 250) {
//     const shortText = msg.message.slice(0, 250);
//     textP.textContent = shortText + "... ";

//     const seeMore = document.createElement("a");
//     seeMore.href = "#";
//     seeMore.style.cursor = "pointer";
//     seeMore.style.textDecoration = "none";
//     seeMore.textContent = "see more";

//     seeMore.addEventListener("click", (e) => {
//       e.preventDefault();
//       textP.textContent = msg.message + " ";

//       const seeLess = document.createElement("a");
//       seeLess.href = "#";
//       seeLess.style.cursor = "pointer";
//       seeLess.style.textDecoration = "none";
//       seeLess.textContent = "see less";

//       seeLess.addEventListener("click", (e) => {
//         e.preventDefault();
//         textP.textContent = shortText + "... ";
//         textP.appendChild(seeMore);
//       });

//       textP.appendChild(seeLess);
//     });

//     textP.appendChild(seeMore);
//   } else {
//     textP.textContent = msg.message;
//   }
// }



 // --- MEDIA SECTION ---
 // --- VIDEO OBSERVER ---
// Autoplay when visible, pause when out of view
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    const video = entry.target;
    if (entry.isIntersecting) {
      video.play().catch(() => {});
    } else {
      video.pause();
    }
  });
}, { threshold: 0.5 });

function observeVideo(video) {
  observer.observe(video);
}

// --- DISPLAY MESSAGE ---
if (msg.media_url && msg.media_url.length > 0) {
  const mediaWrapper = document.createElement("div");
  mediaWrapper.className = "post-thumbnail position-relative"; // allow overlay

  const carouselId = `carousel-${msg.message_id}`;

  if (msg.media_url.length === 1) {
    const type = msg.media_type[0];
    const itemWrapper = document.createElement("div");
    itemWrapper.className = "blur-wrapper";

    const mediaContainer = document.createElement("div");
    mediaContainer.className = "media-container";

    if (type === "image") {
      const img = document.createElement("img");
      img.src = msg.media_url[0];
      img.className = "post-thumbnail-img";
      mediaContainer.appendChild(img);

      itemWrapper.style.setProperty("--bg-url", `url(${msg.media_url[0]})`);
    } else if (type === "video") {
      const video = document.createElement("video");
      video.src = msg.media_url[0];
      video.controls = true;
      video.muted = true;
      video.loop = true;
      video.className = "post-thumbnail-video";
      mediaContainer.appendChild(video);
      observeVideo(video);

      itemWrapper.style.background = "rgba(0,0,0,0.8)";
    }

    itemWrapper.appendChild(mediaContainer);
    mediaWrapper.appendChild(itemWrapper);
  } else {
    // --- Multiple files -> Bootstrap carousel ---
    const carousel = document.createElement("div");
    carousel.className = "carousel slide";
    carousel.id = carouselId;
    carousel.setAttribute("data-bs-ride", "carousel");
    carousel.setAttribute("data-bs-interval", "8000");

    const inner = document.createElement("div");
    inner.className = "carousel-inner";

   msg.media_url.forEach((url, index) => {
  const item = document.createElement("div");
  item.className = index === 0 ? "carousel-item active" : "carousel-item";

  const blurWrapper = document.createElement("div");
  blurWrapper.className = "blur-wrapper";

  const mediaContainer = document.createElement("div");
  mediaContainer.className = "media-container";

  if (msg.media_type[index] === "image") {
    const img = document.createElement("img");
    img.src = url;
    img.className = "post-thumbnail-img";
    mediaContainer.appendChild(img);

    // âœ… set --bg-url for blur
    blurWrapper.style.setProperty("--bg-url", `url(${url})`);
  } else if (msg.media_type[index] === "video") {
    const video = document.createElement("video");
    video.src = url;
    video.controls = true;
    video.muted = true;
    video.loop = true;
    video.className = "post-thumbnail-video";
    mediaContainer.appendChild(video);
    observeVideo(video);

    // âœ… fallback for blur: set --bg-url to a dark transparent color
    blurWrapper.style.setProperty("--bg-url", `linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8))`);
  }

  blurWrapper.appendChild(mediaContainer);
  item.appendChild(blurWrapper);
  inner.appendChild(item);
});

    carousel.appendChild(inner);
    mediaWrapper.appendChild(carousel);

    // --- Modern counter ---
    const counter = document.createElement("div");
    counter.className = "carousel-counter position-absolute";
    counter.textContent = `1/${msg.media_url.length}`;
    mediaWrapper.appendChild(counter);

    // Prev/Next buttons
    const prevBtn = document.createElement("button");
    prevBtn.className = "carousel-control-prev";
    prevBtn.type = "button";
    prevBtn.setAttribute("data-bs-target", `#${carouselId}`);
    prevBtn.setAttribute("data-bs-slide", "prev");
    prevBtn.innerHTML = `<span class="carousel-control-prev-icon"></span>`;

    const nextBtn = document.createElement("button");
    nextBtn.className = "carousel-control-next";
    nextBtn.type = "button";
    nextBtn.setAttribute("data-bs-target", `#${carouselId}`);
    nextBtn.setAttribute("data-bs-slide", "next");
    nextBtn.innerHTML = `<span class="carousel-control-next-icon"></span>`;

    mediaWrapper.appendChild(prevBtn);
    mediaWrapper.appendChild(nextBtn);

    // Update counter on slide change
    carousel.addEventListener("slid.bs.carousel", () => {
      const activeIndex = Array.from(inner.children).findIndex(c => c.classList.contains("active"));
      counter.textContent = `${activeIndex + 1}/${msg.media_url.length}`;
    });
  }

  body.appendChild(mediaWrapper);
}

// if (msg.media_url && msg.media_url.length > 0) {
//   const mediaWrapper = document.createElement("div");
//   mediaWrapper.className = "post-thumbnail position-relative"; // allow overlay

//   const carouselId = `carousel-${msg.message_id}`;

//  if (msg.media_url.length === 1) {
//   const type = msg.media_type[0];
//   const itemWrapper = document.createElement("div");
//   itemWrapper.className = "blur-wrapper";

//   const mediaContainer = document.createElement("div");
//   mediaContainer.className = "media-container";

//   if (type === "image") {
//     const img = document.createElement("img");
//     img.src = msg.media_url[0];
//     img.className = "post-thumbnail-img";
//     mediaContainer.appendChild(img);

//     itemWrapper.style.setProperty("--bg-url", `url(${msg.media_url[0]})`);
//   } else if (type === "video") {
//     const video = document.createElement("video");
//     video.src = msg.media_url[0];
//     video.controls = true;
//     video.muted = true;
//     video.loop = true;
//     video.className = "post-thumbnail-video";
//     mediaContainer.appendChild(video);
//     observeVideo(video);

//     itemWrapper.style.background = "rgba(0,0,0,0.8)";
//   }

//   itemWrapper.appendChild(mediaContainer);
//   mediaWrapper.appendChild(itemWrapper);
// }
// else {
//     // --- Multiple files -> Bootstrap carousel ---
//     const carousel = document.createElement("div");
//     carousel.className = "carousel slide";
//     carousel.id = carouselId;
//     carousel.setAttribute("data-bs-ride", "carousel");
//     carousel.setAttribute("data-bs-interval", "8000");

//     const inner = document.createElement("div");
//     inner.className = "carousel-inner";

//     msg.media_url.forEach((url, index) => {
//   const item = document.createElement("div");
//   item.className = index === 0 ? "carousel-item active" : "carousel-item";

//   // Blur wrapper inside each item
//   const blurWrapper = document.createElement("div");
//   blurWrapper.className = "blur-wrapper";

//   // Media container
//   const mediaContainer = document.createElement("div");
//   mediaContainer.className = "media-container";

//   if (msg.media_type[index] === "image") {
//     const img = document.createElement("img");
//     img.src = url;
//     img.className = "post-thumbnail-img";
//     mediaContainer.appendChild(img);

//     // background for blur
//     blurWrapper.style.setProperty("--bg-url", `url(${url})`);
//   } else if (msg.media_type[index] === "video") {
//     const video = document.createElement("video");
//     video.src = url;
//     video.controls = true;
//     video.muted = true;
//     video.loop = true;
//     video.className = "post-thumbnail-video";
//     mediaContainer.appendChild(video);
//     observeVideo(video);

//     // fallback blur (black bg)
//     blurWrapper.style.background = "rgba(0,0,0,0.8)";
//   }

//   blurWrapper.appendChild(mediaContainer);
//   item.appendChild(blurWrapper);
//   inner.appendChild(item);
// });


//     carousel.appendChild(inner);
//     mediaWrapper.appendChild(carousel);

//     // --- Modern counter ---
//     const counter = document.createElement("div");
//     counter.className = "carousel-counter position-absolute";
//     counter.textContent = `1/${msg.media_url.length}`;
//     mediaWrapper.appendChild(counter);

//     // Prev/Next buttons
//     const prevBtn = document.createElement("button");
//     prevBtn.className = "carousel-control-prev";
//     prevBtn.type = "button";
//     prevBtn.setAttribute("data-bs-target", `#${carouselId}`);
//     prevBtn.setAttribute("data-bs-slide", "prev");
//     prevBtn.innerHTML = `<span class="carousel-control-prev-icon"></span>`;

//     const nextBtn = document.createElement("button");
//     nextBtn.className = "carousel-control-next";
//     nextBtn.type = "button";
//     nextBtn.setAttribute("data-bs-target", `#${carouselId}`);
//     nextBtn.setAttribute("data-bs-slide", "next");
//     nextBtn.innerHTML = `<span class="carousel-control-next-icon"></span>`;

//     mediaWrapper.appendChild(prevBtn);
//     mediaWrapper.appendChild(nextBtn);

//     // Update counter on slide change
//     carousel.addEventListener("slid.bs.carousel", () => {
//       const activeIndex = Array.from(inner.children).findIndex(c => c.classList.contains("active"));
//       counter.textContent = `${activeIndex + 1}/${msg.media_url.length}`;
//     });
//   }

//   body.appendChild(mediaWrapper);
// }

// --- VIDEO OBSERVER ---
// Autoplay when visible, pause when out of view

// const observer = new IntersectionObserver((entries) => {
//   entries.forEach(entry => {
//     const video = entry.target;
//     if (entry.isIntersecting) {
//       video.play().catch(() => {});
//     } else {
//       video.pause();
//     }
//   });
// }, { threshold: 0.5 });

// function observeVideo(video) {
//   observer.observe(video);
// }





  // Like / comment / repost counts
  const counts = document.createElement("div");
  counts.className = "post-media-count";
  counts.innerHTML = `
    <div>
      <p><span class="post-like-count">${msg.like_count || 0}</span> Likes</p>
    </div>
    <div class="post-media-count-child-right">
      <p><span class="post-comment-count">${msg.comment_count || 0}</span> comments</p>
      <p><span class="post-repost-count">${msg.repost_count || 0}</span> reposts</p>
    </div>
  `;
  body.appendChild(counts);

  // --- BUTTONS ---
  const btnRow = document.createElement("div");
  btnRow.className = "post-media-button";

  // Like btn
  const likeBtn = document.createElement("button");
  likeBtn.className = "likeBtn media-btn";
  likeBtn.dataset.id = msg.message_id;
  likeBtn.innerHTML = `<i class="fa-solid fa-heart"></i> <span>Like</span>`;

  // Comment btn
  const commentBtn = document.createElement("button");
  commentBtn.className = "commentBtn media-btn";
  commentBtn.dataset.id = msg.message_id;
  commentBtn.innerHTML = `<i class="fa-solid fa-comment"></i> <span>Comment</span>`;
  commentBtn.onclick = () => {
    window.location.href = `aboutPost.html?post_id=${msg.message_id}`;
  };

  // Repost btn
  const repostBtn = document.createElement("button");
  repostBtn.className = "repostBtn media-btn";
  repostBtn.dataset.id = msg.message_id;
  repostBtn.innerHTML = `<i class="fa-solid fa-share-from-square"></i> <span>Repost</span>`;

  btnRow.appendChild(likeBtn);
  btnRow.appendChild(commentBtn);
  btnRow.appendChild(repostBtn);

  body.appendChild(btnRow);

  // Append together
  div.appendChild(header);
  div.appendChild(body);
  document.getElementById("message-container").prepend(div);

  // === Attach like toggle logic ===
  const likeIcon = likeBtn.querySelector("i");
  const likeCount = counts.querySelector(".post-like-count");
  loadLikeInfoForMessage(msg.message_id, likeIcon, likeCount);
  likeBtn.onclick = async () => {
    await toggleLikeActivityForMessage(msg.message_id, likeIcon, likeCount);
  };

  // === Dropdown click handlers ===
  dropdownMenu.querySelectorAll("a").forEach((item) => {
    item.addEventListener("click", (e) => {
      e.preventDefault();
      if (item.classList.contains("edit-option")) {
        editingMessageId = msg.message_id;
        editInput.value = msg.message;
        editToast.show();
      } else if (item.classList.contains("delete-option")) {
        deletingMessageId = msg.message_id;
        deleteToast.show();
      } else if (item.classList.contains("report-option")) {
        reportingTargetId = msg.message_id;
        reportToast.show();
      }
    });
  });
}


// ====== LIKE FUNCTIONS ======
async function loadLikeInfoForMessage(messageId, likeIcon, likeCount) {
  try {
    const res = await fetch(`${API_URL}/api/communityPostLike/status/${messageId}`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (!res.ok) throw new Error("Failed to fetch like status");

    const data = await res.json();
    likeCount.textContent = data.post.like_count;
    likeIcon.style.color = data.userStatus.liked ? "red" : "gray";
  } catch (err) {
    console.error(err);
  }
}

async function toggleLikeActivityForMessage(messageId, likeIcon, likeCount) {
  try {
    const res = await fetch(`${API_URL}/api/communityPostLike/like/${messageId}`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });
    if (!res.ok) throw new Error("Failed to toggle like");

    const data = await res.json();
    likeIcon.style.color = data.liked ? "red" : "gray";
    await loadLikeInfoForMessage(messageId, likeIcon, likeCount);
  } catch (err) {
    console.error(err);
  }
}

// ====== EDIT  Fetch======
document.getElementById("saveEditBtn").onclick = async () => {
  const newText = editInput.value.trim();
  if (!newText || !editingMessageId) return;
  try {
    await fetch(`${API_URL}/api/community/edit`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ message_id: editingMessageId, newText })
    });
    socket.emit("edit-message", { message_id: editingMessageId, newText });
    editToast.hide();
    editingMessageId = null;
  } catch (err) {
    console.error(err);
  }
};

// ====== DELETE Fetch ======
document.getElementById("confirmDeleteBtn").onclick = async () => {
  if (!deletingMessageId) return;
  try {
    await fetch(`${API_URL}/api/community/delete`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ message_id: deletingMessageId })
    });
    socket.emit("delete-message", { message_id: deletingMessageId });
    deleteToast.hide();
    deletingMessageId = null;
  } catch (err) {
    console.error(err);
  }
};

// ====== REPORT Fetch======
document.getElementById("submitReportBtn").onclick = async () => {
  const reasonTxt = reportReasonInput.value.trim();
  if (!reasonTxt || !reportingTargetId) return;

  try {
    const res = await fetch(`${API_URL}/api/community/report`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        reasonTxt,
        reportTypeFrom_id: reportingTargetId
      })
    });

    if (!res.ok) throw new Error("Failed to submit report");

    const data = await res.json();
    alert(data.message);
    reportToast.hide();
    reportingTargetId = null;
    reportReasonInput.value = "";
  } catch (err) {
    console.error("Report error:", err);
  }
};

 // Post toast
  const postToast = new bootstrap.Toast(document.getElementById("PostToast"), { autohide: false });
  const searchBtn = document.getElementById("searchButton");

  searchBtn.addEventListener("click", () => {
    postToast.show();
  });

  document.getElementById("cancelPostBtn").onclick = () => {
    postToast.hide();
    messageInput.value = "";
    mediaInput.value = "";
    mediaPreview.innerHTML = "";
    feelingInput.value = "";
    selectedFile = null;
    displayFeeling.textContent = "";
  };

  

// ====== CANCEL BUTTONS ======


// cancel edit btn
document.getElementById("cancelEditBtn").onclick = () => {
  editingMessageId = null;
  editToast.hide();
};


// cancel delete btn
document.getElementById("cancelDeleteBtn").onclick = () => {
  deletingMessageId = null;
  deleteToast.hide();
};

// cancel report btn
document.getElementById("cancelReportBtn").onclick = () => {
  reportingTargetId = null;
  reportReasonInput.value = "";
  reportToast.hide();
};



    // Cancel button
    document.getElementById("cancelFeelingBtn").onclick = () => {
      FeelingToast.hide();
      displayFeeling.textContent = "";
      feelingInput.value = "";
    };
</script>
  <!-- <script src="../../assets/js/index/index.js"></script> -->
  <script src="../../assets/js/index/darkmode.js" defer></script>
  <script src="../../assets/js/index/collapseResponsive.js"></script>
  <script src="../../assets/js/index/followingAcc.js"></script>
  <script src="../../assets/js/index/accountToast.js"></script>
  <!-- <script src="../../assets/js/index/navNewFeed.js"></script> -->
  <script src="../../assets/js/index/feedbackToast.js"></script>
  <script src="../../assets/js/index/headerSearch.js"></script>
  <!-- <script src="../../assets/js/userUploadBook/userDisplayBook.js"></script> -->
  
</body>
</html>