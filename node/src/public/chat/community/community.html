<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Community Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    #message-container div { 
        margin-bottom: 10px; 
        padding: 8px 10px; 
        background: #fff; 
        border-radius: 5px; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }
    .msg-text { margin-right: 10px; }
    .createdAt{
        float: right;
        color: grey;
    } */

    .userPfFrom{
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }
     #message-container{
      display: grid;
      gap: 15px;
      width: 50%;
      margin: auto;
     }
    /* .owner-btn { margin-left: 5px; cursor: pointer; color: red; font-weight: bold; }
    #form { margin-top: 20px; display: flex; }
    #message-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;} */
    /* #form button { margin-left: 10px; padding: 8px 15px; border: none; border-radius: 5px; background: #4CAF50; color: white; cursor: pointer; }
    #form button:hover { background: #45a049; } */

    /* Center edit toast in the page */
    #editToastWrapper {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1080;
    }

    /* Center delete toast in the page */
    #deleteToastWrapper {
        position: fixed;
        top: 60%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1080;
    }

    #reportToastWrapper {
      position: fixed;
      top: 55%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1080;
      width: 300px;
    }

     #PostToastWrapper {
      position: fixed;
      top: 55%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1080;
      width: 80%;
      height: auto;
      border-radius: 10px;
    }
    #toastOfPost{
        width: 70%;
        height: auto;
        margin: auto;
        
        border-radius: 10px
    }
    #searchButton{
        width: 70%;
        background: none;
        border: 1px solid gainsboro;
        border-radius: 10px;
        display: flex;
        height: 50px;
        justify-content: start;
        padding: 10px;
        color: gray;
    }

     .post{
            width: 100%;
            height: auto;
            padding: 10px 20px 10px 20px;
            margin: auto;
            padding-left: 10px;
            border-radius: 15px;
            box-shadow: 0px 0px 3px rgba(86, 86, 86, 0.144);
        }
       
        
         .post .post-header{
            width: 100%;
            display: flex;
            padding: 5px;
            gap: 15px;
            position: relative;
            
        }
        .userProfile{
            width: 55px;
            height: 55px;
            border-radius: 50%;
            object-fit: cover;
        }
        .post-header-child-right{
          display: grid;
          gap: 0px;

        }
        .post-header-child-right-top{
          display: flex;
          justify-content: start;
          /* background-color: aquamarine; */
          padding: 0;
          margin: 0;
          align-items: center;
        }
        .post-header-child-right-bottom{
          /* background-color: blueviolet; */
          margin: 0;
          padding: 0;
          position: relative;
        }
        .feelingDisplay{
          color: gray;
          font-family: sans-serif;
          font-size: medium;
          text-decoration: none;
          margin-left: 5px;
        
        }

         .username{
            font-family: monospace;
            margin: 0;
            font-size: larger;
            text-decoration: none;
            color: black;
         }
         .postAt{
            color: gray;
            opacity: 0.8;
            font-size: small;
            font-family: monospace;
            margin: 0;
           
         }
         .absolute-top-right{
            font-size: large;
            color: rgb(0, 0, 0);
            
            position: absolute;
            top: 5px;
            right: 5px;
            
         }
         .post .post-body{
            width: 100%;
            padding: 5px;
         }
         .post-text{
            font-family: sans-serif;
            margin: 0;
         }
        
          /* .post-thumbnail {
            position: relative;
            width: 100%;
            height: 350px;
            margin: auto;
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
          }

            .post-thumbnail-img {
              position: relative;
              z-index: 1;
              height: 100%;
              object-fit: contain; 
            } */
             /* .post-thumbnail {
                position: relative;
                width: 100%;
                height: 350px;
                margin: auto;
                margin-top: 10px;
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: hidden;
              }

              .post-thumbnail::before {
                content: "";
                position: absolute;
                inset: 0;
                background: var(--bg-url) center/cover no-repeat;
                filter: blur(30px);
                transform: scale(1.1); 
                z-index: 0;
              }

              .post-thumbnail-img {
                position: relative;
                z-index: 1;
                height: 100%;
                object-fit: contain;
              } */

            /* Outer wrapper still applies general blur for single media */
.post-thumbnail {
  position: relative;
  width: 100%;
  height: 350px;
  margin: 10px auto 0;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}
.carousel,
.carousel-inner,
.carousel-item {
  width: 100%;
  height: 100%;
  position: relative;
}

.carousel-item {
  width: 100%;
  height: 100%;
  /* display: flex;
  justify-content: center;
  align-items: center; */
  position: relative;
}


/* Blur background wrapper */
/* .blur-wrapper {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
} */
 .blur-wrapper {
    width: 100%;
  height: 100%;
  position: relative; /* absolutely cover the carousel-item */
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}


.blur-wrapper::before {
  content: "";
  position: absolute;
  inset: 0;
  background: var(--bg-url) center/cover no-repeat;
  filter: blur(30px);
  transform: scale(1.1);
  z-index: 0;
}

.media-container {
  position: relative;
  z-index: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
}
.carousel {
  width: 100%;
  height: 350px;
  position: relative;  /* same as .post-thumbnail */
}

/* Image centered, original size */
.post-thumbnail-img {
  max-height: 100%;
  position: relative;
  width: auto;
  object-fit: contain; 
    z-index: 1;/* disable fitting */
}

/* Video same treatment */
.post-thumbnail-video {
  max-height: 100%;
  width: auto;
  position: relative;
  object-fit: contain;
    z-index: 1;
}

/* Counter top-right */
.carousel-counter {
  top: 10px;
  right: 15px;
  color: white;
  font-size: 14px;
  background: rgba(0,0,0,0.6);
  padding: 2px 8px;
  border-radius: 12px;
  z-index: 2;
}

        .post .post-body .post-media-count{
            
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin-top: 10px;
            font-family: sans-serif;
            align-items: end;
            font-size: 14px;
            opacity: 0.9;
            padding: 0;
         }
         .post-media-count div{
            margin: 0;
            height: auto;
           
            display: flex;
            justify-content: start;
            align-items: end;
            
         }
         .post-media-count div p{
            padding: 0;
          margin-bottom: 0;
         }
         .post-media-count-child-right{
            display: flex;
            gap: 25px;
         }
         
         .post-hr{
            color: gainsboro;
            background-color: gainsboro;
            opacity: 0.3;
         }
         .post-media-button{
            display: flex;
            border-top: 1px gainsboro solid;
            justify-content: space-between;
            padding: 0;
            
            align-items: end;
            margin: 0;
         }
         .media-btn{
            width: calc(100%/3.06);
            padding: 18px;
            margin: 0;
            background:none;
            border: none;
            cursor: pointer;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            
         }
         .media-btn span{
            /* margin-top: 2px; */
             color:gray;
         }
         .media-btn:hover{
            background-color: gainsboro;
         }
         .fa-solid{
            font-size: large;
            color:gray;
         }
          @media screen and (max-width: 768px) {
             #message-container{
              width: 97%;
             }
        }
    
/* feeling toast */
         #FeelingToastWrapper {
      position: fixed;
      top: 55%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1090;
     
    }

    .grid-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      height: 300px;
      overflow-y: auto;
    }

    .feeling-option {
      padding: 8px;
      background-color: #f8f9fa;
      border-radius: 6px;
      cursor: pointer;
      text-align: start;
      transition: background-color 0.2s;
      font-size: 1rem;
    }

    .feeling-option:hover {
      background-color: #e2e6ea;
    }

    #displayFeeling {
      font-family: monospace;
      color:gray;
    }

    #feelingValue {
      display: none;
    }

  </style>
</head>
<body>




<!-- <form id="form">
  <textarea id="message-input" placeholder="Type your message..." rows="3"></textarea>
  <div class="d-flex align-items-center mt-2">
    <label for="mediaInput" style="cursor: pointer; margin-right: 10px;">
      <i class="fa-solid fa-photo-film fa-lg"></i>
    </label>
    <input type="file" id="mediaInput" accept="image/*,video/*" style="display: none;">
    <button type="submit">Send</button>
  </div>
  <div id="media-preview" class="mt-2"></div>
</form> -->

<div style="display: flex; width: 90%;justify-content: center;gap: 1px;margin:auto">
  <img src="../../assets/img/pf.jpg" style="width: 50px;height: 50px;border-radius: 50%;object-fit: cover;">
<button id="searchButton">Share your thought, Meanleap Ha? </button>
</div>


<!-- Post Toast -->
<div id="PostToastWrapper">
  <div id="PostToast" class="toast align-items-center text-bg-light border-0 toastOfPost" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <img src="../../assets/img/pf.jpg" class="userPfFrom">
      <p class="usernameFrom"></p> <span id="displayFeeling"></span>
    </div>
    <form id="form">
      <div class="toast-body">
        <textarea id="message-input" class="form-control mb-2" placeholder="Share your thought"></textarea>
        <div id="media-preview" class="mt-2"></div>
        <div>
          <label for="mediaInput" style="cursor: pointer">
                <i class="fa-solid fa-photo-film fa-lg" style="color: green;"></i> Photo/Video
          </label>
          <label for="feelingGrid" id="feelingLabel" style="cursor:pointer;">
                <i class="fa-solid fa-face-smile" style="color:gold; font-size: 1.5rem;"></i> Feeling
          </label>
        </div>
           <select id="feelingValue" hidden>
            <option value="" disabled selected>Select a feeling</option>
            <option value="happy">😊 happy</option>
            <option value="sad">😢 sad</option>
            <option value="angry">😡 angry</option>
            <option value="blissful">😇 blissful</option>
            <option value="in love">😍 in love</option>
            <option value="silly">😜 silly</option>
            <option value="cool">😎 cool</option>
            <option value="relaxed">😌 relaxed</option>
            <option value="sleepy">😴 sleepy</option>
            <option value="sick">🤒 sick</option>
            <option value="loved">🤗 loved</option>
            <option value="shocked">😱 shocked</option>
            <option value="disappointed">😞 disappointed</option>
            <option value="frustrated">😤 frustrated</option>
            <option value="excited">🤩 excited</option>
            <option value="festive">🥳 festive</option>
            <option value="down">😔 down</option>
            <option value="confused">😕 confused</option>
            <option value="nervous">😬 nervous</option>
            <option value="blessed">😇 blessed</option>
            <option value="thankful">🙏 thankful</option>
            <option value="amused">😅 amused</option>
            <option value="curious">🤓 curious</option>
            <option value="overwhelmed">😩 overwhelmed</option>
            <option value="fantastic">😆 fantastic</option>
            <option value="meh">😶 meh</option>
            <option value="heartbroken">😢 heartbroken</option>
            <option value="determined">😤 determined</option>
            <option value="inspired">😇 inspired</option>
            <option value="crazy">😵‍💫 crazy</option>
            <option value="ok">😐 OK</option>
            <option value="proud">😃 proud</option>
            <option value="satisfied">😋 satisfied</option>
            <option value="embarrassed">😳 embarrassed</option>
            <option value="thoughtful">🤔 thoughtful</option>
            <option value="lovely">😍 lovely</option>
            <option value="miserable">😖 miserable</option>
            <option value="grateful">😇 grateful</option>
          </select>
          <input type="file" id="mediaInput" accept="image/*,video/*" multiple hidden>
        <div class="d-flex justify-content-end">
          <button id="cancelPostBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
          <button id="submitPostBtn" type="submit" class="btn btn-sm btn-success">Post</button>
        </div>
      </div>
    </form>
  </div>
</div>
<br>
<div id="message-container"></div>


<!-- Bootstrap Toast for editing -->
<div id="editToastWrapper">
  <div id="editToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body">
      <input type="text" id="editMessageInput" class="form-control mb-2">
      <div class="d-flex justify-content-end">
        <button id="cancelEditBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
        <button id="saveEditBtn" type="button" class="btn btn-sm btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Toast for deleting -->
<div id="deleteToastWrapper">
  <div id="deleteToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body">
      <p>Are you sure you want to delete this message?</p>
      <div class="d-flex justify-content-end">
        <button id="cancelDeleteBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
        <button id="confirmDeleteBtn" type="button" class="btn btn-sm btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Report Toast -->
<div id="reportToastWrapper">
  <div id="reportToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body">
      <h6>Report Post</h6>
      <textarea id="reportReasonInput" class="form-control mb-2" placeholder="Reason..."></textarea>
      <div class="d-flex justify-content-end">
        <button id="cancelReportBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
        <button id="submitReportBtn" type="button" class="btn btn-sm btn-danger">Submit</button>
      </div>
    </div>
  </div>
</div>

<!-- Post Toast -->
<div id="PostToastWrapper">
  <div id="PostToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <form id="form">
      <div class="toast-body">
        <h6>Report Post</h6>
        <textarea id="postReasonInput" class="form-control mb-2" placeholder="Reason..."></textarea>
        <div class="d-flex justify-content-end">
          <button id="cancelPostBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
          <button id="submitPostBtn" type="button" class="btn btn-sm btn-danger">Submit</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!--Feeling Toast-->
<div id="FeelingToastWrapper">
    <div id="FeelingToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body">
         <div id="feelingGrid" class="grid-container">
          
          <div class="feeling-option">😊 happy</div>
          <div class="feeling-option">😢 sad</div>
          <div class="feeling-option">😡 angry</div>
          <div class="feeling-option">😇 blissful</div>
          <div class="feeling-option">😍 in love</div>
          <div class="feeling-option">😜 silly</div>
          <div class="feeling-option">😎 cool</div>
          <div class="feeling-option">😌 relaxed</div>
          <div class="feeling-option">😴 sleepy</div>
          <div class="feeling-option">🤒 sick</div>
          <div class="feeling-option">🤗 loved</div>
          <div class="feeling-option">😱 shocked</div>
          <div class="feeling-option">😞 disappointed</div>
          <div class="feeling-option">😤 frustrated</div>
          <div class="feeling-option">🤩 excited</div>
          <div class="feeling-option">🥳 festive</div>
          <div class="feeling-option">😔 down</div>
          <div class="feeling-option">😕 confused</div>
          <div class="feeling-option">😬 nervous</div>
          <div class="feeling-option">😇 blessed</div>
          <div class="feeling-option">🙏 thankful</div>
          <div class="feeling-option">😅 amused</div>
          <div class="feeling-option">🤓 curious</div>
          <div class="feeling-option">😩 overwhelmed</div>
          <div class="feeling-option">😆 fantastic</div>
          <div class="feeling-option">😶 meh</div>
          <div class="feeling-option">😢 heartbroken</div>
          <div class="feeling-option">😤 determined</div>
          <div class="feeling-option">😇 inspired</div>
          <div class="feeling-option">😵‍💫 crazy</div>
          <div class="feeling-option">😐 OK</div>
          <div class="feeling-option">😃 proud</div>
          <div class="feeling-option">😋 satisfied</div>
          <div class="feeling-option">😳 embarrassed</div>
          <div class="feeling-option">🤔 thoughtful</div>
          <div class="feeling-option">😍 lovely</div>
          <div class="feeling-option">😖 miserable</div>
          <div class="feeling-option">😇 grateful</div>
        </div>
          <div class="d-flex justify-content-end mt-2">
            <button id="cancelFeelingBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
          </div>
        </div>
    </div>
  </div>


<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
// --- Feeling Dictionary (global) ---
const feelingMap = {
  happy: "😊 happy",
  sad: "😢 sad",
  angry: "😡 angry",
  blissful: "😇 blissful",
  "in love": "😍 in love",
  silly: "😜 silly",
  cool: "😎 cool",
  relaxed: "😌 relaxed",
  sleepy: "😴 sleepy",
  sick: "🤒 sick",
  loved: "🤗 loved",
  shocked: "😱 shocked",
  disappointed: "😞 disappointed",
  frustrated: "😤 frustrated",
  excited: "🤩 excited",
  festive: "🥳 festive",
  down: "😔 down",
  confused: "😕 confused",
  nervous: "😬 nervous",
  blessed: "😇 blessed",
  thankful: "🙏 thankful",
  amused: "😅 amused",
  curious: "🤓 curious",
  overwhelmed: "😩 overwhelmed",
  fantastic: "😆 fantastic",
  meh: "😶 meh",
  heartbroken: "😢 heartbroken",
  determined: "😤 determined",
  inspired: "😇 inspired",
  crazy: "😵‍💫 crazy",
  ok: "😐 OK",
  proud: "😃 proud",
  satisfied: "😋 satisfied",
  embarrassed: "😳 embarrassed",
  thoughtful: "🤔 thoughtful",
  lovely: "😍 lovely",
  miserable: "😖 miserable",
  grateful: "😇 grateful"
};




const API_URL = "https://thebooksourcings.onrender.com";

 function parseJwt (token) {
  try {
    return JSON.parse(atob(token.split('.')[1]));
  } catch (e) {
    return null;
  }
}

const token = localStorage.getItem("token");
let userMemberQid = null;
let username = null;

if (token) {
  const decoded = parseJwt(token);
  userMemberQid = decoded?.memberQid || null;
  username = decoded?.username || null;
}

const usernameFrom = document.querySelector(".usernameFrom");

if (username) {
  usernameFrom.textContent = username;
}

const socket = io(API_URL, { auth: { token } });

// ====== DECLARATIONS ======
// Edit
let editingMessageId = null;
const editToast = new bootstrap.Toast(document.getElementById("editToast"), { autohide: false });
const editInput = document.getElementById("editMessageInput");

// Delete
let deletingMessageId = null;
const deleteToast = new bootstrap.Toast(document.getElementById("deleteToast"), { autohide: false });

// Report
let reportingTargetId = null;
const reportToast = new bootstrap.Toast(document.getElementById("reportToast"), { autohide: false });
const reportReasonInput = document.getElementById("reportReasonInput");

// ====== SOCKET LISTENERS ======
socket.on("connect", () => console.log("Connected:", socket.id));

socket.on("receive-message", (msg) => {
  if (!msg.createFormNow) msg.createFormNow = "just now";
  msg.feeling = feelingMap[msg.feeling] || msg.feeling;
  displayMessage(msg);
});

// socket.on("message-updated", ({ message_id, newText }) => {
//   const div = document.querySelector(`div[data-id='${message_id}']`);
//   if (div) div.querySelector(".post-text").textContent = newText;
// });

socket.on("message-updated", ({ message_id, newText }) => {
  const div = document.querySelector(`div[data-id='${message_id}']`);
  if (!div) return;

  let postText = div.querySelector(".post-text");
  if (!postText) {
    // create it if missing
    postText = document.createElement("p");
    postText.className = "post-text";
    div.appendChild(postText);
  }

  postText.textContent = newText;
});


socket.on("message-deleted", ({ message_id }) => {
  const div = document.querySelector(`div[data-id='${message_id}']`);
  if (div) div.remove();
});

// ====== LOAD ALL MESSAGES ======
async function loadMessages() {
  try {
    const res = await fetch(`${API_URL}/api/community/display`);
    if (!res.ok) throw new Error("Failed to fetch messages");
    const msgs = await res.json();
    msgs.forEach(displayMessage);
  } catch (err) {
    console.error("Error loading messages:", err);
  }
}
loadMessages();

// ====== SEND MESSAGE ======
const form = document.getElementById("form");
const messageInput = document.getElementById("message-input");
const mediaInput = document.getElementById("mediaInput");
const mediaPreview = document.getElementById("media-preview");

let selectedFile = null;

// limit of 5 multi file upload 


mediaInput.addEventListener("change", (e) => {
  const files = Array.from(e.target.files);

  if (files.length > 5) {
    alert("You can only upload up to 5 files.");
    mediaInput.value = ""; // clear selection
    return;
  }

  // ✅ safe to proceed
  console.log("Selected files:", files);
});

    // feeling toast logic
    const feelingLabel = document.getElementById('feelingLabel');
    const displayFeeling = document.getElementById("displayFeeling");
    const feelingInput = document.getElementById("feelingValue");
 
    const FeelingToast = new bootstrap.Toast(document.getElementById("FeelingToast"), { autohide: false });
    const feelingOptions = document.querySelectorAll('.feeling-option');

    // Show toast on label click
    feelingLabel.addEventListener('click', () => {
      FeelingToast.show();
    });

    // Handle click on each feeling option
    feelingOptions.forEach(option => {
      option.addEventListener("click", () => {
        const text = option.textContent;
        displayFeeling.textContent = text;

        // Save selected feeling (strip emoji if needed)
        feelingInput.value = text.replace(/^[^\w]+/, "").trim().toLowerCase();

        FeelingToast.hide();
      });
    });
    


// Show preview when user selects files
mediaInput.addEventListener("change", () => {
  const files = mediaInput.files; // can be multiple
  mediaPreview.innerHTML = ""; // clear previous preview

  if (!files || files.length === 0) return;

  // Loop through all selected files
  Array.from(files).forEach(file => {
    if (file.type.startsWith("image/")) {
      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      img.style.maxWidth = "150px";
      img.style.margin = "5px";
      img.style.borderRadius = "5px";
      mediaPreview.appendChild(img);
    } else if (file.type.startsWith("video/")) {
      const video = document.createElement("video");
      video.src = URL.createObjectURL(file);
      video.controls = true;
      video.style.maxWidth = "150px";
      video.style.margin = "5px";
      video.style.borderRadius = "5px";
      mediaPreview.appendChild(video);
    }
  });
});

// Send message (text + optional multiple media)
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const text = messageInput.value.trim();
  const feeling = feelingInput.value; // hidden input
  const files = mediaInput.files; // multiple files

  if (!text && files.length === 0 && !feeling) return; // must have text, media, or feeling

  try {
    const formData = new FormData();
    formData.append("message", text);
    formData.append("feeling", feeling);

    // Append all selected files
    Array.from(files).forEach(file => {
      formData.append("media", file); // "media" field matches backend
    });

    const res = await fetch(`${API_URL}/api/community/send`, {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}` },
      body: formData
    });

    if (!res.ok) throw new Error("Failed to send message");

    const savedMsg = await res.json();
    savedMsg.createFormNow = "just now"; // instant display
    displayMessage(savedMsg);
    socket.emit("send-message", savedMsg);

    // Reset form
    messageInput.value = "";
    mediaInput.value = "";
    mediaPreview.innerHTML = "";
    feelingInput.value = "";
    selectedFile = null;
    displayFeeling.textContent = "";
    postToast.hide();
  } catch (err) {
    console.error(err);
  }
});


// ====== DISPLAY MESSAGE ======
function displayMessage(msg) {
  const div = document.createElement("div");
  div.className = "post";
  div.dataset.id = msg.message_id;

  // --- POST HEADER ---
  const header = document.createElement("div");
  header.className = "post-header";

  const profileImg = document.createElement("img");
  profileImg.src = msg.profile_url || "../../assets/img/pf.jpg"; // placeholder
  profileImg.alt = "user-profile";
  profileImg.className = "userProfile";

  // Wrap profile image in link
  const profileLink = document.createElement("a");
  profileLink.href = `aboutUser?memberId=${msg.memberQid}`;
  profileLink.appendChild(profileImg);

  // Username link
  

  const headerRight = document.createElement("div");
  headerRight.className = "post-header-child-right";

  const headerRightTop = document.createElement("div");
  headerRightTop.className = "post-header-child-right-top";

  const headerRightBottom = document.createElement("div");
  headerRightBottom.className = "post-header-child-right-bottom";

  headerRight.appendChild(headerRightTop);
  headerRight.appendChild(headerRightBottom);

  const usernameLink = document.createElement("a");
  usernameLink.href = `aboutUser?memberId=${msg.memberQid}`;
  usernameLink.textContent = msg.username || "Unknown";
  usernameLink.className = "username";
  headerRightTop.appendChild(usernameLink);

  if (msg.feeling) {
    const feeling = document.createElement("a");
    feeling.className = "feelingDisplay";
    feeling.textContent = "is feeling " + feelingMap[msg.feeling] || msg.feeling || "";
    headerRightTop.appendChild(feeling);
  }
  const postAt = document.createElement("p");
  postAt.className = "postAt";
  postAt.textContent = msg.createFormNow || "just now";
  headerRightBottom.appendChild(postAt);

  

  // Dropdown menu
  const dropdownWrapper = document.createElement("div");
  dropdownWrapper.className = "dropdown absolute-top-right";

  const ellipsisBtn = document.createElement("i");
  ellipsisBtn.className = "fa-solid fa-ellipsis";
  ellipsisBtn.setAttribute("data-bs-toggle", "dropdown");
  ellipsisBtn.style.cursor = "pointer";

  const dropdownMenu = document.createElement("ul");
  dropdownMenu.className = "dropdown-menu";
  if (msg.memberQid === userMemberQid) {
    dropdownMenu.innerHTML = `
      <li><a class="dropdown-item edit-option" href="#">Edit</a></li>
      <li><a class="dropdown-item delete-option" href="#">Delete</a></li>
      <li><a class="dropdown-item report-option" href="#">Report</a></li>
    `;
  } else {
    dropdownMenu.innerHTML = `
      <li><a class="dropdown-item report-option" href="#">Report</a></li>
    `;
  }
  dropdownWrapper.appendChild(ellipsisBtn);
  dropdownWrapper.appendChild(dropdownMenu);

  header.appendChild(profileLink);
  header.appendChild(headerRight);
  header.appendChild(dropdownWrapper);

  // --- POST BODY ---
  const body = document.createElement("div");
  body.className = "post-body";

  // Post text with truncation
//  if (msg.message) {
//   const textP = document.createElement("p");
//   textP.className = "post-text";

//   if (msg.message.length > 250) {
//     const shortText = msg.message.slice(0, 250);
//     textP.textContent = shortText + "... ";

//     const seeMore = document.createElement("a");
//     seeMore.href = "#";
//     seeMore.style.cursor = "pointer";
//     seeMore.style.textDecoration = "none";
//     seeMore.textContent = "see more";

//     seeMore.addEventListener("click", (e) => {
//       e.preventDefault();
//       textP.textContent = msg.message + " ";

//       const seeLess = document.createElement("a");
//       seeLess.href = "#";
//       seeLess.style.cursor = "pointer";
//       seeLess.style.textDecoration = "none";
//       seeLess.textContent = "see less";

//       seeLess.addEventListener("click", (e) => {
//         e.preventDefault();
//         textP.textContent = shortText + "... ";
//         textP.appendChild(seeMore);
//       });

//       textP.appendChild(seeLess);
//     });

//     textP.appendChild(seeMore);
//   } else {
//     textP.textContent = msg.message; // just show short text, no links
//   }

//   body.appendChild(textP);
// }
if (msg.message) {
  const div = document.querySelector(`div[data-id='${msg.id}']`);
  if (!div) return; // safety check

  let textP = div.querySelector(".post-text");
  if (!textP) {
    textP = document.createElement("p");
    textP.className = "post-text";
    div.appendChild(textP); // append inside the post container, not body
  }

  if (msg.message.length > 250) {
    const shortText = msg.message.slice(0, 250);
    textP.textContent = shortText + "... ";

    const seeMore = document.createElement("a");
    seeMore.href = "#";
    seeMore.style.cursor = "pointer";
    seeMore.style.textDecoration = "none";
    seeMore.textContent = "see more";

    seeMore.addEventListener("click", (e) => {
      e.preventDefault();
      textP.textContent = msg.message + " ";

      const seeLess = document.createElement("a");
      seeLess.href = "#";
      seeLess.style.cursor = "pointer";
      seeLess.style.textDecoration = "none";
      seeLess.textContent = "see less";

      seeLess.addEventListener("click", (e) => {
        e.preventDefault();
        textP.textContent = shortText + "... ";
        textP.appendChild(seeMore);
      });

      textP.appendChild(seeLess);
    });

    textP.appendChild(seeMore);
  } else {
    textP.textContent = msg.message;
  }
}



 // --- MEDIA SECTION ---
 // --- VIDEO OBSERVER ---
// Autoplay when visible, pause when out of view
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    const video = entry.target;
    if (entry.isIntersecting) {
      video.play().catch(() => {});
    } else {
      video.pause();
    }
  });
}, { threshold: 0.5 });

function observeVideo(video) {
  observer.observe(video);
}

// --- DISPLAY MESSAGE ---
if (msg.media_url && msg.media_url.length > 0) {
  const mediaWrapper = document.createElement("div");
  mediaWrapper.className = "post-thumbnail position-relative"; // allow overlay

  const carouselId = `carousel-${msg.message_id}`;

  if (msg.media_url.length === 1) {
    const type = msg.media_type[0];
    const itemWrapper = document.createElement("div");
    itemWrapper.className = "blur-wrapper";

    const mediaContainer = document.createElement("div");
    mediaContainer.className = "media-container";

    if (type === "image") {
      const img = document.createElement("img");
      img.src = msg.media_url[0];
      img.className = "post-thumbnail-img";
      mediaContainer.appendChild(img);

      itemWrapper.style.setProperty("--bg-url", `url(${msg.media_url[0]})`);
    } else if (type === "video") {
      const video = document.createElement("video");
      video.src = msg.media_url[0];
      video.controls = true;
      video.muted = true;
      video.loop = true;
      video.className = "post-thumbnail-video";
      mediaContainer.appendChild(video);
      observeVideo(video);

      itemWrapper.style.background = "rgba(0,0,0,0.8)";
    }

    itemWrapper.appendChild(mediaContainer);
    mediaWrapper.appendChild(itemWrapper);
  } else {
    // --- Multiple files -> Bootstrap carousel ---
    const carousel = document.createElement("div");
    carousel.className = "carousel slide";
    carousel.id = carouselId;
    carousel.setAttribute("data-bs-ride", "carousel");
    carousel.setAttribute("data-bs-interval", "8000");

    const inner = document.createElement("div");
    inner.className = "carousel-inner";

   msg.media_url.forEach((url, index) => {
  const item = document.createElement("div");
  item.className = index === 0 ? "carousel-item active" : "carousel-item";

  const blurWrapper = document.createElement("div");
  blurWrapper.className = "blur-wrapper";

  const mediaContainer = document.createElement("div");
  mediaContainer.className = "media-container";

  if (msg.media_type[index] === "image") {
    const img = document.createElement("img");
    img.src = url;
    img.className = "post-thumbnail-img";
    mediaContainer.appendChild(img);

    // ✅ set --bg-url for blur
    blurWrapper.style.setProperty("--bg-url", `url(${url})`);
  } else if (msg.media_type[index] === "video") {
    const video = document.createElement("video");
    video.src = url;
    video.controls = true;
    video.muted = true;
    video.loop = true;
    video.className = "post-thumbnail-video";
    mediaContainer.appendChild(video);
    observeVideo(video);

    // ✅ fallback for blur: set --bg-url to a dark transparent color
    blurWrapper.style.setProperty("--bg-url", `linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8))`);
  }

  blurWrapper.appendChild(mediaContainer);
  item.appendChild(blurWrapper);
  inner.appendChild(item);
});

    carousel.appendChild(inner);
    mediaWrapper.appendChild(carousel);

    // --- Modern counter ---
    const counter = document.createElement("div");
    counter.className = "carousel-counter position-absolute";
    counter.textContent = `1/${msg.media_url.length}`;
    mediaWrapper.appendChild(counter);

    // Prev/Next buttons
    const prevBtn = document.createElement("button");
    prevBtn.className = "carousel-control-prev";
    prevBtn.type = "button";
    prevBtn.setAttribute("data-bs-target", `#${carouselId}`);
    prevBtn.setAttribute("data-bs-slide", "prev");
    prevBtn.innerHTML = `<span class="carousel-control-prev-icon"></span>`;

    const nextBtn = document.createElement("button");
    nextBtn.className = "carousel-control-next";
    nextBtn.type = "button";
    nextBtn.setAttribute("data-bs-target", `#${carouselId}`);
    nextBtn.setAttribute("data-bs-slide", "next");
    nextBtn.innerHTML = `<span class="carousel-control-next-icon"></span>`;

    mediaWrapper.appendChild(prevBtn);
    mediaWrapper.appendChild(nextBtn);

    // Update counter on slide change
    carousel.addEventListener("slid.bs.carousel", () => {
      const activeIndex = Array.from(inner.children).findIndex(c => c.classList.contains("active"));
      counter.textContent = `${activeIndex + 1}/${msg.media_url.length}`;
    });
  }

  body.appendChild(mediaWrapper);
}

// if (msg.media_url && msg.media_url.length > 0) {
//   const mediaWrapper = document.createElement("div");
//   mediaWrapper.className = "post-thumbnail position-relative"; // allow overlay

//   const carouselId = `carousel-${msg.message_id}`;

//  if (msg.media_url.length === 1) {
//   const type = msg.media_type[0];
//   const itemWrapper = document.createElement("div");
//   itemWrapper.className = "blur-wrapper";

//   const mediaContainer = document.createElement("div");
//   mediaContainer.className = "media-container";

//   if (type === "image") {
//     const img = document.createElement("img");
//     img.src = msg.media_url[0];
//     img.className = "post-thumbnail-img";
//     mediaContainer.appendChild(img);

//     itemWrapper.style.setProperty("--bg-url", `url(${msg.media_url[0]})`);
//   } else if (type === "video") {
//     const video = document.createElement("video");
//     video.src = msg.media_url[0];
//     video.controls = true;
//     video.muted = true;
//     video.loop = true;
//     video.className = "post-thumbnail-video";
//     mediaContainer.appendChild(video);
//     observeVideo(video);

//     itemWrapper.style.background = "rgba(0,0,0,0.8)";
//   }

//   itemWrapper.appendChild(mediaContainer);
//   mediaWrapper.appendChild(itemWrapper);
// }
// else {
//     // --- Multiple files -> Bootstrap carousel ---
//     const carousel = document.createElement("div");
//     carousel.className = "carousel slide";
//     carousel.id = carouselId;
//     carousel.setAttribute("data-bs-ride", "carousel");
//     carousel.setAttribute("data-bs-interval", "8000");

//     const inner = document.createElement("div");
//     inner.className = "carousel-inner";

//     msg.media_url.forEach((url, index) => {
//   const item = document.createElement("div");
//   item.className = index === 0 ? "carousel-item active" : "carousel-item";

//   // Blur wrapper inside each item
//   const blurWrapper = document.createElement("div");
//   blurWrapper.className = "blur-wrapper";

//   // Media container
//   const mediaContainer = document.createElement("div");
//   mediaContainer.className = "media-container";

//   if (msg.media_type[index] === "image") {
//     const img = document.createElement("img");
//     img.src = url;
//     img.className = "post-thumbnail-img";
//     mediaContainer.appendChild(img);

//     // background for blur
//     blurWrapper.style.setProperty("--bg-url", `url(${url})`);
//   } else if (msg.media_type[index] === "video") {
//     const video = document.createElement("video");
//     video.src = url;
//     video.controls = true;
//     video.muted = true;
//     video.loop = true;
//     video.className = "post-thumbnail-video";
//     mediaContainer.appendChild(video);
//     observeVideo(video);

//     // fallback blur (black bg)
//     blurWrapper.style.background = "rgba(0,0,0,0.8)";
//   }

//   blurWrapper.appendChild(mediaContainer);
//   item.appendChild(blurWrapper);
//   inner.appendChild(item);
// });


//     carousel.appendChild(inner);
//     mediaWrapper.appendChild(carousel);

//     // --- Modern counter ---
//     const counter = document.createElement("div");
//     counter.className = "carousel-counter position-absolute";
//     counter.textContent = `1/${msg.media_url.length}`;
//     mediaWrapper.appendChild(counter);

//     // Prev/Next buttons
//     const prevBtn = document.createElement("button");
//     prevBtn.className = "carousel-control-prev";
//     prevBtn.type = "button";
//     prevBtn.setAttribute("data-bs-target", `#${carouselId}`);
//     prevBtn.setAttribute("data-bs-slide", "prev");
//     prevBtn.innerHTML = `<span class="carousel-control-prev-icon"></span>`;

//     const nextBtn = document.createElement("button");
//     nextBtn.className = "carousel-control-next";
//     nextBtn.type = "button";
//     nextBtn.setAttribute("data-bs-target", `#${carouselId}`);
//     nextBtn.setAttribute("data-bs-slide", "next");
//     nextBtn.innerHTML = `<span class="carousel-control-next-icon"></span>`;

//     mediaWrapper.appendChild(prevBtn);
//     mediaWrapper.appendChild(nextBtn);

//     // Update counter on slide change
//     carousel.addEventListener("slid.bs.carousel", () => {
//       const activeIndex = Array.from(inner.children).findIndex(c => c.classList.contains("active"));
//       counter.textContent = `${activeIndex + 1}/${msg.media_url.length}`;
//     });
//   }

//   body.appendChild(mediaWrapper);
// }

// --- VIDEO OBSERVER ---
// Autoplay when visible, pause when out of view

// const observer = new IntersectionObserver((entries) => {
//   entries.forEach(entry => {
//     const video = entry.target;
//     if (entry.isIntersecting) {
//       video.play().catch(() => {});
//     } else {
//       video.pause();
//     }
//   });
// }, { threshold: 0.5 });

// function observeVideo(video) {
//   observer.observe(video);
// }





  // Like / comment / repost counts
  const counts = document.createElement("div");
  counts.className = "post-media-count";
  counts.innerHTML = `
    <div>
      <p><span class="post-like-count">${msg.like_count || 0}</span> Likes</p>
    </div>
    <div class="post-media-count-child-right">
      <p><span class="post-comment-count">${msg.comment_count || 0}</span> comments</p>
      <p><span class="post-repost-count">${msg.repost_count || 0}</span> reposts</p>
    </div>
  `;
  body.appendChild(counts);

  // --- BUTTONS ---
  const btnRow = document.createElement("div");
  btnRow.className = "post-media-button";

  // Like btn
  const likeBtn = document.createElement("button");
  likeBtn.className = "likeBtn media-btn";
  likeBtn.dataset.id = msg.message_id;
  likeBtn.innerHTML = `<i class="fa-solid fa-heart"></i> <span>Like</span>`;

  // Comment btn
  const commentBtn = document.createElement("button");
  commentBtn.className = "commentBtn media-btn";
  commentBtn.dataset.id = msg.message_id;
  commentBtn.innerHTML = `<i class="fa-solid fa-comment"></i> <span>Comment</span>`;
  commentBtn.onclick = () => {
    window.location.href = `aboutPost.html?post_id=${msg.message_id}`;
  };

  // Repost btn
  const repostBtn = document.createElement("button");
  repostBtn.className = "repostBtn media-btn";
  repostBtn.dataset.id = msg.message_id;
  repostBtn.innerHTML = `<i class="fa-solid fa-share-from-square"></i> <span>Repost</span>`;

  btnRow.appendChild(likeBtn);
  btnRow.appendChild(commentBtn);
  btnRow.appendChild(repostBtn);

  body.appendChild(btnRow);

  // Append together
  div.appendChild(header);
  div.appendChild(body);
  document.getElementById("message-container").prepend(div);

  // === Attach like toggle logic ===
  const likeIcon = likeBtn.querySelector("i");
  const likeCount = counts.querySelector(".post-like-count");
  loadLikeInfoForMessage(msg.message_id, likeIcon, likeCount);
  likeBtn.onclick = async () => {
    await toggleLikeActivityForMessage(msg.message_id, likeIcon, likeCount);
  };

  // === Dropdown click handlers ===
  dropdownMenu.querySelectorAll("a").forEach((item) => {
    item.addEventListener("click", (e) => {
      e.preventDefault();
      if (item.classList.contains("edit-option")) {
        editingMessageId = msg.message_id;
        editInput.value = msg.message;
        editToast.show();
      } else if (item.classList.contains("delete-option")) {
        deletingMessageId = msg.message_id;
        deleteToast.show();
      } else if (item.classList.contains("report-option")) {
        reportingTargetId = msg.message_id;
        reportToast.show();
      }
    });
  });
}


// ====== LIKE FUNCTIONS ======
async function loadLikeInfoForMessage(messageId, likeIcon, likeCount) {
  try {
    const res = await fetch(`${API_URL}/api/communityPostLike/status/${messageId}`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (!res.ok) throw new Error("Failed to fetch like status");

    const data = await res.json();
    likeCount.textContent = data.post.like_count;
    likeIcon.style.color = data.userStatus.liked ? "red" : "gray";
  } catch (err) {
    console.error(err);
  }
}

async function toggleLikeActivityForMessage(messageId, likeIcon, likeCount) {
  try {
    const res = await fetch(`${API_URL}/api/communityPostLike/like/${messageId}`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });
    if (!res.ok) throw new Error("Failed to toggle like");

    const data = await res.json();
    likeIcon.style.color = data.liked ? "red" : "gray";
    await loadLikeInfoForMessage(messageId, likeIcon, likeCount);
  } catch (err) {
    console.error(err);
  }
}

// ====== EDIT  Fetch======
document.getElementById("saveEditBtn").onclick = async () => {
  const newText = editInput.value.trim();
  if (!newText || !editingMessageId) return;
  try {
    await fetch(`${API_URL}/api/community/edit`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ message_id: editingMessageId, newText })
    });
    socket.emit("edit-message", { message_id: editingMessageId, newText });
    editToast.hide();
    editingMessageId = null;
  } catch (err) {
    console.error(err);
  }
};

// ====== DELETE Fetch ======
document.getElementById("confirmDeleteBtn").onclick = async () => {
  if (!deletingMessageId) return;
  try {
    await fetch(`${API_URL}/api/community/delete`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ message_id: deletingMessageId })
    });
    socket.emit("delete-message", { message_id: deletingMessageId });
    deleteToast.hide();
    deletingMessageId = null;
  } catch (err) {
    console.error(err);
  }
};

// ====== REPORT Fetch======
document.getElementById("submitReportBtn").onclick = async () => {
  const reasonTxt = reportReasonInput.value.trim();
  if (!reasonTxt || !reportingTargetId) return;

  try {
    const res = await fetch(`${API_URL}/api/community/report`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        reasonTxt,
        reportTypeFrom_id: reportingTargetId
      })
    });

    if (!res.ok) throw new Error("Failed to submit report");

    const data = await res.json();
    alert(data.message);
    reportToast.hide();
    reportingTargetId = null;
    reportReasonInput.value = "";
  } catch (err) {
    console.error("Report error:", err);
  }
};

 // Post toast
  const postToast = new bootstrap.Toast(document.getElementById("PostToast"), { autohide: false });
  const searchBtn = document.getElementById("searchButton");

  searchBtn.addEventListener("click", () => {
    postToast.show();
  });

  document.getElementById("cancelPostBtn").onclick = () => {
    postToast.hide();
    messageInput.value = "";
    mediaInput.value = "";
    mediaPreview.innerHTML = "";
    feelingInput.value = "";
    selectedFile = null;
    displayFeeling.textContent = "";
  };

  

// ====== CANCEL BUTTONS ======


// cancel edit btn
document.getElementById("cancelEditBtn").onclick = () => {
  editingMessageId = null;
  editToast.hide();
};


// cancel delete btn
document.getElementById("cancelDeleteBtn").onclick = () => {
  deletingMessageId = null;
  deleteToast.hide();
};

// cancel report btn
document.getElementById("cancelReportBtn").onclick = () => {
  reportingTargetId = null;
  reportReasonInput.value = "";
  reportToast.hide();
};



    // Cancel button
    document.getElementById("cancelFeelingBtn").onclick = () => {
      FeelingToast.hide();
      displayFeeling.textContent = "";
      feelingInput.value = "";
    };
</script>
</body>
</html>
