<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Update Book</title>
  <link rel="stylesheet" href="../assets/css/uploadBook/update.css">
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin:0; padding:0; }
    .containerx { max-width: 900px; margin: 50px auto; }
    .card { background: #fff; border-radius: 8px; padding: 20px; }
    .form-section { margin-bottom: 20px; }
    .form-label { font-weight: 600; margin-bottom: 5px; display:block; }
    input, select, textarea { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    .file-preview { width: 150px; height: 200px; border: 1px dashed #ccc; display: flex; align-items:center; justify-content:center; margin-bottom:10px; }
    .file-preview img, .file-preview iframe { max-width: 100%; max-height: 100%; }
    button { padding: 10px 15px; border:none; border-radius: 5px; cursor:pointer; margin-right:10px; }
    .btn-success { background: #4CAF50; color: #fff; }
    .btn-danger { background: #f44336; color: #fff; }
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .toggle-switch input { opacity: 0; width:0; height:0; }
    .toggle-switch label { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#ccc; border-radius: 34px; transition:.4s; }
    .toggle-switch label:before { position:absolute; content:""; height:20px; width:20px; left:2px; bottom:2px; background:white; transition:.4s; border-radius:50%; }
    .toggle-switch input:checked + label { background: #4CAF50; }
    .toggle-switch input:checked + label:before { transform: translateX(26px); }
     .form-section {
       width: 35%;
      padding: 10px;
      border-radius: 5px;
      
      align-items: start;
     justify-content: start;
      border: 1px dashed gray;
      margin-bottom: 10px;
       height: auto;
       display: inline-block; /* or block if you want them stacked */
      vertical-align: top; 
    
    }
    .is-invalid-section{
      border: 1px dashed rgb(255, 4, 4);
    }

    #filePreview{
      width: 100%;
       height: 550px;
      margin: auto;
 
    }
    
    #coverPreview{
      width: 100%;
      height: 550px;
      margin: auto;
 
    }
    .rows{
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        
  align-items: flex-start;
        justify-content: center;
        gap: 10px;
        height: auto;
        flex-direction: row;
    }
    .rowb{
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        padding: 0px;
       
        align-items: flex-start;
        gap: 10px;
        margin: 0px auto;
        height: auto;
        flex-direction: row;
    }
    .btn-success-soft, .btn-danger-soft{
        width: 60px;
        height: 40px;
       
       
    }
  

    .square{
      height: auto;
        display: inline-block; 
      width: 100%;
      background-color: #fff;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 100px;
      color: rgba(208, 212, 217, 0.5);
      position: relative;
    }
    .square img {
      width: 100%;
      height:auto;
      display: none; /* hidden until upload */
    }
     .squares {
      height: auto;
      width: 100%;
        display: inline-block; 
      background-color: #fff;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 100px;
      color: rgba(208, 212, 217, 0.5);
      overflow: hidden;
      position: relative;
    }

    .squares img {
      width: 100%;
      height: 100%;
   
      display: none; /* hidden until upload */
    }

    .text-center {
      text-align: center;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      margin: 5px;
    }

    .btn-success-soft {
      color: #28a745;
      background-color: rgba(40, 167, 69, 0.1);
    }

    .btn-danger-soft {
      color: #dc3545;
      background-color: rgba(220, 53, 69, 0.1);
    }

    .btn-primary {
      color: white;
     
      margin: auto;
      width: 100%;
    }

    .btn-danger {
      color: white;
     
    }

    .actions {
      text-align: right;
      margin-top: 20px;
    }

  </style>
</head>
<body>
  <div class="containerx">
    <div class="card">
      <h2>Update Book</h2>
      <form id="updateBookForm">

        <!-- File Uploads -->
           <div class="step-section active fileInput" id="step-1">
          <h5 class="mb-3">Upload Book file and Cover</h5>
          <div class="rows ">
              <div class="form-section">
                  <label class="form-label">Book File</label>
                  <div class="text-center">
                          <div class="squares" id="BookFileBox">
                          <span id="filePlaceholder"><i class="fa-solid fa-file"></i></span>
                          <iframe id="filePreview" style="display:none;" frameborder="0"></iframe>
                          </div>
                          <div class="rowb">
                              <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt,.epub" hidden required>
                              <label class="btn btn-success-soft" for="fileInput"><i class="fa-solid fa-file-import"></i></label>
                          </div>
                  </div>
              </div>
              <div class="form-section">
              <label class="form-label">Book Cover</label>
                  <div class="text-center">
                        <div class="square" id="coverBox">
                        <span id="coverPlaceholder"><i class="fa-solid fa-file-image"></i></span>
                        <img id="coverPreview" alt="Cover Preview" style="display:none;">
                        </div>
                        <div class="rowb">
                            <input type="file" id="coverInput" accept="image/*" hidden required>
                            <label class="btn btn-success-soft" for="coverInput"><i class="fa-solid fa-file-import"></i></label>
                        </div>
                  </div>
              </div>
          </div>
      </div>

        <!-- Basic Info -->
        <div class="form-section">
          <label class="form-label">Title</label>
          <input type="text" id="title" required>
        </div>

        <div class="form-section">
          <label class="form-label">Subtitle</label>
          <input type="text" id="subtitle">
        </div>

        <div class="form-section">
          <label class="form-label">Summary</label>
          <textarea id="summary" rows="3" required></textarea>
        </div>

 <!-- Author Section -->
<div class="form-section">
  <label class="form-label">Authors</label>
  <div id="authorInputs" class="d-flex flex-column gap-2"></div>

  <!-- Hidden JSON fields for backend -->
  <textarea id="authorName" class="form-control" style="display:none;"></textarea>
  <textarea id="authorId" class="form-control" style="display:none;"></textarea>
</div>

        <!-- More Details -->
        <div class="form-section">
          <label class="form-label">Category</label>
          <select id="category" required>
            <option value="">Select Category</option>
            <option value="Fiction">Fiction</option>
            <option value="Fantasy">Fantasy</option>
            <option value="ScienceFiction">Science Fiction</option>
            <option value="Mystery">Mystery / Thriller</option>
            <option value="Romance">Romance</option>
            <option value="HistoricalFiction">Historical Fiction</option>
            <option value="Horror">Horror</option>
            <option value="Adventure">Adventure</option>
            <option value="Biography">Biography</option>
            <option value="Memoir">Memoir</option>
            <option value="SelfHelp">Self-Help</option>
            <option value="Business">Business</option>
            <option value="Finance">Finance</option>
            <option value="History">History</option>
            <option value="Science">Science</option>
            <option value="Health">Health</option>
            <option value="Travel">Travel</option>
            <option value="Cookbook">Cookbook</option>
            <option value="Textbook">Textbook</option>
            <option value="Lecture">Lecture</option>
            <option value="CaseStudy">Case Study</option>
            <option value="Research">Research</option>
            <option value="Reference">Reference</option>
            <option value="Essay">Essay Collection</option>
            <option value="Poetry">Poetry</option>
            <option value="Art">Art</option>
            <option value="Comics">Comics</option>
            <option value="Children">Children</option>
            <option value="YoungAdult">Young Adult</option>
          </select>
        </div>

        <div class="form-section">
          <label class="form-label">Genre</label>
          <input type="text" id="genre">
        </div>

        <div class="form-section">
          <label class="form-label">Language</label>
          <select id="language" required>
            <option value="">Select Language</option>
            <option value="English">English</option>
            <option value="French">French</option>
            <option value="Spanish">Spanish</option>
            <option value="German">German</option>
            <option value="Japanese">Japanese</option>
            <option value="Chinese">Chinese</option>
            <option value="Khmer">Khmer</option>
            <option value="Thai">Thai</option>
            <option value="Korean">Korean</option>
            <option value="Indonesian">Indonesian</option>
            <option value="Portuguese">Portuguese</option>
            <option value="Russian">Russian</option>
            <option value="Turkish">Turkish</option>
            <option value="Vietnamese">Vietnamese</option>
            <option value="Arabic">Arabic</option>
            <option value="Hindi">Hindi</option>
            <option value="Italian">Italian</option>
          </select>
        </div>

        <div class="form-section">
          <label class="form-label">Page Count</label>
          <input type="number" id="pageCount">
        </div>

        <!-- Final Details -->
        <div class="form-section">
          <label class="form-label">ISBN-10</label>
          <input type="number" id="isbn10">
        </div>

        <div class="form-section">
          <label class="form-label">ISBN-13</label>
          <input type="number" id="isbn13">
        </div>

        <div class="form-section">
          <label class="form-label">Published Date</label>
          <input type="date" id="publishedDate">
        </div>

        <div class="form-section">
          <label class="form-label">Publisher</label>
          <input type="text" id="publisher">
        </div>

        <!-- Privacy toggles -->
        <div class="form-section">
          <label class="form-label">Comment</label>
          <div class="toggle-switch">
            <input type="checkbox" id="comment"><label for="comment"></label>
          </div>
        </div>
        <div class="form-section">
          <label class="form-label">Download</label>
          <div class="toggle-switch">
            <input type="checkbox" id="download"><label for="download"></label>
          </div>
        </div>
        <div class="form-section">
          <label class="form-label">Share</label>
          <div class="toggle-switch">
            <input type="checkbox" id="share"><label for="share"></label>
          </div>
        </div>
        <div class="form-section">
          <label class="form-label">Allow other author with full control</label>
          <div class="toggle-switch">
            <input type="checkbox" id="full-control"><label for="full-control"></label>
          </div>
        </div>

        <button type="button" class="btn btn-success" id="updateBtn">Update Book</button>
      </form>
    </div>
  </div>

<script src="../assets/js/jquery.js"></script>
<script>
$(document).ready(function(){

  const authorInputsContainer = $('#authorInputs');
  const authorNameTextarea = $('#authorName');
  const authorIdTextarea = $('#authorId');
  const urlParams = new URLSearchParams(window.location.search);
  const bookQid = urlParams.get('bookQid');

  if (!bookQid) {
    alert("Book ID is missing!");
    return;
  }

  // 🧩 Helper: Render author rows dynamically
  function renderAuthors(authors = [], authorIds = []) {
    authorInputsContainer.empty();
    const count = Math.max(authors.length, authorIds.length);

    for (let i = 0; i < count; i++) {
      const nameVal = authors[i] || '';
      const idVal = authorIds[i] || '';
      const row = $(`
        <div class="row g-2 align-items-center author-row mb-2">
          <div class="col-md-5">
            <input type="text" class="form-control author-name" placeholder="Author ${i + 1} Name" value="${nameVal}">
          </div>
          <div class="col-md-5">
            <input type="text" class="form-control author-id" placeholder="Author ${i + 1} ID" value="${idVal}">
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm remove-author">Remove</button>
          </div>
        </div>
      `);
      authorInputsContainer.append(row);
    }

    // Add “Add Author” button if fewer than 5 authors
    if (count < 5) {
      authorInputsContainer.append(`
        <button type="button" class="btn btn-primary btn-sm mt-2" id="addAuthorBtn">+ Add Author</button>
      `);
    }
  }

  // 🧩 Remove author row
  authorInputsContainer.on('click', '.remove-author', function(){
    $(this).closest('.author-row').remove();
  });

  // 🧩 Add author row
  authorInputsContainer.on('click', '#addAuthorBtn', function(){
    const rowCount = $('.author-row').length;
    if (rowCount >= 5) return alert("Maximum 5 authors allowed!");
    renderAuthors(
      $('.author-name').map((i, el) => $(el).val()).get(),
      $('.author-id').map((i, el) => $(el).val()).get()
    );
  });

  // 🧩 Sync author inputs → textarea before submit
  function syncAuthorsToTextarea() {
    const names = $('.author-name').map((i, el) => $(el).val().trim()).get();
    const ids = $('.author-id').map((i, el) => $(el).val().trim()).get();

    authorNameTextarea.val(JSON.stringify(names));
    authorIdTextarea.val(JSON.stringify(ids));
  }

  // 🧩 Fetch existing data
  $.ajax({
    url: `https://thebooksourcings.onrender.com/api/getBookByQid/${bookQid}`,
    type: 'GET',
    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
    success: function(data) {
      if (!data) return;

      // --- Basic info fill ---
      $('#title').val(data.title);
      $('#subtitle').val(data.subTitle);
      $('#summary').val(data.summary);
      $('#genre').val(data.genre);
      $('#pageCount').val(data.pageCount);
      $('#isbn10').val(data.ISBN10);
      $('#isbn13').val(data.ISBN13);
      $('#publisher').val(data.publisher);
      $('#category').val(data.mainCategory);
      $('#language').val(data.language);
      $('#comment').prop('checked', data.comment === 'active');
      $('#download').prop('checked', data.download === 'active');
      $('#share').prop('checked', data.share === 'active');
      $('#full-control').prop('checked', data.fullController === 'active');

      if (data.publishDate) {
        const date = new Date(data.publishDate);
        $('#publishedDate').val(date.toISOString().split('T')[0]);
      }

      // --- Author section ---
      let authorArr = [];
      let authorIdArr = [];

      try {
        authorArr = JSON.parse(data.author || "[]");
        authorIdArr = JSON.parse(data.authorId || "[]");
      } catch (e) {
        console.error("Invalid JSON in author fields:", e);
      }

      authorNameTextarea.val(JSON.stringify(authorArr));
      authorIdTextarea.val(JSON.stringify(authorIdArr));
      renderAuthors(authorArr, authorIdArr);

      // --- File & cover ---
      if (data.bookCover) $('#coverPreview').attr('src', data.bookCover).show();
      if (data.bookFile) $('#filePreview').attr('src', data.bookFile).show();
    },
    error: function(err) {
      console.error("Error fetching book:", err);
    }
  });

  // 🧩 Update Book
  $('#updateBtn').click(function() {
    syncAuthorsToTextarea();

    const formData = new FormData();
    formData.append('title', $('#title').val());
    formData.append('subTitle', $('#subtitle').val());
    formData.append('summary', $('#summary').val());
    formData.append('author', $('#authorName').val());
    formData.append('authorId', $('#authorId').val());
    formData.append('genre', $('#genre').val());
    formData.append('pageCount', $('#pageCount').val());
    formData.append('ISBN10', $('#isbn10').val());
    formData.append('ISBN13', $('#isbn13').val());
    formData.append('publisher', $('#publisher').val());
    formData.append('publishDate', $('#publishedDate').val());
    formData.append('mainCategory', $('#category').val());
    formData.append('language', $('#language').val());
    formData.append('comment', $('#comment').is(':checked') ? 'active' : 'inactive');
    formData.append('download', $('#download').is(':checked') ? 'active' : 'inactive');
    formData.append('share', $('#share').is(':checked') ? 'active' : 'inactive');
    formData.append('fullController', $('#full-control').is(':checked') ? 'active' : 'inactive');

    const fileInput = $('#fileInput')[0];
    const coverInput = $('#coverInput')[0];
    if (fileInput.files[0]) formData.append('bookFile', fileInput.files[0]);
    if (coverInput.files[0]) formData.append('bookCover', coverInput.files[0]);

    $.ajax({
      url: `https://thebooksourcings.onrender.com/api/getMyBooks/updateBook/${bookQid}`,
      method: 'PUT',
      headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
      data: formData,
      processData: false,
      contentType: false,
      success: function(res) {
        alert("✅ Book updated successfully!");
        location.reload();
      },
      error: function(err) {
        console.error("Error updating book:", err);

        // Backend permission message handler
        if (err.status === 403 && err.responseJSON?.message) {
          alert("⚠️ " + err.responseJSON.message);
        } else if (err.responseJSON?.message) {
          alert("❌ " + err.responseJSON.message);
        } else {
          alert("❌ Failed to update book. Please try again later.");
        }
      }

      // error: function(err) {
      //   console.error("Error updating book:", err);
      //   alert("❌ Failed to update book.");
      // }
    });
  });

});
</script>

</body>
</html>
