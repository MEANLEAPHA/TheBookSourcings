<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Chat</title>
        <script src="https://kit.fontawesome.com/ec7a51a641.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://kit.fontawesome.com/ec7a51a641.js" crossorigin="anonymous"></script>
        <style>
            body{
                background-color: var(--background-color);
                margin: 0;
                padding: 0;
            }
            :root{
                --background-color:white;
                --primary-color:#275791;
                --secondary-color: gainsboro;
                --font-color:rgb(65, 65, 65);
            }
            .dark-theme{
                --background-color:rgb(32, 32, 32);
                --primary-color:#275791;
                --secondary-color: rgba(220, 220, 220, 0.318);
                --font-color:rgb(255, 255, 255);
            }
            .toast{
                display: none;
            }
            #chat-container{
                width: 90%;
                height:99vh;
                margin:3px auto;
                color: var(--font-color);
                border: 1px solid var(--secondary-color);
              
            }
            #chat-container .chat-container-header{
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: start;
                gap: 5px;
                height: 9.8%;
                border-bottom: 1px solid var(--secondary-color);
            }
            .chat-container-body{
                width: 100%;
                height: 90%;
                display: flex;
            }
            #userList{
                width: 30%;
                height: 100%;
                border-right: 1px solid var(--secondary-color);
            }
            .type-of-chat{
                width: 100%;
                height: auto;
                display: flex;
                justify-content: center;
            }
            .btn-type{
                background:none;
                border: none;
                width: calc(100%/3.1);
                color: var(--font-color);
                padding: 12px 5px 12px 5px;
            }
            .btn-type:hover{
                background-color: var(--secondary-color);
            }
            .search-user{
                width: 95%;
                box-shadow: 0px 0px 3px rgba(175, 175, 175, 0.789);
                margin: auto;
                height: auto;
                display: flex;
                align-items: center;
                padding: 5px;
                border-radius: 10px;
            }
            #searchUserTBS{
                width: 95%;
                padding: 3px 0px 3px 0px;
                border: none;
                background: none;
            }
            .search-user:hover{
                box-shadow: 0px 0px 3px var(--primary-color);
            }
            #searchUserTBS:focus{
                outline: none;
            }
            #roomList{
                height: 86%;
                padding: 10px;
                overflow-y: scroll;
                scrollbar-width: none;
            }
            /* Show scrollbar on hover */
            #roomList:hover {
                scrollbar-width: thin; /* Firefox */
            }
            /* Chrome, Edge, Safari */
            #roomList::-webkit-scrollbar {
                width: 0px; /* Hide by default */
            }
            #roomList:hover::-webkit-scrollbar {
                width: 5px; /* Show on hover */
            }
            #roomList::-webkit-scrollbar-thumb {
                background-color:var(--primary-color);
                border-radius: 4px;
            }
            #chatContent{
                width: 70%;
                height: 100%;
            }


           
        </style>
    </head>
    <body>
        <div id="chat-container">
            <div class="chat-container-header">
                <img src="dog.png"  class="userPf">
                <div class="userDetails">
                    <p>Chat</p>
                </div>
            </div>
            <div class="chat-container-body" >
                <div id="userList">
                        <div id="searchUser">
                            <div class="type-of-chat">
                                <button onclick="" id="type-friend" class="btn-type"><i class="fa-solid fa-user-group"></i></button>
                                <button onclick="" id="type-order" class="btn-type"><i class="fa-solid fa-cart-shopping"></i></button>
                                <button onclick="" id="type-archive" class="btn-type"><i class="fa-solid fa-box-archive"></i></button>
                            </div>
                            <div class="search-user">
                                <input type="text" placeholder="Search" id="searchUserTBS">
                                <i class="fa-solid fa-magnifying-glass" id="searchUserIcon"></i>
                            </div>
                        </div>
                        <div id="roomList">
dd
                        </div>
                </div>
                <div id="chatContent">

                </div>
            </div>
        </div>
            <!-- Edit/Delete Toast -->
        <div id="editDeleteToast" class="toast">
        <button id="editBtn">Edit</button>
        <button id="deleteBtn">Delete</button>
        <button id="closeToast">Cancel</button>
        </div>

            <!-- Edit Message Toast -->
        <div id="editMessageToast" class="toast">
        <input type="text" id="editInput" style="width: 80%" />
        <button id="submitEdit">Save</button>
        <button id="cancelEdit">Cancel</button>
        </div>

            <!-- Delete Confirmation Toast -->
        <div id="deleteMessageToast" class="toast">
        <p>Are you sure you want to delete this message?</p>
        <button id="confirmDelete">Yes</button>
        <button id="cancelDelete">Cancel</button>
        </div>

   <script>
  // === AUTH CHECK ===
  const token = localStorage.getItem("token");
  if (!token) {
    alert("Login required");
    window.location.href = "/login.html";
  }

  const currentUser = JSON.parse(atob(token.split(".")[1])).memberQid;
  const socket = io("https://thebooksourcings.onrender.com", {
    auth: { token },
    transports: ["websocket"],
  });

  const roomList = document.getElementById("roomList");
  const chatContent = document.getElementById("chatContent");
  let activeRoomId = null;
  let activeType = "friend"; // default type

  // === TYPE BUTTONS (friend/order/archive) ===
  const typeButtons = {
    friend: document.getElementById("type-friend"),
    order: document.getElementById("type-order"),
    archive: document.getElementById("type-archive"),
  };

  Object.entries(typeButtons).forEach(([type, btn]) => {
    btn.addEventListener("click", () => {
      Object.values(typeButtons).forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      activeType = type;
      loadChatRooms(type);
      chatContent.innerHTML = ""; // clear old messages
    });
  });

  // === LOAD CHAT ROOMS ===
  async function loadChatRooms(type = "friend") {
    try {
      roomList.innerHTML = `<p class='loading'>Loading...</p>`;
      const res = await axios.get(
        `https://thebooksourcings.onrender.com/api/chat/rooms?type=${type}`,
        { headers: { Authorization: `Bearer ${token}` } }
      );
      const rooms = res.data.rooms || [];
      roomList.innerHTML = "";

      if (!rooms.length) {
        roomList.innerHTML = `<p class='no-room'>No ${type} chats yet.</p>`;
        return;
      }

      rooms.forEach((room) => {
        const div = document.createElement("div");
        div.className = "room-item";
        div.innerHTML = `
          <img src="${room.otherProfileImg || "default.png"}" class="room-avatar">
          <div class="room-info">
            <p class="room-name">${room.otherUsername}</p>
            <p class="room-last">${room.lastMessage || "No messages yet"}</p>
          </div>
        `;
        div.addEventListener("click", () => openRoom(room.roomId));
        roomList.appendChild(div);
      });
    } catch (err) {
      console.error("Failed to load chat rooms:", err);
      roomList.innerHTML = `<p class='error'>Error loading rooms</p>`;
    }
  }

  // === OPEN CHAT ROOM ===
  async function openRoom(roomId) {
    activeRoomId = roomId;
    chatContent.innerHTML = `
      <div id="chatBox" class="chat-box"></div>
      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Type a message..." />
        <button id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    `;

    const chatBox = document.getElementById("chatBox");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    socket.emit("joinRoom", roomId);

    try {
      const res = await axios.get(
        `https://thebooksourcings.onrender.com/api/chat/${roomId}`,
        { headers: { Authorization: `Bearer ${token}` } }
      );
      const messages = res.data.messages || [];
      chatBox.innerHTML = "";

      messages.forEach((msg) => appendMessage(msg, msg.senderQid === currentUser));
      chatBox.scrollTop = chatBox.scrollHeight;

      socket.emit("markRoomSeen", { roomId });
    } catch (err) {
      console.error("Failed to load messages:", err);
    }

    sendBtn.onclick = () => {
      const text = messageInput.value.trim();
      if (!text) return;

      const tempId = "temp_" + Date.now();
      appendMessage(
        { messageId: tempId, message: text, senderQid: currentUser, status: "pending" },
        true
      );

      socket.emit("sendMessage", { roomId, message: text, tempId });
      messageInput.value = "";
    };
  }

  // === APPEND MESSAGE ===
  function appendMessage(msg, isMe = false) {
    const chatBox = document.getElementById("chatBox");
    if (!chatBox) return;

    const msgDiv = document.createElement("div");
    msgDiv.className = isMe ? "message me" : "message other";
    msgDiv.dataset.messageId = msg.messageId;

    const textSpan = document.createElement("span");
    textSpan.className = "message-text";
    textSpan.textContent = msg.message;
    msgDiv.appendChild(textSpan);

    // status icon (only show for self)
    if (isMe) {
      const status = document.createElement("span");
      status.className = "status";
      status.style.marginLeft = "6px";
      if (msg.status === "pending") status.innerHTML = `<i class="fa-solid fa-clock"></i>`;
      else if (msg.status === "sent") status.innerHTML = `<i class="fa-solid fa-check"></i>`;
      else if (msg.status === "delivered") status.innerHTML = `<i class="fa-solid fa-check-double"></i>`;
      else if (msg.status === "seen")
        status.innerHTML = `<i class="fa-solid fa-check-double" style="color:#0d6efd"></i>`;
      msgDiv.appendChild(status);

      const threeDots = document.createElement("span");
      threeDots.textContent = "⋮";
      threeDots.className = "three-dots";
      msgDiv.appendChild(threeDots);
      threeDots.addEventListener("click", () => showEditDeleteToast(msgDiv, msg.messageId));
    }

    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // === UPDATE MESSAGE STATUS ICON ===
  function updateMessageStatus(messageId, status) {
    const msgDiv = document.querySelector(`[data-message-id="${messageId}"]`);
    if (!msgDiv) return;
    const statusEl = msgDiv.querySelector(".status");
    if (!statusEl) return;

    if (status === "sent") statusEl.innerHTML = `<i class="fa-solid fa-check"></i>`;
    if (status === "delivered") statusEl.innerHTML = `<i class="fa-solid fa-check-double"></i>`;
    if (status === "seen")
      statusEl.innerHTML = `<i class="fa-solid fa-check-double" style="color:#0d6efd"></i>`;
  }

  // === SOCKET EVENTS ===
  socket.on("receiveMessage", (msg) => {
    const isMe = msg.senderQid === currentUser;
    appendMessage(msg, isMe);

    if (!isMe) {
      socket.emit("messageDelivered", { messageId: msg.messageId, roomId: msg.roomId });
      if (activeRoomId === msg.roomId && document.visibilityState === "visible") {
        socket.emit("markRoomSeen", { roomId: msg.roomId });
      }
    }
  });

  socket.on("messageSent", (msg) => {
    const { tempId } = msg || {};
    if (tempId) {
      const tempMsg = document.querySelector(`[data-message-id="${tempId}"]`);
      if (tempMsg) {
        tempMsg.dataset.messageId = msg.messageId;
        const statusEl = tempMsg.querySelector(".status");
        if (statusEl) statusEl.innerHTML = `<i class="fa-solid fa-check"></i>`;
        return;
      }
    }
    appendMessage(msg, msg.senderQid === currentUser);
  });

  socket.on("messageDelivered", ({ messageIds }) => {
    if (!Array.isArray(messageIds)) return;
    messageIds.forEach((id) => updateMessageStatus(id, "delivered"));
  });

  socket.on("messageEdited", (data) => {
    const msgDiv = document.querySelector(`[data-message-id="${data.messageId}"]`);
    if (msgDiv) msgDiv.querySelector(".message-text").textContent = data.newMessage;
  });

  socket.on("messageDeleted", (data) => {
    const msgDiv = document.querySelector(`[data-message-id="${data.messageId}"]`);
    if (msgDiv) msgDiv.remove();
  });

  socket.on("roomMessagesSeen", ({ messageIds }) => {
    if (!Array.isArray(messageIds)) return;
    messageIds.forEach((id) => updateMessageStatus(id, "seen"));
  });

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible" && activeRoomId) {
      socket.emit("markRoomSeen", { roomId: activeRoomId });
    }
  });

  // === TOAST HANDLERS ===
  function showEditDeleteToast(msgDiv, messageId) {
    const toast = document.getElementById("editDeleteToast");
    toast.style.display = "block";

    const editBtn = toast.querySelector("#editBtn");
    const deleteBtn = toast.querySelector("#deleteBtn");
    const closeBtn = toast.querySelector("#closeToast");

    editBtn.onclick = () => {
      toast.style.display = "none";
      showEditMessageToast(msgDiv, messageId);
    };
    deleteBtn.onclick = () => {
      toast.style.display = "none";
      showDeleteMessageToast(messageId);
    };
    closeBtn.onclick = () => {
      toast.style.display = "none";
    };
  }

  function showEditMessageToast(msgDiv, messageId) {
    const toast = document.getElementById("editMessageToast");
    const input = toast.querySelector("#editInput");
    const submit = toast.querySelector("#submitEdit");
    const cancel = toast.querySelector("#cancelEdit");

    input.value = msgDiv.querySelector(".message-text").textContent;
    toast.style.display = "block";

    submit.onclick = () => {
      const newMessage = input.value.trim();
      if (!newMessage) return;
      socket.emit("editMessage", { roomId: activeRoomId, messageId, newMessage });
      toast.style.display = "none";
    };
    cancel.onclick = () => (toast.style.display = "none");
  }

  function showDeleteMessageToast(messageId) {
    const toast = document.getElementById("deleteMessageToast");
    const confirm = toast.querySelector("#confirmDelete");
    const cancel = toast.querySelector("#cancelDelete");

    toast.style.display = "block";
    confirm.onclick = () => {
      socket.emit("deleteMessage", { roomId: activeRoomId, messageId });
      toast.style.display = "none";
    };
    cancel.onclick = () => (toast.style.display = "none");
  }

  // === INITIAL LOAD ===
  loadChatRooms(activeType);
</script>

    </body>
</html>