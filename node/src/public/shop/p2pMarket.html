<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>
        <script src="https://kit.fontawesome.com/ec7a51a641.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://kit.fontawesome.com/ec7a51a641.js" crossorigin="anonymous"></script>
        <link rel="icon" href="assets/img/ThebooksorucingsIcon-removebg-preview.png">
        <link rel="stylesheet" href="../components/ui/global.css">
      
    </head>
    <body>
        <header id="header">
            <div id="headerLeft"> 
                <i class="fa-solid fa-bars"></i>
                <a href="#top"><img src="../assets/img/TheBookSourcingLogo-removebg-preview.png" alt="RentWell-Logo" id="logo"></a>
            </div>
            <div id="headerMiddle">
                <input type="text" placeholder="Search" id="searchTBS">
                <i class="fa-solid fa-magnifying-glass" id="searchIcon"></i>
            </div>
            <div id="headerRight">
                <i class="fa-solid fa-magnifying-glass" id="searchIcons"></i>
                <div id="create">
                <a href="uploadSale.html" style="display: flex;align-items: center;gap: 5px;margin: 0;">
                    <div>Sell book</div>
                </a>
                </div>
                <i class="fa-solid fa-bell" id="liveNotiBtn"></i>
                <i class="fa-solid fa-paper-plane" id="liveChatBtn"></i>
                <img src="../assets/img/pf.jpg" class="userPf" alt="user" class="dropdown-item" style='color: rgb(60, 60, 60);font-family: "Reenie Beanie", cursive;font-weight: 599;font-size: large;' id="liveToastBtn">
            </div>
        </header>
        <div id="phoneSearch">
            <div id="phoneSearchLeft"><i class="fa-solid fa-arrow-left"></i></div>
            <div id="headerMiddle2">
                    <input type="text" placeholder="Search" id="searchTBS">
                    <i class="fa-solid fa-magnifying-glass" id="searchIcon"></i>
            </div>
        </div>
        <main>
            <div class="smallCollape">
                <ul>
                    <li><i class="fa-solid fa-house"></i></li>
                    <li><i class="fa-solid fa-newspaper"></i></li>
                    <li><i class="fa-solid fa-shop"></i></li>
                    <li><i class="fa-solid fa-users"></i></li>
                    <li><i class="fa-solid fa-gamepad"></i></li>
                    <li><i class="fa-solid fa-circle-user"></i></li>
                </ul>
            </div>
            <div class="collapse">
                <ul id="u1">    
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-house"></i>Home</a></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-newspaper"></i>Articles</a></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-shop"></i>Market Place</a></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-users"></i>Community</a></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-gamepad"></i>Games</a></li>
                </ul>
                <ul id="u2">    
                    <li class="liTop"><Big>You > </Big></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-clock-rotate-left"></i>History</a></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-lines-leaning"></i>Your Library</a></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-book"></i>Your Book</a></li>
                    <li><a href="userShop.html"><i class="fa-solid fa-dollar-sign"></i>Your Shop</a></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-bookmark"></i>Favorite</a></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-thumbs-up"></i>Liked</a></li>
                </ul>
                <ul id="u3">    
                    <li class="liTop"><Big>Following</Big></li>
                </ul>
                <div class="following">
                    <div class="followingChild"><img src="dog.png" class="followingPf"><p class="followingName">Golden Ramsy</p></div>
                    <div class="followingChild"><img src="dog.png" class="followingPf"><p class="followingName">Morgen Housel</p></div>
                    <div class="followingChild"><img src="dog.png" class="followingPf"><p class="followingName">Yuval Noah Harari</p></div>
                    <div class="followingChild"><img src="dog.png" class="followingPf"><p class="followingName">Meanleap Ha</p></div>
                    <div class="followingChild"><img src="dog.png" class="followingPf"><p class="followingName">Yuval Noah Harari</p></div>
                    <li id="allFollowing"><a href="userBook/yourBookTest.html"><i class="fa-solid fa-list"></i>All Following</a></li>
                    <li id="showMoreFollow"><a><i class="fa-solid fa-chevron-down"></i>Show More</a></li>
                    <li id="showLessFollow"><a><i class="fa-solid fa-chevron-up"></i>Show Less</a></li>
                </div>
                <ul id="u4">    
                    <li class="liTop"><Big>Explore</Big></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-masks-theater"></i>Novel</a></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-mask"></i>Comic Book</a></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-user-ninja"></i>Manga</a></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-lightbulb"></i>Literature</a></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-feather-pointed"></i>Poetry</a></li>
                </ul>
                <ul id="u5">    
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-gear"></i>Settings</a></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-flag"></i>Report</a></li>
                    <li><a href="userBook/yourBookTest.html"><i class="fa-solid fa-circle-question"></i>Help</a></li>
                    <li class="feedBackBtn2"><a href="userBook/yourBookTest.html"><i class="fa-solid fa-comment-dots"></i>Send Feedback</a></li>
                </ul>
                <ul id="uLast">
                    <li>About</li>
                    <li>Contact</li>
                    <li>Advertise</li>
                    <li>Terms</li>
                    <li>Privacy</li>
                    <li>Policy</li>
                </ul>
                <ul id="uLast2">
                    <li>
                    <a>
                        ¬© 2025 TheBookSourcing. All rights reserved
                    </a>
                    </li>
                </ul>
            </div>
            <div class="content">
                <!-- The filter option-->
                <div class="nav-wrapper">
                    <form id="filterForm" class="row g-3 align-items-center">
                        <!-- üí∞ Price Range -->
                        <div class="col-md-4 col-sm-6">
                            <div class="input-group">
                            <input
                                type="number"
                                id="priceMin"
                                class="form-control"
                                placeholder="Min Price"
                                min="0"
                            />
                            <span class="input-group-text">-</span>
                            <input
                                type="number"
                                id="priceMax"
                                class="form-control"
                                placeholder="Max Price"
                                min="0"
                            />
                            </div>
                        </div>

                        <!-- üè∑Ô∏è Sale Type -->
                         
                        <div class="col-md-2 col-sm-6">
                            <select id="saleType" class="form-select">
                            <option value="">All Sale Types</option>
                            <option value="normal">Normal Sale</option>
                            <option value="discount">Discount Sale</option>
                            <option value="free">Free</option>
                            </select>
                        </div>

                        <!-- üí∏ Discount Type -->
                        <div class="col-md-2 col-sm-6">
                            <select id="discountType" class="form-select">
                            <option value="">All Discounts</option>
                            <option value="percent">Percentage</option>
                            <option value="fixed">Fixed Price</option>
                            </select>
                        </div>

                        <!-- üßæ Book Type -->
                        <div class="col-md-2 col-sm-6">
                            <select id="bookType" class="form-select">
                            <option value="">All Book Types</option>
                            <option value="ebook">E-Book</option>
                            <option value="paper">Physical</option>
                            </select>
                        </div>

                        <!-- üéØ Apply Filter -->
                        <div class="col-md-1 col-sm-6 text-end">
                            <button type="submit" class="btn btn-primary w-100">
                            <i class="fa-solid fa-filter"></i>
                            </button>
                        </div>
                    </form>  
                </div>
                <!-- Sale book will display here  -->
                <div id="BookContent"></div>
            </div>
        </main>

    <!-- chat collape -->
    <div class="toast-container-chat ">
      <div id="liveChat" class="toast" role="alert" aria-live="assertive" aria-atomic="true" >
        <div class="toast-header-chat">
            <img src="dog.png"  class="userPf">
            <div class="userDetails">
              <p>Chat</p>
          </div>
        </div>
        <button id="liveChatClose"><i class="fa-solid fa-xmark"></i></button>
        <div class="toast-body-chat" >
           <div id="userList">
                <div id="searchUser">
                    <input type="text" placeholder="Search" id="searchUserTBS">
                    <i class="fa-solid fa-magnifying-glass" id="searchUserIcon"></i>
                </div>
                <div id="roomList">

                </div>
           </div>
           <div id="chatContent">

           </div>
        </div>
      </div>
    </div>

    <!-- Notication collape -->
    <div class="toast-container position-fixed  end-0 p-3">
      <div id="liveNoti" class="toast" role="alert" aria-live="assertive" aria-atomic="true" >
        <div class="toast-header">
            <img src="dog.png"  class="userPf">
            <div class="userDetails">
              <p>Noti</p>
          </div>
        </div>
    
        <div class="toast-body " >
          <a href="userSign/login.html"><i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Login</span></a>
        </div>
      </div>
    </div>

        <!-- account tool collapse -->
    <div class="toast-container position-fixed  end-0 p-3">
      <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" >
        <div class="toast-header">
            <img src="dog.png"  class="userPf">
            <div class="userDetails">
              <p>Name</p>
              <p>@Nickname</p>
              <a href="#" style="color: #275791;">View channel</a>
          </div>
        </div>
        <div class="toast-header">
          <a href="#"><i class="fa-solid fa-gear"></i> Settings</a>
        </div>
        <div class="toast-header" id="themeSwitchSection">
            <button class="theme-switch">
              <i class="fa-solid fa-sun"></i>
              <i class="fa-solid fa-moon"></i>
            </button>
            <p id="theme-switch-word" class="theme-switch">
              <span class="fa-sun-word" >Light mode</span>
              <span class="fa-moon-word" >Dark mode</span>
            </p>
        </div>
        <div class="toast-header">
          <a href="#"><i class="fa-solid fa-circle-question"></i> Help</a>
        </div>
        <div class="toast-header"  >
          <a class="feedBackBtn2"><i class="fa-solid fa-comment-dots"></i> Feedback</a>
        </div>
        <div class="toast-body " >
          <a href="userSign/login.html"><i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Login</span></a>
        </div>
      </div>
    </div>
    <!-- feedback collapse -->
    <div class="toast-containers w-500">
      <div id="liveToast2" class="toast" role="alert" aria-live="assertive" aria-atomic="true" >
        <div class="toast-header">
            <div>Send Feedback to TheBookSourcing</div>
            <button type="button" data-bs-target="#liveToast2" data-bs-dismiss="toast" aria-label="Close" id="btnCloseFBToast"><i class="fa-solid fa-arrow-right"></i></button>
        </div>
        <div class="toast-body">
          <form action="">
            <label> Please give us your feedback (required)</label>
            <input type="text" name="feedbackInput" required id="feedbackInput">
            <br>
            <br>
            <label >A screenshot will help us to understand more about your feedback (optional)</label>
            <br>
            <label class="custom-file">
              <input type="file" id="fileUpload">
              <span>  <i class="fa-solid fa-camera"></i> Capture screenshot</span>
            </label>
            <div>
              <img src="camera.png" id="screenshot" >
            </div>
            <br>
            <div id="allowEmailUpdate">
              <input type="checkbox" name="" id=""><label>We may email you for more updates</label>
            </div>
            <p id="smallWarning" ><i class="fa-solid fa-circle-exclamation text-warning" ></i> Please do not include any sensitive information! Sensitive information is any data that should be protected. Please do not include passwords, credit card numbers, or personal detail.</p>
            <button type="submit" id="feedbackSubmit" name="feedbackSubmit">Submit</button>
          </form>
        </div>
      </div>
    </div>
    <!-- Edit/Delete Toast -->
<div id="editDeleteToast" class="toast">
  <button id="editBtn">Edit</button>
  <button id="deleteBtn">Delete</button>
  <button id="closeToast">Cancel</button>
</div>

<!-- Edit Message Toast -->
<div id="editMessageToast" class="toast">
  <input type="text" id="editInput" style="width: 80%" />
  <button id="submitEdit">Save</button>
  <button id="cancelEdit">Cancel</button>
</div>

<!-- Delete Confirmation Toast -->
<div id="deleteMessageToast" class="toast">
  <p>Are you sure you want to delete this message?</p>
  <button id="confirmDelete">Yes</button>
  <button id="cancelDelete">Cancel</button>
</div>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
    const filterForm = document.getElementById("filterForm");
    const BookContent = document.getElementById("BookContent");

    // üåê API base (adjust path if needed)
    const API_URL = "https://thebooksourcings.onrender.com/api/shop/displaySaleBook";

    // üß© Fetch and display books
    async function fetchBooks(filters = {}) {
    try {
        const queryString = new URLSearchParams(filters).toString();
        const res = await fetch(`${API_URL}?${queryString}`);
        const data = await res.json();

        if (!data.Result || !data.books) {
        BookContent.innerHTML = `<p class="text-muted text-center mt-3">No books found.</p>`;
        return;
        }

        // üé® Render book cards
        renderBooks(data.books);
    } catch (err) {
        console.error("Error fetching books:", err);
        BookContent.innerHTML = `<p class="text-danger text-center mt-3">Failed to load books.</p>`;
    }
    }

    // üß± Render books in cards
    function renderBooks(books) {
    BookContent.innerHTML = books
        .map((book) => {
        const img = book.bookImg || (book.imgPreview?.[0] ?? "https://via.placeholder.com/150");
        const discountTag =
            book.discount_type && book.discount_price
            ? `<span class="badge bg-danger ms-2">${book.discount_type === "percent" ? `-${book.discount_price}%` : `-${book.discount_price}$`}</span>`
            : "";
        const saleType =
            book.sale_type === "free"
            ? `<span class="badge bg-success ms-2">Free</span>`
            : book.sale_type === "discount"
            ? `<span class="badge bg-warning text-dark ms-2">Discount</span>`
            : "";

        return `
            <div class="col-lg-3 col-md-4 col-sm-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="ratio ratio-1x1">
                <img src="${img}" class="card-img-top rounded-top" alt="${book.title}">
                </div>
                <div class="card-body">
                <h6 class="fw-bold text-truncate">${book.title || "Untitled"} ${discountTag} ${saleType}</h6>
                <p class="text-muted small mb-1">${book.book_type?.toUpperCase() || "Unknown Type"}</p>
                <p class="mb-0">
                    ${book.price ? `<span class="fw-bold text-primary">$${book.price}</span>` : ""}
                    ${book.original_price && book.original_price > book.price
                    ? `<small class="text-decoration-line-through text-muted ms-2">$${book.original_price}</small>`
                    : ""}
                </p>
                <button><a href='aboutSaleBook.html?bookSid=${book.bookSid}'>View Book</a></button>
                </div>
            </div>
            </div>
        `;
        })
        .join("");
    }

    // üßÆ Handle form submission
    filterForm.addEventListener("submit", (e) => {
    e.preventDefault();

    const filters = {
        minPrice: document.getElementById("priceMin").value,
        maxPrice: document.getElementById("priceMax").value,
        saleType: document.getElementById("saleType").value,
        discountType: document.getElementById("discountType").value,
        bookType: document.getElementById("bookType").value,
    };

    fetchBooks(filters);
    });

    // üöÄ Load all books on first load
    fetchBooks();
    });
    </script>
    <script src="../assets/js/index/chatAppToast.js"></script>
    <script src="../assets/js/index/darkmode.js" defer></script>
    <script src="../assets/js/index/collapseResponsive.js"></script>
    <script src="../assets/js/index/followingAcc.js"></script>
    <script src="../assets/js/index/accountToast.js"></script>
    <script src="../assets/js/index/navNewFeed.js"></script>
    <script src="../assets/js/index/feedbackToast.js"></script>
    <script src="../assets/js/index/headerSearch.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- room chat script -->
    <script>
const token = localStorage.getItem("token");
if (!token) {
  alert("Login required");
  window.location.href = "/login.html";
}

const currentUser = JSON.parse(atob(token.split('.')[1])).memberQid;
const socket = io("https://thebooksourcings.onrender.com", {
  auth: { token },
  transports: ["websocket"]
});

const roomList = document.getElementById("roomList");
const chatContent = document.getElementById("chatContent");
let activeRoomId = null;

// üîπ Load Chat Rooms
async function loadChatRooms() {
  try {
    const res = await axios.get("https://thebooksourcings.onrender.com/api/chat/rooms", {
      headers: { Authorization: `Bearer ${token}` }
    });
    const rooms = res.data.rooms || [];
    roomList.innerHTML = "";

    if (!rooms.length) {
      roomList.innerHTML = `<p class='no-room'>No chats yet.</p>`;
      return;
    }

    rooms.forEach(room => {
      const div = document.createElement("div");
      div.className = "room-item";
      div.innerHTML = `
        <img src="${room.otherProfileImg || 'default.png'}" class="room-avatar">
        <div class="room-info">
          <p class="room-name">${room.otherUsername}</p>
          <p class="room-last">${room.lastMessage || 'No messages yet'}</p>
        </div>
      `;
      div.addEventListener("click", () => openRoom(room.roomId));
      roomList.appendChild(div);
    });
  } catch (err) {
    console.error("Failed to load chat rooms:", err);
  }
}

// üîπ Load Messages of Selected Room
// üîπ Load Messages of Selected Room
async function openRoom(roomId) {
  activeRoomId = roomId;
  chatContent.innerHTML = `
    <div id="chatBox" class="chat-box"></div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Type a message..." />
      <button id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
  `;

  const chatBox = document.getElementById("chatBox");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");

  socket.emit("joinRoom", roomId);

  // Fetch and display chat history
  try {
    const res = await axios.get(`https://thebooksourcings.onrender.com/api/chat/${roomId}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const messages = res.data.messages || [];
    chatBox.innerHTML = "";

    messages.forEach(msg => appendMessage(msg, msg.senderQid === currentUser));
    chatBox.scrollTop = chatBox.scrollHeight;
  } catch (err) {
    console.error("Failed to load messages:", err);
  }

  // Send message
  sendBtn.onclick = () => {
    const text = messageInput.value.trim();
    if (!text) return;

    socket.emit("sendMessage", { roomId, message: text });
    messageInput.value = "";
  };
}

// üîπ Append message function with edit/delete UI
function appendMessage(msg, isMe = false) {
  const chatBox = document.getElementById("chatBox");
  if (!chatBox) return;

  const msgDiv = document.createElement("div");
  msgDiv.className = isMe ? "message me" : "message other";
  msgDiv.dataset.messageId = msg.messageId;

  const textSpan = document.createElement("span");
  textSpan.className = "message-text";
  textSpan.textContent = msg.message;
  msgDiv.appendChild(textSpan);

  // Only sender can edit/delete
  if (isMe) {
    const threeDots = document.createElement("span");
    threeDots.textContent = "‚ãÆ";
    threeDots.className = "three-dots";
    msgDiv.appendChild(threeDots);
    threeDots.addEventListener("click", () =>
      showEditDeleteToast(msgDiv, msg.messageId)
    );
  }

  chatBox.appendChild(msgDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// üîπ Real-time message receiving
socket.on("receiveMessage", (data) => {
  if (data.roomId === activeRoomId) {
    appendMessage(data, data.senderQid === currentUser);
  }
});

// üîπ Real-time message update/delete
socket.on("messageEdited", (data) => {
  const msgDiv = document.querySelector(`[data-message-id="${data.messageId}"]`);
  if (msgDiv) msgDiv.querySelector(".message-text").textContent = data.newMessage;
});

socket.on("messageDeleted", (data) => {
  const msgDiv = document.querySelector(`[data-message-id="${data.messageId}"]`);
  if (msgDiv) msgDiv.remove();
});

// ---------- Toast logic ----------
function showEditDeleteToast(msgDiv, messageId) {
  const toast = document.getElementById("editDeleteToast");
  toast.style.display = "block";

  const editBtn = toast.querySelector("#editBtn");
  const deleteBtn = toast.querySelector("#deleteBtn");
  const closeBtn = toast.querySelector("#closeToast");

  editBtn.onclick = () => {
    toast.style.display = "none";
    showEditMessageToast(msgDiv, messageId);
  };
  deleteBtn.onclick = () => {
    toast.style.display = "none";
    showDeleteMessageToast(messageId);
  };
  closeBtn.onclick = () => {
    toast.style.display = "none";
  };
}

function showEditMessageToast(msgDiv, messageId) {
  const toast = document.getElementById("editMessageToast");
  const input = toast.querySelector("#editInput");
  const submit = toast.querySelector("#submitEdit");
  const cancel = toast.querySelector("#cancelEdit");

  input.value = msgDiv.querySelector(".message-text").textContent;
  toast.style.display = "block";

  submit.onclick = () => {
    const newMessage = input.value.trim();
    if (!newMessage) return;
    socket.emit("editMessage", { roomId: activeRoomId, messageId, newMessage });
    toast.style.display = "none";
  };
  cancel.onclick = () => (toast.style.display = "none");
}

function showDeleteMessageToast(messageId) {
  const toast = document.getElementById("deleteMessageToast");
  const confirm = toast.querySelector("#confirmDelete");
  const cancel = toast.querySelector("#cancelDelete");

  toast.style.display = "block";
  confirm.onclick = () => {
    socket.emit("deleteMessage", { roomId: activeRoomId, messageId });
    toast.style.display = "none";
  };
  cancel.onclick = () => (toast.style.display = "none");
}

loadChatRooms();
</script>

    </body>
</html>