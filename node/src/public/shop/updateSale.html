<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">b</title>
</head>
<body>
    <form id="updateBookForm" enctype="multipart/form-data" class="p-4 max-w-3xl mx-auto bg-white rounded-lg shadow-md">
  <h2 class="text-xl font-semibold mb-4 text-center">Update Book for Sale</h2>

  <!-- Book Title -->
  <div class="mb-3">
    <label class="block font-medium">Book Title</label>
    <input type="text" id="bookTitle" name="bookTitle" class="form-control" required />
  </div>

  <!-- Description -->
  <div class="mb-3">
    <label class="block font-medium">Description</label>
    <textarea id="description" name="description" class="form-control" rows="3"></textarea>
  </div>

  <!-- Sale Type -->
  <div class="mb-3">
    <label class="block font-medium">Sale Type</label>
    <select id="saleType" name="saleType" class="form-select" required>
      <option value="normal">Normal</option>
      <option value="discount">Discount</option>
      <option value="free">Free</option>
    </select>
  </div>

  <!-- Price Fields (conditionally visible) -->
  <div id="priceFields">
    <div class="mb-3">
      <label class="block font-medium">Original Price ($)</label>
      <input type="number" id="originalPrice" name="originalPrice" step="0.01" class="form-control" />
    </div>

    <div class="mb-3">
      <label class="block font-medium">Discount Type</label>
      <select id="discountType" name="discountType" class="form-select">
        <option value="">None</option>
        <option value="percent">Percent</option>
        <option value="fixed">Fixed</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="block font-medium">Discount Price</label>
      <input type="number" id="discountPrice" name="discountPrice" step="0.01" class="form-control" />
    </div>

    <div class="mb-3">
      <label class="block font-medium">Final Price ($)</label>
      <input type="number" id="price" name="price" step="0.01" class="form-control" />
    </div>
  </div>

  <!-- Book Type -->
  <div class="mb-3">
    <label class="block font-medium">Book Type</label>
    <select id="bookType" name="bookType" class="form-select" required>
      <option value="ebook">E-Book</option>
      <option value="paper">Physical</option>
    </select>
  </div>

  <!-- Quantity -->
  <div class="mb-3">
    <label class="block font-medium">Quantity</label>
    <input type="number" id="qty" name="qty" class="form-control" required />
  </div>

  <!-- Quality -->
  <div class="mb-3">
    <label class="block font-medium">Book Quality</label>
    <select id="bookQuality" name="bookQuality" class="form-select" required>
      <option value="new">New</option>
      <option value="almost new">Almost new</option>
      <option value="second hand">Second hand</option>
    </select>
  </div>

  <!-- Contact -->
  <div class="mb-3">
    <label class="block font-medium">Contact</label>
    <input type="text" id="contact" name="contact" class="form-control" />
  </div>

  <!-- Website -->
  <div class="mb-3">
    <label class="block font-medium">Website</label>
    <input type="url" id="website" name="website" class="form-control" />
  </div>

  <!-- Book Cover -->
  <div class="mb-3">
    <label class="block font-medium">Book Cover Image</label>
    <input type="file" id="bookImg" name="bookImg" class="form-control" />
    <div id="bookImgPreview" class="mt-2"></div>
  </div>

  <!-- Preview Images -->
  <div class="mb-3">
    <label class="block font-medium">Preview Images</label>
    <input type="file" id="imgPreview" name="imgPreview" multiple class="form-control" />
    <div id="imgPreviewContainer" class="mt-2 grid grid-cols-3 gap-2"></div>
  </div>

  <!-- Ebook File -->
  <div class="mb-3" id="bookFileGroup">
    <label class="block font-medium">Ebook File</label>
    <input type="file" id="bookFile" name="bookFile" class="form-control" />
    <div id="bookFilePreview" class="mt-2 text-sm text-gray-500"></div>
  </div>

  <button type="submit" class="btn btn-primary w-full">Update Book</button>
</form>

<script>
  const saleTypeSelect = document.getElementById("saleType");
  const bookTypeSelect = document.getElementById("bookType");
  const priceFields = document.getElementById("priceFields");
  const bookFileGroup = document.getElementById("bookFileGroup");

  const originalPrice = document.getElementById("originalPrice");
  const discountType = document.getElementById("discountType");
  const discountPrice = document.getElementById("discountPrice");
  const finalPrice = document.getElementById("price");

  // store file URL temporarily
  let currentBookFileUrl = "";

  // üß© Helper: update discount automatically
  function updateDiscount() {
    const orig = parseFloat(originalPrice.value) || 0;
    const discount = parseFloat(discountPrice.value) || 0;
    let final = orig;

    if (discountType.value === "percent") {
      final = orig - (orig * discount) / 100;
    } else if (discountType.value === "fixed") {
      final = orig - discount;
    }

    // prevent negative
    finalPrice.value = final > 0 ? final.toFixed(2) : 0;
  }

  // üéØ Toggle field display
  function toggleFields() {
    const saleType = saleTypeSelect.value;
    const bookType = bookTypeSelect.value;

    // Sale Type logic
    if (saleType === "free") {
      priceFields.style.display = "none";
      clearPriceAndDiscountFields();
    } else if (saleType === "normal") {
      priceFields.style.display = "block";
      document.getElementById("discountType").parentElement.style.display = "none";
      document.getElementById("discountPrice").parentElement.style.display = "none";
      discountType.value = "";
      discountPrice.value = "";
    } else if (saleType === "discount") {
      priceFields.style.display = "block";
      document.getElementById("discountType").parentElement.style.display = "block";
      document.getElementById("discountPrice").parentElement.style.display = "block";
    }

    // Book Type logic (if switching from ebook ‚Üí paperBook)
    if (bookType === "ebook") {
      bookFileGroup.style.display = "block";
    } else {
      bookFileGroup.style.display = "none";

      // Delete file if exists
      if (currentBookFileUrl) {
        deleteBookFileFromS3(currentBookFileUrl);
      }
    }
  }

  // üßπ Helper to clear price/discount inputs
  function clearPriceAndDiscountFields() {
    ["originalPrice", "price", "discountType", "discountPrice"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });
  }

  // üíæ Delete S3 file and clear DB field
  async function deleteBookFileFromS3(fileUrl) {
    const token = localStorage.getItem("token");
    if (!fileUrl) return;

    try {
      const res = await fetch(`https://thebooksourcings.onrender.com/api/shop/delete-book-file`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify({ fileUrl }),
      });

      const data = await res.json();
      if (data.success) {
        console.log("‚úÖ File deleted from S3");
        document.getElementById("bookFilePreview").textContent = "No file uploaded";
        currentBookFileUrl = "";

        // Update DB to set bookFile = NULL
        await fetch(`https://thebooksourcings.onrender.com/api/shop/clearBookFile/${bookSid}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`,
          },
        });

        console.log("‚úÖ bookFile cleared in DB");
      } else {
        console.warn("‚ö†Ô∏è Failed to delete from S3:", data.message);
      }
    } catch (err) {
      console.error("‚ùå Error deleting file from S3:", err);
    }
  }

  // Event listeners
  saleTypeSelect.addEventListener("change", toggleFields);
  bookTypeSelect.addEventListener("change", toggleFields);

  [originalPrice, discountType, discountPrice].forEach(el => {
    el.addEventListener("input", () => {
      if (saleTypeSelect.value === "discount") updateDiscount();
    });
  });

  // Load book data
  async function loadBookData(bookSid) {
    try {
      const res = await fetch(`https://thebooksourcings.onrender.com/api/shop/displaySaleBookBySid/${bookSid}`);
      if (!res.ok) throw new Error("Failed to fetch book data");

      const data = await res.json();
      const book = data.book;

      // fill form
      document.getElementById("bookTitle").value = book.title || "";
      document.getElementById("description").value = book.description || "";
      saleTypeSelect.value = book.sale_type || "normal";
      bookTypeSelect.value = book.book_type || "ebook";
      document.getElementById("bookQuality").value = book.quality || "new";
      originalPrice.value = book.original_price || "";
      discountType.value = book.discount_type || "";
      discountPrice.value = book.discount_price || "";
      finalPrice.value = book.price || "";
      document.getElementById("qty").value = book.qty || "";
      document.getElementById("contact").value = book.contact || "";
      document.getElementById("website").value = book.website || "";

      // üñºÔ∏è main image
      if (book.bookImg) {
        document.getElementById("bookImgPreview").innerHTML =
          `<img src="${book.bookImg}" class="w-24 h-32 object-cover rounded shadow">`;
      }

      // üñºÔ∏è multiple previews
      if (book.imgPreview) {
        try {
          const previews = JSON.parse(book.imgPreview);
          document.getElementById("imgPreviewContainer").innerHTML =
            previews.map(url => `<img src="${url}" class="w-24 h-32 object-cover rounded shadow">`).join("");
        } catch {
          console.warn("Invalid imgPreview JSON:", book.imgPreview);
        }
      }

      // üìò Ebook file preview
      if (book.bookFile) {
        currentBookFileUrl = book.bookFile;
        document.getElementById("bookFilePreview").textContent = `Current File: ${book.bookFile}`;
      } else {
        document.getElementById("bookFilePreview").textContent = "No file uploaded";
      }

      toggleFields();
      if (saleTypeSelect.value === "discount") updateDiscount();

    } catch (err) {
      console.error("Error loading book:", err);
      alert("Failed to load book details");
    }
  }

  const urlParams = new URLSearchParams(window.location.search);
  const bookSid = urlParams.get("bookSid");
  if (bookSid) loadBookData(bookSid);

  // üì§ Submit form
  document.getElementById("updateBookForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const token = localStorage.getItem("token");
    const formData = new FormData(e.target);

    try {
      const res = await fetch(`https://thebooksourcings.onrender.com/api/shop/updateSaleBook/${bookSid}`, {
        method: "PUT",
        headers: { "Authorization": `Bearer ${token}` },
        body: formData
      });

      const data = await res.json();
      if (res.ok) {
        alert("‚úÖ Book updated successfully!");
      } else {
        alert("‚ùå Update failed: " + data.message);
      }
    } catch (err) {
      console.error("Update error:", err);
      alert("Something went wrong!");
    }
  });
</script>


<!-- <script>
  const saleTypeSelect = document.getElementById("saleType");
  const bookTypeSelect = document.getElementById("bookType");
  const priceFields = document.getElementById("priceFields");
  const bookFileGroup = document.getElementById("bookFileGroup");

  const originalPrice = document.getElementById("originalPrice");
  const discountType = document.getElementById("discountType");
  const discountPrice = document.getElementById("discountPrice");
  const finalPrice = document.getElementById("price");

  // üß© Helper: update discount automatically
  function updateDiscount() {
    const orig = parseFloat(originalPrice.value) || 0;
    const discount = parseFloat(discountPrice.value) || 0;
    let final = orig;

    if (discountType.value === "percent") {
      final = orig - (orig * discount) / 100;
    } else if (discountType.value === "fixed") {
      final = orig - discount;
    }

    // prevent negative
    finalPrice.value = final > 0 ? final.toFixed(2) : 0;
  }

  // üéØ Toggle field display
  function toggleFields() {
    const saleType = saleTypeSelect.value;
    const bookType = bookTypeSelect.value;

    // Sale Type logic
    if (saleType === "free") {
      priceFields.style.display = "none";
      clearPriceAndDiscountFields();
    } else if (saleType === "normal") {
      priceFields.style.display = "block";

      // show only normal price input
      document.getElementById("discountType").parentElement.style.display = "none";
      document.getElementById("discountPrice").parentElement.style.display = "none";

      // clear discount values
      discountType.value = "";
      discountPrice.value = "";
    } else if (saleType === "discount") {
      priceFields.style.display = "block";

      // show all discount fields
      document.getElementById("discountType").parentElement.style.display = "block";
      document.getElementById("discountPrice").parentElement.style.display = "block";
    }

    // Book Type logic
    bookFileGroup.style.display = bookType === "ebook" ? "block" : "none";
  }

  // üßπ Helper to clear all price/discount inputs
  function clearPriceAndDiscountFields() {
    ["originalPrice", "price", "discountType", "discountPrice"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });
  }

  // Event listeners
  saleTypeSelect.addEventListener("change", toggleFields);
  bookTypeSelect.addEventListener("change", toggleFields);

  // Discount calculation live update
  [originalPrice, discountType, discountPrice].forEach(el => {
    el.addEventListener("input", () => {
      if (saleTypeSelect.value === "discount") updateDiscount();
    });
  });

  // Load book data
  async function loadBookData(bookSid) {
    const token = localStorage.getItem("token");
    try {
      const res = await fetch(`https://thebooksourcings.onrender.com/api/shop/displaySaleBookBySid/${bookSid}`);
      if (!res.ok) throw new Error("Failed to fetch book data");

      const data = await res.json();
      const book = data.book;

      // fill fields
      document.getElementById("bookTitle").value = book.title || "";
      document.getElementById("description").value = book.description || "";
      saleTypeSelect.value = book.sale_type || "normal";
      bookTypeSelect.value = book.book_type || "ebook";
      document.getElementById("bookQuality").value = book.quality || "new";
      originalPrice.value = book.original_price || "";
      discountType.value = book.discount_type || "";
      discountPrice.value = book.discount_price || "";
      finalPrice.value = book.price || "";
      document.getElementById("qty").value = book.qty || "";
      document.getElementById("contact").value = book.contact || "";
      document.getElementById("website").value = book.website || "";

      // üñºÔ∏è main image
      if (book.bookImg) {
        document.getElementById("bookImgPreview").innerHTML =
          `<img src="${book.bookImg}" class="w-24 h-32 object-cover rounded shadow">`;
      }

      // üñºÔ∏è multiple previews
      if (book.imgPreview) {
        try {
          const previews = JSON.parse(book.imgPreview);
          document.getElementById("imgPreviewContainer").innerHTML =
            previews.map(url => `<img src="${url}" class="w-24 h-32 object-cover rounded shadow">`).join("");
        } catch {
          console.warn("Invalid imgPreview JSON:", book.imgPreview);
        }
      }

      // üìò Ebook file preview
      if (book.bookFile) {
        document.getElementById("bookFilePreview").textContent = `Current File: ${book.bookFile}`;
      }

      toggleFields();
      if (saleTypeSelect.value === "discount") updateDiscount();

    } catch (err) {
      console.error("Error loading book:", err);
      alert("Failed to load book details");
    }
  }

  const urlParams = new URLSearchParams(window.location.search);
  const bookSid = urlParams.get("bookSid");
  if (bookSid) loadBookData(bookSid);

  // üì§ Submit form
  document.getElementById("updateBookForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const token = localStorage.getItem("token");
    const formData = new FormData(e.target);

    try {
      const res = await fetch(`https://thebooksourcings.onrender.com/api/shop/updateSaleBook/${bookSid}`, {
        method: "PUT",
        headers: { "Authorization": `Bearer ${token}` },
        body: formData
      });

      const data = await res.json();
      if (res.ok) {
        alert("‚úÖ Book updated successfully!");
      } else {
        alert("‚ùå Update failed: " + data.message);
      }
    } catch (err) {
      console.error("Update error:", err);
      alert("Something went wrong!");
    }
  });
</script> -->



</body>
</html>