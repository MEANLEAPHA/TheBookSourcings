<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
     <script src="https://kit.fontawesome.com/ec7a51a641.js" crossorigin="anonymous"></script>
      <script src="https://kit.fontawesome.com/ec7a51a641.js" crossorigin="anonymous"></script>
       <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root{
    --background-color:white;
    --primary-color:#fd7648;
    --secondary-color: gainsboro;
    --font-color:rgb(65, 65, 65);
    --back-con:rgb(245, 245, 245);
        }
        .dark-theme{
            --background-color:rgb(32, 32, 32);
            --primary-color:#fd7648;
            --secondary-color: rgba(220, 220, 220, 0.318);
            --font-color:rgb(255, 255, 255);
            --back-con:rgb(40, 40, 40);
        }
        section{
            position: relative;
            padding: 20px 20px 20px 20px;
            width: 80%;
            margin: auto;
        }
        .add-section{
            background: var(--primary-color);
            color: white;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translate(-50%, 40px);
         
            display: none;
        }
        .add-section:focus{
            outline: none;
        }
            
        .add-section:hover{
            border: var(--primary-color) 1px solid;
            background: var(--background-color);
            color: var(--font-color);
 
        }
        section:hover{
            border: 2px solid var(--primary-color);
        }
        section:hover .add-section{
            display: block;
        }
        #img-wrapper{
            width: 80%;
            margin: auto;
            border: 1px dashed var(--secondary-color);
            border-radius: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #label-img{
            width: 100%;
        }
        #input-label-holder{
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            cursor: pointer;
             color: var(--font-color);
             font-family: monospace;
            gap:0;
            width: 100%;
           
        }
        #input-label-holder p{
            margin: 2px;
            font-size: larger;
        }
        #img-preview-holder {
    position: relative;
    display: none;
    
    margin: auto;
    width: auto;
     
    height: auto;
   
}

#img-preview {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    max-height: 350px;
    height: auto;
    margin: auto;
}

#cancel-preview {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0,0,0,0.7);
    color: #ffffffa8;
    border: none;
    background-color: rgba(255, 68, 0, 0.589);
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 13px;
    line-height: 28px;
}

        #file-p{
            opacity: 0.8;
            font-weight: bold;
        }
        #supp-file-p{
            opacity: 0.6;
            font-size: smaller;
        }
       #img-input-holder{
        width: 80px;
        height: 80px;
        opacity: 0.7;
       }
       textarea{
            resize: none; 
            overflow: auto;
             border:none;
       }
       textarea:focus{
        border: none;
        outline: none;
       
       }
       #main-input{
        width: 80%;
        height: auto;
        margin: auto;
        display: block;
        margin-top: 20px;
        display: flex;
        justify-content: center;
        text-align: center;
        font-size: x-large;
        font-family: 'Times New Roman', Times, serif;
        font-weight: bold;
       
       
       }
       .section-input{
        width: 100%; 
        margin: auto;
  
        padding: 0;
       }
       .dropdown-item img{
        width: 200px;
       }


       .article-section {
    width: 80%;
    margin: 30px auto;
}

.article-section textarea {
    width: 100%;
    min-height: 150px;
    padding: 10px;
    font-size: large;
    font-family: 'Times New Roman', Times, serif;
}

.section-with-image-top img {
    max-width: 100%;
    margin-bottom: 10px;
}

.section-with-image-side {
    display: flex;
    gap: 15px;
    align-items: flex-start;
}

.section-with-image-side img {
    width: 200px;
}

.section-with-image-side.right {
    flex-direction: row-reverse;
}
.article-section {
    position: relative;
    border: 1px solid #ddd;
    padding: 20px;
    margin-top: 20px;
    border-radius: 8px;
}

.section-toolbar {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 10px;
}

.section-preview {
    max-width: 100%;
    margin-bottom: 10px;
}
.cancel-section-image {
    display: none; /* ðŸ”´ THIS is the key */
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 26px;
    height: 26px;
    cursor: pointer;
}



    </style>
</head>
<body>
    <form action="" id="article-form">
       <section>
        
            <div id="img-wrapper">
                <label for="img-input" id="label-img">
                    <div id="input-label-holder">
                        <img src="assets/img/cloud-computing.png" alt="Upload-Image" id="img-input-holder">
                        <p id="file-p">Upload main image</p>
                        <p id="supp-file-p">Jpg, Png, Jpeg, Svg</p>
                    </div>
                    <input type="file"  id="img-input" hidden>
                </label>
                <div id="img-preview-holder">
                    <img src="" id="img-preview">
                    <button type="button" id="cancel-preview"><i class="fa-solid fa-x"></i></button>
                </div>
            </div>

            <textarea id="main-input" placeholder="Write your main content here, Example: Why creativity became rare in The AI Age and how do we deal with it"></textarea>
            <br>
            <textarea class="first-section-input section-input" placeholder="       Write your first section here, Example: In today technology, people are being distracted by the constant flow of information and data. We used to stay focused on a single task at a time, but now we have to juggle multiple tasks at once."></textarea>
            <div id="sections-container"></div>

            <div class="dropdown">
                <button class="btn dropdown-toggle add-section" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                    Add Section
                </button>
                <ul class="dropdown-menu " aria-labelledby="dropdownMenuButton1">
                    <li><a class="dropdown-item" href="#" data-type="no-image"><img src="assets/img/article4.png" alt="" > No Image</a></li>
                    <li><a class="dropdown-item" href="#" data-type="image-top"><img src="assets/img/article3.png" alt="" > With Image on top</a></li>
                    <li><a class="dropdown-item" href="#"  data-type="image-left"><img src="assets/img/article2.png" alt=""> With Image at left</a></li>
                    <li><a class="dropdown-item" href="#" data-type="image-right"><img src="assets/img/article1.png" alt="" > With Image at right</a></li>
                </ul>
            </div>
         <input
  type="file"
  id="optional-images-input"
  name="optional_images"
  accept="image/*"
  multiple
  hidden
>

       </section>
       <button type="submit" id="publish-btn" class="btn btn-primary">
    Publish Article
</button>

    </form>
    <script>
/* =========================
   CONFIG
========================= */
const MAX_SECTIONS = 7;
const MAX_IMAGES = 3;

const sectionsContainer = document.getElementById('sections-container');
const globalAddBtn = document.querySelector('.dropdown');

let imageCount = 0;


const optionalImagesInput = document.getElementById('optional-images-input');
let optionalImages = [];

/* =========================
   SECTION UTILITIES
========================= */
function getTotalSections() {
    return document.querySelectorAll('.article-section').length;
}

function toggleAddButtons() {
    const canAdd = getTotalSections() < MAX_SECTIONS;

    document.querySelectorAll('.add-section-btn').forEach(btn => {
        btn.style.display = canAdd ? 'inline-block' : 'none';
    });

    globalAddBtn.style.display = canAdd ? 'block' : 'none';
}

/* =========================
   INSERT HELPER (NEW)
========================= */
function insertAfterSection(reference, newSection) {
    if (reference.nextSibling) {
        sectionsContainer.insertBefore(newSection, reference.nextSibling);
    } else {
        sectionsContainer.appendChild(newSection);
    }
}

/* =========================
   TOOLBAR TEMPLATE
========================= */
function sectionToolbar() {
    return `
        <div class="section-toolbar">
            <div class="dropdown">
                <button type="button" class="btn add-section-btn" data-bs-toggle="dropdown">
                    âž• Add
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" data-type="0">No Image</a></li>
                    <li><a class="dropdown-item" href="#" data-type="1">Image Top</a></li>
                    <li><a class="dropdown-item" href="#" data-type="2">Image Left</a></li>
                    <li><a class="dropdown-item" href="#" data-type="3">Image Right</a></li>
                </ul>
            </div>
            <button type="button" class="delete-section">ðŸ—‘</button>
        </div>
    `;
}

/* =========================
   CREATE SECTION
========================= */
function createSection(type, insertAfter = null) {
    if (getTotalSections() >= MAX_SECTIONS) return;

    if (type !== 'no-image' && imageCount >= MAX_IMAGES) {
        alert('Maximum 3 images allowed.');
        return;
    }


    const section = document.createElement('div');
    section.className = 'article-section';
    section.dataset.layout = type;

    let content = '';

    if (type === 'no-image') {
        content = `<textarea class="section-input" placeholder="Write your section..."></textarea>`;
    } else {
        imageCount++;
        content = `
    <div class="section-image-wrapper">
        <input type="file" class="section-image" accept="image/*">
        <img class="section-preview" style="display:none">
        <button type="button" class="cancel-section-image">âœ–</button>
    </div>
    <textarea class="section-input" placeholder="Write your section..."></textarea>
`;

    }

    section.innerHTML = sectionToolbar() + content;

    // ðŸ”¥ INSERT LOGIC HERE
    if (insertAfter) {
        insertAfterSection(insertAfter, section);
    } else {
        sectionsContainer.appendChild(section);
    }

    attachSectionEvents(section);
    toggleAddButtons();
}

/* =========================
   EVENTS
// ========================= */
function attachSectionEvents(section) {

  const imgInput = section.querySelector('.section-image');
  const img = section.querySelector('.section-preview');
  const cancelImgBtn = section.querySelector('.cancel-section-image');

  /* =========================
     IMAGE INPUT (ONLY IF EXISTS)
  ========================= */
  if (imgInput) {
    imgInput.addEventListener('change', () => {
      const file = imgInput.files[0];
      if (!file || !file.type.startsWith('image/')) return;

      if (optionalImages.length >= MAX_IMAGES) {
        alert('Maximum 3 optional images allowed');
        imgInput.value = '';
        return;
      }

      optionalImages.push(file);

      const dt = new DataTransfer();
      optionalImages.forEach(f => dt.items.add(f));
      optionalImagesInput.files = dt.files;

      const reader = new FileReader();
      reader.onload = e => {
        img.src = e.target.result;
        img.style.display = 'block';
        cancelImgBtn.style.display = 'inline-block';
      };
      reader.readAsDataURL(file);
    });
  }

  /* =========================
     CANCEL IMAGE
  ========================= */
  if (cancelImgBtn && imgInput) {
    cancelImgBtn.addEventListener('click', () => {
      const index = optionalImages.findIndex(
        f => f.name === imgInput.files[0]?.name
      );

      if (index !== -1) optionalImages.splice(index, 1);

      const dt = new DataTransfer();
      optionalImages.forEach(f => dt.items.add(f));
      optionalImagesInput.files = dt.files;

      imgInput.value = '';
      img.src = '';
      img.style.display = 'none';
      cancelImgBtn.style.display = 'none';

      imageCount--;
      toggleAddButtons();
    });
  }

  /* =========================
     DELETE SECTION (ALWAYS)
  ========================= */
  section.querySelector('.delete-section').addEventListener('click', () => {
    if (imgInput && imgInput.value) imageCount--;
    section.remove();
    toggleAddButtons();
  });

  /* =========================
     INSERT BELOW
  ========================= */
  section.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', e => {
      e.preventDefault();
      createSection(item.dataset.type, section);
    });
  });
}



/* =========================
   GLOBAL ADD BUTTON (BOTTOM)
========================= */
globalAddBtn.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', e => {
        e.preventDefault();
        createSection(item.dataset.type);
    });
});

toggleAddButtons();
    const imgInput = document.getElementById('img-input');
const imgPreviewHolder = document.getElementById('img-preview-holder');
const imgPreview = document.getElementById('img-preview');
const inputLabelHolder = document.getElementById('input-label-holder');
const cancelBtn = document.getElementById('cancel-preview');

imgInput.addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;

    // Only preview images
    if (!file.type.startsWith('image/')) {
        alert('Please upload an image file');
        imgInput.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
        imgPreview.src = e.target.result;
        imgPreviewHolder.style.display = 'block';
        inputLabelHolder.style.display = 'none';
    };
    reader.readAsDataURL(file);
});

// Cancel preview
cancelBtn.addEventListener('click', function () {
    imgPreview.src = '';
    imgInput.value = ''; // reset input (important for DB upload)
    imgPreviewHolder.style.display = 'none';
    inputLabelHolder.style.display = 'flex';
});

const token = localStorage.getItem('token');
document.getElementById('article-form').addEventListener('submit', async function (e) {
    e.preventDefault();

    const formData = new FormData();

    // Main image
    const mainImg = document.getElementById('img-input').files[0];
    if (mainImg) formData.append('main_image', mainImg);

    // Main content
    formData.append('title', document.getElementById('main-input').value);
    formData.append('main_section', document.querySelector('.first-section-input').value);

    // Dynamic sections
    document.querySelectorAll('.article-section').forEach((section, index) => {
        // const layout = section.dataset.layout;
        const layout = Number(section.dataset.layout);

        const text = section.querySelector('.section-input')?.value || '';
        // const image = section.querySelector('.section-image')?.files[0] || null;

        formData.append('section_layouts[]', layout);
        formData.append('section_texts[]', text);

      

        // if (image) {
        //     formData.append(`sections[${index}][image]`, image);
        // }
    });
      for (const file of optionalImagesInput.files) {
        formData.append('section_images', file);
        }

    try {
        const res = await fetch('https://thebooksourcings.onrender.com/api/article/upload', {
            method: 'POST',
            headers: { "Authorization": `Bearer ${token}` },
            body: formData
        });

        const data = await res.json();

        if (data.success) {
            alert('Article published successfully!');
        } else {
            alert('Publish failed');
        }
    } catch (err) {
        console.error(err);
        alert('Server error');
    }
});

</script>



    
</body>
</html>