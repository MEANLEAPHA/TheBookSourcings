<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Community Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    #message-container div { 
        margin-bottom: 10px; 
        padding: 8px 10px; 
        background: #fff; 
        border-radius: 5px; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }
    .msg-text { margin-right: 10px; }
    .createdAt{
        float: right;
        color: grey;
    } */

    .userPfFrom{
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }
     #message-container{
      display: grid;
      gap: 15px;
      width: 50%;
      margin: auto;
     }
    /* .owner-btn { margin-left: 5px; cursor: pointer; color: red; font-weight: bold; }
    #form { margin-top: 20px; display: flex; }
    #message-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;} */
    /* #form button { margin-left: 10px; padding: 8px 15px; border: none; border-radius: 5px; background: #4CAF50; color: white; cursor: pointer; }
    #form button:hover { background: #45a049; } */

    /* Center edit toast in the page */
    #editToastWrapper {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1080;
    }

    /* Center delete toast in the page */
    #deleteToastWrapper {
        position: fixed;
        top: 60%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1080;
    }

    #reportToastWrapper {
      position: fixed;
      top: 55%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1080;
      width: 300px;
    }

     #PostToastWrapper {
      position: fixed;
      top: 55%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1080;
      width: 80%;
      height: auto;
      border-radius: 10px;
    }
    #toastOfPost{
        width: 70%;
        height: auto;
        margin: auto;
        
        border-radius: 10px
    }
    #searchButton{
        width: 70%;
        background: none;
        border: 1px solid gainsboro;
        border-radius: 10px;
        display: flex;
        height: 50px;
        justify-content: start;
        padding: 10px;
        color: gray;
    }

     .post{
            width: 100%;
            height: auto;
            padding: 10px 20px 10px 20px;
            margin: auto;
            padding-left: 10px;
            border-radius: 15px;
            box-shadow: 0px 0px 3px rgba(86, 86, 86, 0.144);
        }
       
        
         .post .post-header{
            width: 100%;
            display: flex;
            padding: 5px;
            gap: 15px;
            position: relative;
            
        }
        .userProfile{
            width: 55px;
            height: 55px;
            border-radius: 50%;
            object-fit: cover;
        }
        .post-header-child-right{
          display: grid;
          gap: 0px;

        }
        .post-header-child-right-top{
          display: flex;
          justify-content: start;
          /* background-color: aquamarine; */
          padding: 0;
          margin: 0;
          align-items: center;
        }
        .post-header-child-right-bottom{
          /* background-color: blueviolet; */
          margin: 0;
          padding: 0;
          position: relative;
        }
        .feelingDisplay{
          color: gray;
          font-family: sans-serif;
          font-size: medium;
          text-decoration: none;
          margin-left: 5px;
        
        }

         .username{
            font-family: monospace;
            margin: 0;
            font-size: larger;
            text-decoration: none;
            color: black;
         }
         .postAt{
            color: gray;
            opacity: 0.8;
            font-size: small;
            font-family: monospace;
            margin: 0;
           
         }
         .absolute-top-right{
            font-size: large;
            color: rgb(0, 0, 0);
            
            position: absolute;
            top: 5px;
            right: 5px;
            
         }
         .post .post-body{
            width: 100%;
            padding: 5px;
         }
         .post-text{
            font-family: sans-serif;
            margin: 0;
         }
        
          /* .post-thumbnail {
            position: relative;
            width: 100%;
            height: 350px;
            margin: auto;
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
          }

            .post-thumbnail-img {
              position: relative;
              z-index: 1;
              height: 100%;
              object-fit: contain; 
            } */
             .post-thumbnail {
                position: relative;
                width: 100%;
                height: 350px;
                margin: auto;
                margin-top: 10px;
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: hidden;
              }

              .post-thumbnail::before {
                content: "";
                position: absolute;
                inset: 0;
                background: var(--bg-url) center/cover no-repeat;
                filter: blur(30px);
                transform: scale(1.1); /* prevents blur edges from showing */
                z-index: 0;
              }

              .post-thumbnail-img {
                position: relative;
                z-index: 1;
                height: 100%;
                object-fit: contain;
              }


        .post .post-body .post-media-count{
            
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin-top: 10px;
            font-family: sans-serif;
            align-items: end;
            font-size: 14px;
            opacity: 0.9;
            padding: 0;
         }
         .post-media-count div{
            margin: 0;
            height: auto;
           
            display: flex;
            justify-content: start;
            align-items: end;
            
         }
         .post-media-count div p{
            padding: 0;
          margin-bottom: 0;
         }
         .post-media-count-child-right{
            display: flex;
            gap: 25px;
         }
         
         .post-hr{
            color: gainsboro;
            background-color: gainsboro;
            opacity: 0.3;
         }
         .post-media-button{
            display: flex;
            border-top: 1px gainsboro solid;
            justify-content: space-between;
            padding: 0;
            
            align-items: end;
            margin: 0;
         }
         .media-btn{
            width: calc(100%/3.06);
            padding: 18px;
            margin: 0;
            background:none;
            border: none;
            cursor: pointer;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            
         }
         .media-btn span{
            /* margin-top: 2px; */
             color:gray;
         }
         .media-btn:hover{
            background-color: gainsboro;
         }
         .fa-solid{
            font-size: large;
            color:gray;
         }
          @media screen and (max-width: 768px) {
             #message-container{
              width: 97%;
             }
        }
    
/* feeling toast */
         #FeelingToastWrapper {
      position: fixed;
      top: 55%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1090;
     
    }

    .grid-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      height: 300px;
      overflow-y: auto;
    }

    .feeling-option {
      padding: 8px;
      background-color: #f8f9fa;
      border-radius: 6px;
      cursor: pointer;
      text-align: start;
      transition: background-color 0.2s;
      font-size: 1rem;
    }

    .feeling-option:hover {
      background-color: #e2e6ea;
    }

    #displayFeeling {
      font-family: monospace;
      color:gray;
    }

    #feelingValue {
      display: none;
    }

  </style>
</head>
<body>




<!-- <form id="form">
  <textarea id="message-input" placeholder="Type your message..." rows="3"></textarea>
  <div class="d-flex align-items-center mt-2">
    <label for="mediaInput" style="cursor: pointer; margin-right: 10px;">
      <i class="fa-solid fa-photo-film fa-lg"></i>
    </label>
    <input type="file" id="mediaInput" accept="image/*,video/*" style="display: none;">
    <button type="submit">Send</button>
  </div>
  <div id="media-preview" class="mt-2"></div>
</form> -->

<div style="display: flex; width: 90%;justify-content: center;gap: 1px;margin:auto">
  <img src="../../assets/img/pf.jpg" style="width: 50px;height: 50px;border-radius: 50%;object-fit: cover;">
<button id="searchButton">Share your thought, Meanleap Ha? </button>
</div>


<!-- Post Toast -->
<div id="PostToastWrapper">
  <div id="PostToast" class="toast align-items-center text-bg-light border-0 toastOfPost" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <img src="../../assets/img/pf.jpg" class="userPfFrom">
      <p class="usernameFrom"></p> <span id="displayFeeling"></span>
    </div>
    <form id="form">
      <div class="toast-body">
        <textarea id="message-input" class="form-control mb-2" placeholder="Share your thought"></textarea>
        <div id="media-preview" class="mt-2"></div>
        <div>
          <label for="mediaInput" style="cursor: pointer">
                <i class="fa-solid fa-photo-film fa-lg" style="color: green;"></i> Photo/Video
          </label>
          <label for="feelingGrid" id="feelingLabel" style="cursor:pointer;">
                <i class="fa-solid fa-face-smile" style="color:gold; font-size: 1.5rem;"></i> Feeling
          </label>
        </div>
           <select id="feelingValue" hidden>
            <option value="" disabled selected>Select a feeling</option>
            <option value="happy">ğŸ˜Š happy</option>
            <option value="sad">ğŸ˜¢ sad</option>
            <option value="angry">ğŸ˜¡ angry</option>
            <option value="blissful">ğŸ˜‡ blissful</option>
            <option value="in love">ğŸ˜ in love</option>
            <option value="silly">ğŸ˜œ silly</option>
            <option value="cool">ğŸ˜ cool</option>
            <option value="relaxed">ğŸ˜Œ relaxed</option>
            <option value="sleepy">ğŸ˜´ sleepy</option>
            <option value="sick">ğŸ¤’ sick</option>
            <option value="loved">ğŸ¤— loved</option>
            <option value="shocked">ğŸ˜± shocked</option>
            <option value="disappointed">ğŸ˜ disappointed</option>
            <option value="frustrated">ğŸ˜¤ frustrated</option>
            <option value="excited">ğŸ¤© excited</option>
            <option value="festive">ğŸ¥³ festive</option>
            <option value="down">ğŸ˜” down</option>
            <option value="confused">ğŸ˜• confused</option>
            <option value="nervous">ğŸ˜¬ nervous</option>
            <option value="blessed">ğŸ˜‡ blessed</option>
            <option value="thankful">ğŸ™ thankful</option>
            <option value="amused">ğŸ˜… amused</option>
            <option value="curious">ğŸ¤“ curious</option>
            <option value="overwhelmed">ğŸ˜© overwhelmed</option>
            <option value="fantastic">ğŸ˜† fantastic</option>
            <option value="meh">ğŸ˜¶ meh</option>
            <option value="heartbroken">ğŸ˜¢ heartbroken</option>
            <option value="determined">ğŸ˜¤ determined</option>
            <option value="inspired">ğŸ˜‡ inspired</option>
            <option value="crazy">ğŸ˜µâ€ğŸ’« crazy</option>
            <option value="ok">ğŸ˜ OK</option>
            <option value="proud">ğŸ˜ƒ proud</option>
            <option value="satisfied">ğŸ˜‹ satisfied</option>
            <option value="embarrassed">ğŸ˜³ embarrassed</option>
            <option value="thoughtful">ğŸ¤” thoughtful</option>
            <option value="lovely">ğŸ˜ lovely</option>
            <option value="miserable">ğŸ˜– miserable</option>
            <option value="grateful">ğŸ˜‡ grateful</option>
          </select>
          <input type="file" id="mediaInput" accept="image/*,video/*" style="display: none;" hidden>
        <div class="d-flex justify-content-end">
          <button id="cancelPostBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
          <button id="submitPostBtn" type="submit" class="btn btn-sm btn-success">Post</button>
        </div>
      </div>
    </form>
  </div>
</div>
<br>
<div id="message-container"></div>


<!-- Bootstrap Toast for editing -->
<div id="editToastWrapper">
  <div id="editToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body">
      <input type="text" id="editMessageInput" class="form-control mb-2">
      <div class="d-flex justify-content-end">
        <button id="cancelEditBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
        <button id="saveEditBtn" type="button" class="btn btn-sm btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Toast for deleting -->
<div id="deleteToastWrapper">
  <div id="deleteToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body">
      <p>Are you sure you want to delete this message?</p>
      <div class="d-flex justify-content-end">
        <button id="cancelDeleteBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
        <button id="confirmDeleteBtn" type="button" class="btn btn-sm btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Report Toast -->
<div id="reportToastWrapper">
  <div id="reportToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body">
      <h6>Report Post</h6>
      <textarea id="reportReasonInput" class="form-control mb-2" placeholder="Reason..."></textarea>
      <div class="d-flex justify-content-end">
        <button id="cancelReportBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
        <button id="submitReportBtn" type="button" class="btn btn-sm btn-danger">Submit</button>
      </div>
    </div>
  </div>
</div>

<!-- Post Toast -->
<div id="PostToastWrapper">
  <div id="PostToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <form id="form">
      <div class="toast-body">
        <h6>Report Post</h6>
        <textarea id="postReasonInput" class="form-control mb-2" placeholder="Reason..."></textarea>
        <div class="d-flex justify-content-end">
          <button id="cancelPostBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
          <button id="submitPostBtn" type="button" class="btn btn-sm btn-danger">Submit</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!--Feeling Toast-->
<div id="FeelingToastWrapper">
    <div id="FeelingToast" class="toast align-items-center text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body">
         <div id="feelingGrid" class="grid-container">
          
          <div class="feeling-option">ğŸ˜Š happy</div>
          <div class="feeling-option">ğŸ˜¢ sad</div>
          <div class="feeling-option">ğŸ˜¡ angry</div>
          <div class="feeling-option">ğŸ˜‡ blissful</div>
          <div class="feeling-option">ğŸ˜ in love</div>
          <div class="feeling-option">ğŸ˜œ silly</div>
          <div class="feeling-option">ğŸ˜ cool</div>
          <div class="feeling-option">ğŸ˜Œ relaxed</div>
          <div class="feeling-option">ğŸ˜´ sleepy</div>
          <div class="feeling-option">ğŸ¤’ sick</div>
          <div class="feeling-option">ğŸ¤— loved</div>
          <div class="feeling-option">ğŸ˜± shocked</div>
          <div class="feeling-option">ğŸ˜ disappointed</div>
          <div class="feeling-option">ğŸ˜¤ frustrated</div>
          <div class="feeling-option">ğŸ¤© excited</div>
          <div class="feeling-option">ğŸ¥³ festive</div>
          <div class="feeling-option">ğŸ˜” down</div>
          <div class="feeling-option">ğŸ˜• confused</div>
          <div class="feeling-option">ğŸ˜¬ nervous</div>
          <div class="feeling-option">ğŸ˜‡ blessed</div>
          <div class="feeling-option">ğŸ™ thankful</div>
          <div class="feeling-option">ğŸ˜… amused</div>
          <div class="feeling-option">ğŸ¤“ curious</div>
          <div class="feeling-option">ğŸ˜© overwhelmed</div>
          <div class="feeling-option">ğŸ˜† fantastic</div>
          <div class="feeling-option">ğŸ˜¶ meh</div>
          <div class="feeling-option">ğŸ˜¢ heartbroken</div>
          <div class="feeling-option">ğŸ˜¤ determined</div>
          <div class="feeling-option">ğŸ˜‡ inspired</div>
          <div class="feeling-option">ğŸ˜µâ€ğŸ’« crazy</div>
          <div class="feeling-option">ğŸ˜ OK</div>
          <div class="feeling-option">ğŸ˜ƒ proud</div>
          <div class="feeling-option">ğŸ˜‹ satisfied</div>
          <div class="feeling-option">ğŸ˜³ embarrassed</div>
          <div class="feeling-option">ğŸ¤” thoughtful</div>
          <div class="feeling-option">ğŸ˜ lovely</div>
          <div class="feeling-option">ğŸ˜– miserable</div>
          <div class="feeling-option">ğŸ˜‡ grateful</div>
        </div>
          <div class="d-flex justify-content-end mt-2">
            <button id="cancelFeelingBtn" type="button" class="btn btn-sm btn-secondary me-2">Cancel</button>
          </div>
        </div>
    </div>
  </div>


<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
// --- Feeling Dictionary (global) ---
const feelingMap = {
  happy: "ğŸ˜Š happy",
  sad: "ğŸ˜¢ sad",
  angry: "ğŸ˜¡ angry",
  blissful: "ğŸ˜‡ blissful",
  "in love": "ğŸ˜ in love",
  silly: "ğŸ˜œ silly",
  cool: "ğŸ˜ cool",
  relaxed: "ğŸ˜Œ relaxed",
  sleepy: "ğŸ˜´ sleepy",
  sick: "ğŸ¤’ sick",
  loved: "ğŸ¤— loved",
  shocked: "ğŸ˜± shocked",
  disappointed: "ğŸ˜ disappointed",
  frustrated: "ğŸ˜¤ frustrated",
  excited: "ğŸ¤© excited",
  festive: "ğŸ¥³ festive",
  down: "ğŸ˜” down",
  confused: "ğŸ˜• confused",
  nervous: "ğŸ˜¬ nervous",
  blessed: "ğŸ˜‡ blessed",
  thankful: "ğŸ™ thankful",
  amused: "ğŸ˜… amused",
  curious: "ğŸ¤“ curious",
  overwhelmed: "ğŸ˜© overwhelmed",
  fantastic: "ğŸ˜† fantastic",
  meh: "ğŸ˜¶ meh",
  heartbroken: "ğŸ˜¢ heartbroken",
  determined: "ğŸ˜¤ determined",
  inspired: "ğŸ˜‡ inspired",
  crazy: "ğŸ˜µâ€ğŸ’« crazy",
  ok: "ğŸ˜ OK",
  proud: "ğŸ˜ƒ proud",
  satisfied: "ğŸ˜‹ satisfied",
  embarrassed: "ğŸ˜³ embarrassed",
  thoughtful: "ğŸ¤” thoughtful",
  lovely: "ğŸ˜ lovely",
  miserable: "ğŸ˜– miserable",
  grateful: "ğŸ˜‡ grateful"
};

const API_URL = "https://thebooksourcings.onrender.com";

 function parseJwt (token) {
  try {
    return JSON.parse(atob(token.split('.')[1]));
  } catch (e) {
    return null;
  }
}

const token = localStorage.getItem("token");
let userMemberQid = null;
let username = null;

if (token) {
  const decoded = parseJwt(token);
  userMemberQid = decoded?.memberQid || null;
  username = decoded?.username || null;
}

const usernameFrom = document.querySelector(".usernameFrom");

if (username) {
  usernameFrom.textContent = username;
}

const socket = io(API_URL, { auth: { token } });

// ====== DECLARATIONS ======
// Edit
let editingMessageId = null;
const editToast = new bootstrap.Toast(document.getElementById("editToast"), { autohide: false });
const editInput = document.getElementById("editMessageInput");

// Delete
let deletingMessageId = null;
const deleteToast = new bootstrap.Toast(document.getElementById("deleteToast"), { autohide: false });

// Report
let reportingTargetId = null;
const reportToast = new bootstrap.Toast(document.getElementById("reportToast"), { autohide: false });
const reportReasonInput = document.getElementById("reportReasonInput");

// ====== SOCKET LISTENERS ======
socket.on("connect", () => console.log("Connected:", socket.id));

socket.on("receive-message", (msg) => {
  if (!msg.createFormNow) msg.createFormNow = "just now";
  msg.feeling = feelingMap[msg.feeling] || msg.feeling;
  displayMessage(msg);
});

socket.on("message-updated", ({ message_id, newText }) => {
  const div = document.querySelector(`div[data-id='${message_id}']`);
  if (div) div.querySelector(".msg-text").textContent = newText;
});

socket.on("message-deleted", ({ message_id }) => {
  const div = document.querySelector(`div[data-id='${message_id}']`);
  if (div) div.remove();
});

// ====== LOAD ALL MESSAGES ======
async function loadMessages() {
  try {
    const res = await fetch(`${API_URL}/api/community/display`);
    if (!res.ok) throw new Error("Failed to fetch messages");
    const msgs = await res.json();
    msgs.forEach(displayMessage);
  } catch (err) {
    console.error("Error loading messages:", err);
  }
}
loadMessages();

// ====== SEND MESSAGE ======
const form = document.getElementById("form");
const messageInput = document.getElementById("message-input");

const mediaInput = document.getElementById("mediaInput");
const mediaPreview = document.getElementById("media-preview");

let selectedFile = null;

    // feeling toast logic
    const feelingLabel = document.getElementById('feelingLabel');
    const displayFeeling = document.getElementById("displayFeeling");
    const feelingInput = document.getElementById("feelingValue");
 
    const FeelingToast = new bootstrap.Toast(document.getElementById("FeelingToast"), { autohide: false });
    const feelingOptions = document.querySelectorAll('.feeling-option');

    // Show toast on label click
    feelingLabel.addEventListener('click', () => {
      FeelingToast.show();
    });

    // Handle click on each feeling option
    feelingOptions.forEach(option => {
      option.addEventListener("click", () => {
        const text = option.textContent;
        displayFeeling.textContent = text;

        // Save selected feeling (strip emoji if needed)
        feelingInput.value = text.replace(/^[^\w]+/, "").trim().toLowerCase();

        FeelingToast.hide();
      });
    });
    


// Show preview when user selects a file
mediaInput.addEventListener("change", () => {
  selectedFile = mediaInput.files[0];
  mediaPreview.innerHTML = ""; // clear previous preview

  if (!selectedFile) return;

  if (selectedFile.type.startsWith("image/")) {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(selectedFile);
    img.style.maxWidth = "200px";
    img.style.marginTop = "5px";
    mediaPreview.appendChild(img);
  } else if (selectedFile.type.startsWith("video/")) {
    const video = document.createElement("video");
    video.src = URL.createObjectURL(selectedFile);
    video.controls = true;
    video.style.maxWidth = "200px";
    video.style.marginTop = "5px";
    mediaPreview.appendChild(video);
  }
});

// Send message (text + optional media)
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const text = messageInput.value.trim();
  const feeling = feelingInput.value; // <-- comes from hidden input
  if (!text && !selectedFile && !feeling) return; // must have text or media

  try {
    const formData = new FormData();
    formData.append("message", text);
    formData.append("feeling", feeling);
    if (selectedFile) formData.append("media", selectedFile);

    const res = await fetch(`${API_URL}/api/community/send`, {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}` },
      body: formData
    });

    if (!res.ok) throw new Error("Failed to send message");

    const savedMsg = await res.json();
    savedMsg.createFormNow = "just now"; // instant display
    displayMessage(savedMsg);
    socket.emit("send-message", savedMsg);

    // Reset form
    messageInput.value = "";
    mediaInput.value = "";
    mediaPreview.innerHTML = "";
    feelingInput.value = "";
    selectedFile = null;
    displayFeeling.textContent = "";
    postToast.hide();
  } catch (err) {
    console.error(err);
  }
});


// ====== DISPLAY MESSAGE ======
function displayMessage(msg) {
  const div = document.createElement("div");
  div.className = "post";
  div.dataset.id = msg.message_id;

  // --- POST HEADER ---
  const header = document.createElement("div");
  header.className = "post-header";

  const profileImg = document.createElement("img");
  profileImg.src = msg.profile_url || "../../assets/img/pf.jpg"; // placeholder
  profileImg.alt = "user-profile";
  profileImg.className = "userProfile";

  // Wrap profile image in link
  const profileLink = document.createElement("a");
  profileLink.href = `aboutUser?memberId=${msg.memberQid}`;
  profileLink.appendChild(profileImg);

  // Username link
  

  const headerRight = document.createElement("div");
  headerRight.className = "post-header-child-right";

  const headerRightTop = document.createElement("div");
  headerRightTop.className = "post-header-child-right-top";

  const headerRightBottom = document.createElement("div");
  headerRightBottom.className = "post-header-child-right-bottom";

  headerRight.appendChild(headerRightTop);
  headerRight.appendChild(headerRightBottom);

  const usernameLink = document.createElement("a");
  usernameLink.href = `aboutUser?memberId=${msg.memberQid}`;
  usernameLink.textContent = msg.username || "Unknown";
  usernameLink.className = "username";
  headerRightTop.appendChild(usernameLink);

  if (msg.feeling) {
    const feeling = document.createElement("a");
    feeling.className = "feelingDisplay";
    feeling.textContent = "is feeling " + feelingMap[msg.feeling] || msg.feeling || "";
    headerRightTop.appendChild(feeling);
  }
  const postAt = document.createElement("p");
  postAt.className = "postAt";
  postAt.textContent = msg.createFormNow || "just now";
  headerRightBottom.appendChild(postAt);

  

  // Dropdown menu
  const dropdownWrapper = document.createElement("div");
  dropdownWrapper.className = "dropdown absolute-top-right";

  const ellipsisBtn = document.createElement("i");
  ellipsisBtn.className = "fa-solid fa-ellipsis";
  ellipsisBtn.setAttribute("data-bs-toggle", "dropdown");
  ellipsisBtn.style.cursor = "pointer";

  const dropdownMenu = document.createElement("ul");
  dropdownMenu.className = "dropdown-menu";
  if (msg.memberQid === userMemberQid) {
    dropdownMenu.innerHTML = `
      <li><a class="dropdown-item edit-option" href="#">Edit</a></li>
      <li><a class="dropdown-item delete-option" href="#">Delete</a></li>
      <li><a class="dropdown-item report-option" href="#">Report</a></li>
    `;
  } else {
    dropdownMenu.innerHTML = `
      <li><a class="dropdown-item report-option" href="#">Report</a></li>
    `;
  }
  dropdownWrapper.appendChild(ellipsisBtn);
  dropdownWrapper.appendChild(dropdownMenu);

  header.appendChild(profileLink);
  header.appendChild(headerRight);
  header.appendChild(dropdownWrapper);

  // --- POST BODY ---
  const body = document.createElement("div");
  body.className = "post-body";

  // Post text with truncation
  if (msg.message) {
    const textP = document.createElement("p");
    textP.className = "post-text";

    if (msg.message.length > 250) {
      const shortText = msg.message.slice(0, 250);
      textP.textContent = shortText + "... ";

      const seeMore = document.createElement("a");
      seeMore.href = "#";
      seeMore.textContent = "see more";
      seeMore.addEventListener("click", (e) => {
        e.preventDefault();
        textP.textContent = msg.message; // show full text
      });

      textP.appendChild(seeMore);
    } else {
      textP.textContent = msg.message;
    }

    body.appendChild(textP);
  }

  // Media
  // Media
if (msg.media_url && msg.media_type) {
  const mediaWrapper = document.createElement("div");
  mediaWrapper.className = "post-thumbnail";

  // Only apply blur background for images
  if (msg.media_type === "image" && !msg.media_url.startsWith("blob:")) {
    mediaWrapper.style.setProperty("--bg-url", `url(${msg.media_url})`);
  }

  const mediaEl = document.createElement(msg.media_type === "image" ? "img" : "video");
  mediaEl.className = "post-thumbnail-img";
  mediaEl.src = msg.media_url;

  if (msg.media_type === "video") mediaEl.controls = true;

  mediaWrapper.appendChild(mediaEl);
  body.appendChild(mediaWrapper);
}


  // Like / comment / repost counts
  const counts = document.createElement("div");
  counts.className = "post-media-count";
  counts.innerHTML = `
    <div>
      <p><span class="post-like-count">${msg.like_count || 0}</span> Likes</p>
    </div>
    <div class="post-media-count-child-right">
      <p><span class="post-comment-count">${msg.comment_count || 0}</span> comments</p>
      <p><span class="post-repost-count">${msg.repost_count || 0}</span> reposts</p>
    </div>
  `;
  body.appendChild(counts);

  // --- BUTTONS ---
  const btnRow = document.createElement("div");
  btnRow.className = "post-media-button";

  // Like btn
  const likeBtn = document.createElement("button");
  likeBtn.className = "likeBtn media-btn";
  likeBtn.dataset.id = msg.message_id;
  likeBtn.innerHTML = `<i class="fa-solid fa-heart"></i> <span>Like</span>`;

  // Comment btn
  const commentBtn = document.createElement("button");
  commentBtn.className = "commentBtn media-btn";
  commentBtn.dataset.id = msg.message_id;
  commentBtn.innerHTML = `<i class="fa-solid fa-comment"></i> <span>Comment</span>`;
  commentBtn.onclick = () => {
    window.location.href = `aboutPost.html?post_id=${msg.message_id}`;
  };

  // Repost btn
  const repostBtn = document.createElement("button");
  repostBtn.className = "repostBtn media-btn";
  repostBtn.dataset.id = msg.message_id;
  repostBtn.innerHTML = `<i class="fa-solid fa-share-from-square"></i> <span>Repost</span>`;

  btnRow.appendChild(likeBtn);
  btnRow.appendChild(commentBtn);
  btnRow.appendChild(repostBtn);

  body.appendChild(btnRow);

  // Append together
  div.appendChild(header);
  div.appendChild(body);
  document.getElementById("message-container").prepend(div);

  // === Attach like toggle logic ===
  const likeIcon = likeBtn.querySelector("i");
  const likeCount = counts.querySelector(".post-like-count");
  loadLikeInfoForMessage(msg.message_id, likeIcon, likeCount);
  likeBtn.onclick = async () => {
    await toggleLikeActivityForMessage(msg.message_id, likeIcon, likeCount);
  };

  // === Dropdown click handlers ===
  dropdownMenu.querySelectorAll("a").forEach((item) => {
    item.addEventListener("click", (e) => {
      e.preventDefault();
      if (item.classList.contains("edit-option")) {
        editingMessageId = msg.message_id;
        editInput.value = msg.message;
        editToast.show();
      } else if (item.classList.contains("delete-option")) {
        deletingMessageId = msg.message_id;
        deleteToast.show();
      } else if (item.classList.contains("report-option")) {
        reportingTargetId = msg.message_id;
        reportToast.show();
      }
    });
  });
}


// ====== LIKE FUNCTIONS ======
async function loadLikeInfoForMessage(messageId, likeIcon, likeCount) {
  try {
    const res = await fetch(`${API_URL}/api/communityPostLike/status/${messageId}`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (!res.ok) throw new Error("Failed to fetch like status");

    const data = await res.json();
    likeCount.textContent = data.post.like_count;
    likeIcon.style.color = data.userStatus.liked ? "red" : "gray";
  } catch (err) {
    console.error(err);
  }
}

async function toggleLikeActivityForMessage(messageId, likeIcon, likeCount) {
  try {
    const res = await fetch(`${API_URL}/api/communityPostLike/like/${messageId}`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });
    if (!res.ok) throw new Error("Failed to toggle like");

    const data = await res.json();
    likeIcon.style.color = data.liked ? "red" : "gray";
    await loadLikeInfoForMessage(messageId, likeIcon, likeCount);
  } catch (err) {
    console.error(err);
  }
}

// ====== EDIT  Fetch======
document.getElementById("saveEditBtn").onclick = async () => {
  const newText = editInput.value.trim();
  if (!newText || !editingMessageId) return;
  try {
    await fetch(`${API_URL}/api/community/edit`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ message_id: editingMessageId, newText })
    });
    socket.emit("edit-message", { message_id: editingMessageId, newText });
    editToast.hide();
    editingMessageId = null;
  } catch (err) {
    console.error(err);
  }
};

// ====== DELETE Fetch ======
document.getElementById("confirmDeleteBtn").onclick = async () => {
  if (!deletingMessageId) return;
  try {
    await fetch(`${API_URL}/api/community/delete`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ message_id: deletingMessageId })
    });
    socket.emit("delete-message", { message_id: deletingMessageId });
    deleteToast.hide();
    deletingMessageId = null;
  } catch (err) {
    console.error(err);
  }
};

// ====== REPORT Fetch======
document.getElementById("submitReportBtn").onclick = async () => {
  const reasonTxt = reportReasonInput.value.trim();
  if (!reasonTxt || !reportingTargetId) return;

  try {
    const res = await fetch(`${API_URL}/api/community/report`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        reasonTxt,
        reportTypeFrom_id: reportingTargetId
      })
    });

    if (!res.ok) throw new Error("Failed to submit report");

    const data = await res.json();
    alert(data.message);
    reportToast.hide();
    reportingTargetId = null;
    reportReasonInput.value = "";
  } catch (err) {
    console.error("Report error:", err);
  }
};

 // Post toast
  const postToast = new bootstrap.Toast(document.getElementById("PostToast"), { autohide: false });
  const searchBtn = document.getElementById("searchButton");

  searchBtn.addEventListener("click", () => {
    postToast.show();
  });

  document.getElementById("cancelPostBtn").onclick = () => {
    postToast.hide();
    messageInput.value = "";
    mediaInput.value = "";
    mediaPreview.innerHTML = "";
    feelingInput.value = "";
    selectedFile = null;
    displayFeeling.textContent = "";
  };

  

// ====== CANCEL BUTTONS ======


// cancel edit btn
document.getElementById("cancelEditBtn").onclick = () => {
  editingMessageId = null;
  editToast.hide();
};


// cancel delete btn
document.getElementById("cancelDeleteBtn").onclick = () => {
  deletingMessageId = null;
  deleteToast.hide();
};

// cancel report btn
document.getElementById("cancelReportBtn").onclick = () => {
  reportingTargetId = null;
  reportReasonInput.value = "";
  reportToast.hide();
};



    // Cancel button
    document.getElementById("cancelFeelingBtn").onclick = () => {
      FeelingToast.hide();
      displayFeeling.textContent = "";
      feelingInput.value = "";
    };
</script>
</body>
</html>




async function loadLikeInfo(messageId) {
  try {
    const res = await fetch(`https://thebooksourcings.onrender.com/api/communityPostLike/status/${messageId}`, {
      headers: {
        "Authorization": `Bearer ${localStorage.getItem("token")}`
      }
    });
    if (!res.ok) throw new Error("Failed to fetch follow status");

    const data = await res.json();

    likeCount.textContent = data.post.like_count;
    LikeIcon.style.color = data.userStatus.liked ? "gold" : "black";
  } catch (err) {
    console.error(err);
  }
}

async function toggleLikeActivity(messageId) {
  try {
    const res = await fetch(`https://thebooksourcings.onrender.com/api/communityPostLike/like/${messageId}`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${localStorage.getItem("token")}`,
        "Content-Type": "application/json"
      }
    });
    if (!res.ok) throw new Error(`Failed to toggle follow`);

    const data = await res.json();

    // Update UI with returned state
    likeIcon.style.color = data.liked ? "gold" : "black";

    // Safer: re-fetch updated count instead of manual increment
    await loadChannelInfo(memberQid);

  } catch (err) {
    console.error(err);
  }
}



/// index.js
// Import Express & Middleware
const { instrument } = require("@socket.io/admin-ui")
const express = require('express');
const cors = require('cors');
const path = require('path');
const http = require('http'); 
const db = require("./config/db"); // your MySQL pool/connection
const app = express();
app.use(cors(
    {
        origin: ["https://admin.socket.io", "https://thebooksourcings.onrender.com"],
        credentials: true
    }
));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// âœ… Serve static files from the src/public folder
app.use(express.static(path.join(__dirname, 'public')));

// âœ… Handle root path and send index.html from src/public
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});


// Import Routes
const { TheBookSourcingUser } = require('./routes/userRoute');
const trendingRoutes = require('./routes/book/trending/trendingRoutes'); 
const aboutBookInfoRoute = require('./routes/book/about/allAboutRoute');
const similarBookRoute = require('./routes/book/about/simiarBookRoute');
const bookByAuthorRoute = require('./routes/book/about/bookByAuthorsRoute');
const aboutAuthorInfo = require('./routes/book/about/allAboutAuthorInfoRoute');
const aboutAuthorDetails = require('./routes/book/about/aboutAuthorDetailsRoute');
const similarAuthorDetail = require('./routes/book/about/similarAuthorRoutes');
const notableWork = require('./routes/book/about/notableWorkRoutes');
const {bookRoutes} = require('./routes/book/uploadBookRoute/upload');
const getBookByQidRoute = require('./routes/book/uploadBookRoute/paramQueryRoute');
const getMyBooksRoutes = require('./routes/book/uploadBookRoute/queryRoutes');
const displayUserUploadBookRoute = require('./routes/book/displayUserBook/displayBookRoutes');
const viewRoute = require('./routes/book/bookActivity/viewRoute');
const RDSroute = require('./routes/book/bookActivity/RDSroute');
const LAF = require('./routes/book/userBookStatus/LAFroutes');
const followRoute = require('./routes/book/userFollowStatus/followRoute');
const communityRoutes = require('./routes/chat/community/communityRoutes');
const communityLikeRoute =  require('./routes/chat/community/communityLike/communityPostLikeRoutes')
const verifySocketToken  = require('./middleware/verifySocketToken');


// report
const reportCommunityRoute = require('./routes/chat/community/reportPAC/reportRoutes')

// Initialize Routes
TheBookSourcingUser(app);
bookRoutes(app);
app.use('/api/trending', trendingRoutes); // âœ… mount trending API
app.use('/api/aboutBook', aboutBookInfoRoute);
app.use('/api/similar', similarBookRoute);
app.use('/api/bookByAuthor', bookByAuthorRoute);
app.use('/api/aboutAuthor', aboutAuthorInfo);
app.use('/api/author', aboutAuthorDetails);
app.use('/api/authors/similar', similarAuthorDetail);
app.use('/api/authors/notableWork', notableWork);
app.use('/api/getBookByQid', getBookByQidRoute);
app.use('/api/getMyBooks', getMyBooksRoutes);
app.use('/api/books', displayUserUploadBookRoute);
app.use('/api/books/view', viewRoute);
app.use('/api/books', RDSroute);
app.use('/api/LAFbook', LAF);
app.use('/api', followRoute);
app.use("/api/community", communityRoutes);
app.use('/api/communityPostLike', communityLikeRoute);


// report 
app.use("/api/community", reportCommunityRoute)



// Create HTTP server from Express app
const server = http.createServer(app);

// Attach Socket.IO to the same server
const { Server } = require('socket.io');
const io = new Server(server, {
    cors: {
    origin: ["https://admin.socket.io", "https://thebooksourcings.onrender.com"],
    credentials: true
    }
});

io.use(verifySocketToken); 
io.on("connection", (socket) => {
  console.log("Socket connected:", socket.user?.memberQid || "Guest");

  socket.on("send-message", (data) => {
    if (!socket.user) return; // guest cannot send
    socket.broadcast.emit("receive-message", { ...data, memberQid: socket.user.memberQid });
  });

  socket.on("edit-message", (data) => {
    if (!socket.user) return;
    io.emit("message-updated", data);
  });

  socket.on("delete-message", (data) => {
    if (!socket.user) return;
    io.emit("message-deleted", data);
  });
});



instrument(io, {
  namespaceName: "/admin",
  auth: false
});


// Start Server
const port = 3000;
server.listen(port, () => {
    console.log(`ğŸš€ Server running at http://localhost:${port}`);
});




function displayMessage(msg) {
  const div = document.createElement("div");
  div.dataset.id = msg.message_id;
  div.innerHTML = `
    <span class="msg-text">${msg.message}</span>
    <span class='createdAt'>${msg.createFormNow}</span>
  `;


  // Render media if exists
  if (msg.media_url && msg.media_type) {
    const mediaEl = document.createElement(msg.media_type === "image" ? "img" : "video");
    mediaEl.src = msg.media_url;
    if (msg.media_type === "video") mediaEl.controls = true;
    mediaEl.style.maxWidth = "200px";
    mediaEl.style.marginTop = "5px";
    div.appendChild(mediaEl);
  }
  // --- LIKE SECTION ---
  const likeSection = document.createElement("div");
  likeSection.style.marginTop = "5px";

  const likeIcon = document.createElement("i");
  likeIcon.className = "fa fa-heart";
  likeIcon.style.cursor = "pointer";
  likeIcon.style.marginRight = "5px";
  likeIcon.style.color = "black";

  const likeCount = document.createElement("span");
  likeCount.textContent = msg.like_count || 0;

  // Load initial like status
  loadLikeInfoForMessage(msg.message_id, likeIcon, likeCount);

  // Toggle like
  likeIcon.onclick = async () => {
    await toggleLikeActivityForMessage(msg.message_id, likeIcon, likeCount);
  };

  likeSection.appendChild(likeIcon);
  likeSection.appendChild(likeCount);
  div.appendChild(likeSection);

  // --- DROPDOWN MENU ---
  const dropdownWrapper = document.createElement("div");
  dropdownWrapper.className = "dropdown";
  dropdownWrapper.style.display = "inline-block";
  dropdownWrapper.style.float = "right";

  const ellipsisBtn = document.createElement("i");
  ellipsisBtn.className = "fa-solid fa-ellipsis";
  ellipsisBtn.setAttribute("data-bs-toggle", "dropdown");
  ellipsisBtn.style.cursor = "pointer";

  const dropdownMenu = document.createElement("ul");
  dropdownMenu.className = "dropdown-menu";

  if (msg.memberQid === userMemberQid) {
    dropdownMenu.innerHTML = `
      <li><a class="dropdown-item edit-option" href="#">Edit</a></li>
      <li><a class="dropdown-item delete-option" href="#">Delete</a></li>
      <li><a class="dropdown-item report-option" href="#">Report</a></li>
    `;
  } else {
    dropdownMenu.innerHTML = `
      <li><a class="dropdown-item report-option" href="#">Report</a></li>
    `;
  }

  dropdownWrapper.appendChild(ellipsisBtn);
  dropdownWrapper.appendChild(dropdownMenu);
  div.appendChild(dropdownWrapper);

  // Dropdown click handlers
  dropdownMenu.querySelectorAll("a").forEach((item) => {
    item.addEventListener("click", (e) => {
      e.preventDefault();
      if (item.classList.contains("edit-option")) {
        editingMessageId = msg.message_id;
        editInput.value = msg.message;
        editToast.show();
      } else if (item.classList.contains("delete-option")) {
        deletingMessageId = msg.message_id;
        deleteToast.show();
      } else if (item.classList.contains("report-option")) {
        reportingTargetId = msg.message_id;
        reportToast.show();
      }
    });
  });

  document.getElementById("message-container").appendChild(div);
}